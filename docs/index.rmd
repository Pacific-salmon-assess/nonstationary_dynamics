---
title: "Non-stationary model selection"
author: "D. Greenberg"
date: "11/21/2022"
output:
  html_document:
    collapsed: no
    fig_caption: yes
    highlight: espresso
    number_sections: yes
    smooth_scroll: yes
    theme: sandstone
    toc: yes
    toc_float: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(warning = FALSE)
```

```{r load,  include=FALSE}
library(here);library(ggplot2);library(dplyr);library(cowplot);library(formattable)
source(here('code','samEst code','stan_functions.R'))
source(here('code','samEst code','lfo_stan_functions.R'))
source(here('code','samEst code','util_functions.R'))
options(dplyr.summarise.inform = FALSE)
stock_dat<- read.csv(here('data','filtered datasets','salmon_productivity_compilation_aug2022.csv'))
stock_info<- read.csv(here('data','filtered datasets','all_stocks_info_aug2022.csv'))
#Remove stocks with less than 15 years of recruitment data
stock_info_filtered=subset(stock_info,n.years>=18) #242 stocks
stock_info_filtered$stock.name=gsub('/','_',stock_info_filtered$stock.name)
stock_info_filtered$stock.name=gsub('&','and',stock_info_filtered$stock.name)


stock_dat2=subset(stock_dat,stock.id %in% stock_info_filtered$stock.id)
length(unique(stock_dat2$stock.id)) #242

stock_dat2$logR_S=log(stock_dat2$recruits/stock_dat2$spawners)

```

# Overview
The goal of this document is to examine model performance of various stationary and non-stationary spawner-recruitment model forms for 242 Pacific salmon spawner-recruit time-series.

We fit three classes of spawner-recruitment models with 8 models in total:

+ Stationary models
    1. Simple Ricker (model **1**)
    2. AR(1) Ricker (model **2**)
+ Dynamic linear models
    3. Dynamic $\alpha$ (model **3**)
    4. Dynamic $\beta$ (model **4**)
    5. Dynamic $\alpha$ and $\beta$ (model **5**)
+ Regime shift (Hidden Markov) models
    6. $\alpha$ Regime (model **6**)
    7. $\beta$ Regime (model **7**)
    8. $\alpha$ and $\beta$ Regime (model **8**) 

Choice of model selection criteria and data to include are important components. We will examine several to see how it changes our ultimate inferences.

# Stan LFO-CV (2/3n)
Out-of-sample performance is a key selection metric if we value predictive accuracy. Since spawner-recruitment data are time-series, we can establish a scenario where we attempt to predict future data using models built on historical observations through cross-validation. Starting with a minimum observation window, which we set here as 2/3rd of the total time-series, we iteratively build models for each remaining year of the data-series and determine how close model predictions are to each out-of-sample observation by calculating the log predictive density. We fit these models in Stan, and 

In turn, we convert these log predictive densities across the model posterior into model weights. Based on the model with the highest weight, the counts of populations best explained by each of the 8 models is:

## Top models - Stan LFO (2/3n)
```{r, model weights lfo}
lfo=read.csv(here('outputs','ms_rmd','lfo_table.csv'))
lfo$lat=round(lfo$lat,2)
lfo$lon=round(lfo$lon,2)
table(lfo$best_mod)
round(table(lfo$best_mod)/nrow(lfo),3)
```
```{r, model weights by pop, warning = FALSE}

sp = lfo %>% group_by(best_mod,species) %>% summarize(n=n())

ggplot(sp, aes(fill=species, y=n, x=factor(best_mod)))+
  scale_fill_manual(values=c("darkgray", "darkgreen", "darkblue","darksalmon","darkred"))+ 
  ggtitle("Top-ranked model (2/3n LFO)")+
  geom_bar(position="stack", stat="identity") + 
  theme_minimal() +
  xlab('')+
  ylab('No. populations')+ 
  theme(text=element_text(size=14),axis.text=element_text(size=14),axis.line = element_line(colour = "black", 
                      size = 1, linetype = "solid"),plot.title = element_text(size=14))
```

## State - Stan LFO (2/3n)

Top models broken down by state:

```{r, broken down by state }
sp_state = lfo %>% group_by(state,best_mod,species) %>% summarize(n=n())
sp_ak=subset(sp_state,state=='AK')
sp_bc=subset(sp_state,state=='BC')
sp_wa=subset(sp_state,state=='WA')
sp_or=subset(sp_state,state=='OR')

or_pl=ggplot(sp_or, aes(fill=species, y=n, x=factor(best_mod)))+
  scale_fill_manual(values=c("darkgray","darkblue"))+ 
  ggtitle("Oregon")+
  geom_bar(position="stack", stat="identity") + 
  theme_minimal() +
  xlab('')+
  ylab('No. populations')+ 
  theme(text=element_text(size=12),axis.title=element_text(size=12,face="bold"),axis.line = element_line(colour = "black", 
                      size = 1, linetype = "solid"),plot.title = element_text(size=14))

wa_pl=ggplot(sp_wa, aes(fill=species, y=n, x=factor(best_mod)))+
  scale_fill_manual(values=c("darkgray", "darkgreen","darksalmon","darkred"))+
  ggtitle("Washington")+
  geom_bar(position="stack", stat="identity") + 
  theme_minimal() +
  xlim(factor(seq(1:8)))+
  xlab('')+
  ylab('No. populations')+ 
  theme(text=element_text(size=12),axis.title=element_text(size=12,face="bold"),axis.line = element_line(colour = "black", 
                      size = 1, linetype = "solid"),plot.title = element_text(size=14))

bc_pl=ggplot(sp_bc, aes(fill=species, y=n, x=factor(best_mod)))+
  scale_fill_manual(values=c("darkgray", "darkgreen", "darkblue","darksalmon","darkred"))+
  ggtitle("British Columbia")+
  geom_bar(position="stack", stat="identity") + 
  theme_minimal() +
  xlab('')+
  ylab('No. populations')+ 
  theme(text=element_text(size=12), axis.title=element_text(size=12,face="bold"),axis.line = element_line(colour = "black", 
                      size = 1, linetype = "solid"),plot.title = element_text(size=14))

ak_pl=ggplot(sp_ak, aes(fill=species, y=n, x=factor(best_mod)))+
  scale_fill_manual(values=c("darkgray", "darkgreen", "darkblue","darksalmon","darkred"))+
  ggtitle("Alaska")+
  geom_bar(position="stack", stat="identity") + 
  theme_minimal() +
  xlab('')+
  ylab('No. populations')+ 
  theme(text=element_text(size=12), axis.title=element_text(size=12,face="bold"),axis.line = element_line(colour = "black", 
                      size = 1, linetype = "solid"),plot.title = element_text(size=14))


pg1=plot_grid(or_pl+ theme(legend.position="none"),
          wa_pl+ theme(legend.position="none"),
          bc_pl+ theme(legend.position="none"),
          ak_pl+ theme(legend.position="none"),
          ncol=2,nrow=2,labels=c("A","B","C","D"))

legend= get_legend(bc_pl)

plot_grid(pg1,legend,rel_widths = c(3,.5))

```


## Ocean basins - Stan LFO (2/3n)

Top models broken down by ocean basin:

```{r, broken down by state and ocean basin}
sp_ocean = lfo %>% group_by(ocean.basin,best_mod,species) %>% summarize(n=n())
sp_BS=subset(sp_ocean,ocean.basin=='BS')
sp_GOA=subset(sp_ocean,ocean.basin=='GOA')
sp_WC=subset(sp_ocean,ocean.basin=='WC')

WC_pl=ggplot(sp_WC, aes(fill=species, y=n, x=factor(best_mod)))+
  scale_fill_manual(values=c("darkgray", "darkgreen", "darkblue","darksalmon","darkred"))+ 
  ggtitle("West Coast")+
  geom_bar(position="stack", stat="identity") + 
  theme_minimal() +
  xlab('')+
  ylab('No. populations')+ 
  theme(text=element_text(size=12),axis.title=element_text(size=12,face="bold"),axis.line = element_line(colour = "black", 
                      size = 1, linetype = "solid"),plot.title = element_text(size=14))

GOA_pl=ggplot(sp_GOA, aes(fill=species, y=n, x=factor(best_mod)))+
  scale_fill_manual(values=c("darkgray", "darkgreen", "darkblue","darksalmon","darkred"))+
  ggtitle("Gulf of Alaska")+
  geom_bar(position="stack", stat="identity") + 
  theme_minimal() +
  xlim(factor(seq(1:8)))+
  xlab('')+
  ylab('No. populations')+ 
  theme(text=element_text(size=12),axis.title=element_text(size=12,face="bold"),axis.line = element_line(colour = "black", 
                      size = 1, linetype = "solid"),plot.title = element_text(size=14))

BS_pl=ggplot(sp_BS, aes(fill=species, y=n, x=factor(best_mod)))+
  scale_fill_manual(values=c("darkgray", "darkgreen", "darksalmon","darkred"))+
  ggtitle("Bering Sea")+
  geom_bar(position="stack", stat="identity") + 
  theme_minimal() +
   xlim(factor(seq(1:8)))+
  xlab('')+
  ylab('No. populations')+ 
  theme(text=element_text(size=12), axis.title=element_text(size=12,face="bold"),axis.line = element_line(colour = "black", 
                      size = 1, linetype = "solid"),plot.title = element_text(size=14))

legend= get_legend(BS_pl)

plot_grid(WC_pl+ theme(legend.position="none"),
          GOA_pl+ theme(legend.position="none"),
          BS_pl+ theme(legend.position="none"),
          legend,
          ncol=2,nrow=2,labels=c("A","B","C"))

#legend= get_legend(WC_pl)

#plot_grid(pg1,legend,rel_widths = c(3,.5))



```

##Time-series length

```{r, by time-series length}
lfo$ts_length_bin=cut(
 stock_info_filtered$n.years,
  breaks = quantile(stock_info_filtered$n.years, seq(0,1,by=0.2)),
  labels = c('18-26','27-35','35-45','46-50','50+'))

lfo_ts = lfo %>% group_by(ts_length_bin,best_mod,species) %>% summarize(n=n())

sp_18=subset(lfo_ts,ts_length_bin=='18-26')
sp_27=subset(lfo_ts,ts_length_bin=='27-35')
sp_35=subset(lfo_ts,ts_length_bin=='35-45')
sp_45=subset(lfo_ts,ts_length_bin=='46-50')
sp_50=subset(lfo_ts,ts_length_bin=='50+')


pl_18=ggplot(sp_18, aes(fill=species, y=n, x=factor(best_mod)))+
  scale_fill_manual(values=c("darkgray", "darkgreen", "darkblue","darksalmon","darkred"))+ 
  ggtitle("18 - 26 years")+
  geom_bar(position="stack", stat="identity") + 
  theme_minimal() +
  xlab('')+
  ylab('No. populations')+ 
  theme(text=element_text(size=12),axis.title=element_text(size=12,face="bold"),axis.line = element_line(colour = "black", 
                      size = 1, linetype = "solid"),plot.title = element_text(size=14))

pl_27=ggplot(sp_27, aes(fill=species, y=n, x=factor(best_mod)))+
  scale_fill_manual(values=c("darkgray", "darkgreen", "darkblue","darksalmon","darkred"))+
  ggtitle("27 - 35 years")+
  geom_bar(position="stack", stat="identity") + 
  theme_minimal() +
  xlim(factor(seq(1:8)))+
  xlab('')+
  ylab('No. populations')+ 
  theme(text=element_text(size=12),axis.title=element_text(size=12,face="bold"),axis.line = element_line(colour = "black", 
                      size = 1, linetype = "solid"),plot.title = element_text(size=14))

pl_35=ggplot(sp_35, aes(fill=species, y=n, x=factor(best_mod)))+
  scale_fill_manual(values=c("darkgray", "darkgreen","darksalmon","darkred"))+
  ggtitle("35 - 45 years")+
  geom_bar(position="stack", stat="identity") + 
  theme_minimal() +
   xlim(factor(seq(1:8)))+
  xlab('')+
  ylab('')+ 
  theme(text=element_text(size=12), axis.title=element_text(size=12,face="bold"),axis.line = element_line(colour = "black", 
                      size = 1, linetype = "solid"),plot.title = element_text(size=14))

pl_45=ggplot(sp_45, aes(fill=species, y=n, x=factor(best_mod)))+
  scale_fill_manual(values=c("darkgray", "darkgreen","darksalmon","darkred"))+
  ggtitle("46 - 50 years")+
  geom_bar(position="stack", stat="identity") + 
  theme_minimal() +
   xlim(factor(seq(1:8)))+
  xlab('')+
  ylab('No. populations')+ 
  theme(text=element_text(size=12), axis.title=element_text(size=12,face="bold"),axis.line = element_line(colour = "black", 
                      size = 1, linetype = "solid"),plot.title = element_text(size=14))

pl_50=ggplot(sp_50, aes(fill=species, y=n, x=factor(best_mod)))+
  scale_fill_manual(values=c("darkgray","darkblue","darkred"))+
  ggtitle("50+ years")+
  geom_bar(position="stack", stat="identity") + 
  theme_minimal() +
   xlim(factor(seq(1:8)))+
  xlab('')+
  ylab('')+ 
  theme(text=element_text(size=12), axis.title=element_text(size=12,face="bold"),axis.line = element_line(colour = "black", 
                      size = 1, linetype = "solid"),plot.title = element_text(size=14))

legend= get_legend(pl_18)

plot_grid(pl_18+ theme(legend.position="none"),
          pl_27+ theme(legend.position="none"),
          pl_35+ theme(legend.position="none"),
          pl_45+ theme(legend.position="none"),
          pl_50+ theme(legend.position="none"),
          legend,
          ncol=3,nrow=2,labels=c("A","B","C","D","E"))
```

#Stan LOO

## Top models - Stan LOO 
```{r, model weights loo}
loo=read.csv(here('outputs','ms_rmd','stan_looic_table_stackweight.csv'))
loo$lat=round(loo$lat,2)
loo$lon=round(loo$lon,2)
table(loo$best_mod)
round(table(loo$best_mod)/nrow(loo),3)
```

```{r, loo model weights by pop, warning = FALSE}

sp = loo %>% group_by(best_mod,species) %>% summarize(n=n())

ggplot(sp, aes(fill=species, y=n, x=factor(best_mod)))+
  scale_fill_manual(values=c("darkgray", "darkgreen", "darkblue","darksalmon","darkred"))+ 
  ggtitle("Top-ranked model LOO")+
  geom_bar(position="stack", stat="identity") + 
  theme_minimal() +
  xlab('')+
  ylab('No. populations')+ 
  theme(text=element_text(size=14),axis.text=element_text(size=14),axis.line = element_line(colour = "black", 
                      size = 1, linetype = "solid"),plot.title = element_text(size=14))
```

## State - Stan LOO

Top models broken down by state:

```{r,loo mod broken down by state }
sp_state = loo %>% group_by(state,best_mod,species) %>% summarize(n=n())
sp_ak=subset(sp_state,state=='AK')
sp_bc=subset(sp_state,state=='BC')
sp_wa=subset(sp_state,state=='WA')
sp_or=subset(sp_state,state=='OR')

or_pl=ggplot(sp_or, aes(fill=species, y=n, x=factor(best_mod)))+
  scale_fill_manual(values=c("darkgray", "darkgreen", "darkblue","darksalmon","darkred"))+ 
  ggtitle("Oregon")+
  geom_bar(position="stack", stat="identity") + 
  theme_minimal() +
  xlab('')+
  ylab('No. populations')+ 
  theme(text=element_text(size=12),axis.title=element_text(size=12,face="bold"),axis.line = element_line(colour = "black", 
                      size = 1, linetype = "solid"),plot.title = element_text(size=14))

wa_pl=ggplot(sp_wa, aes(fill=species, y=n, x=factor(best_mod)))+
  scale_fill_manual(values=c("darkgray", "darkgreen", "darkblue","darksalmon","darkred"))+
  ggtitle("Washington")+
  geom_bar(position="stack", stat="identity") + 
  theme_minimal() +
  xlim(factor(seq(1:8)))+
  xlab('')+
  ylab('No. populations')+ 
  theme(text=element_text(size=12),axis.title=element_text(size=12,face="bold"),axis.line = element_line(colour = "black", 
                      size = 1, linetype = "solid"),plot.title = element_text(size=14))

bc_pl=ggplot(sp_bc, aes(fill=species, y=n, x=factor(best_mod)))+
  scale_fill_manual(values=c("darkgray", "darkgreen", "darkblue","darksalmon","darkred"))+
  ggtitle("British Columbia")+
  geom_bar(position="stack", stat="identity") + 
  theme_minimal() +
   xlim(factor(seq(1:8)))+
  xlab('')+
  ylab('No. populations')+ 
  theme(text=element_text(size=12), axis.title=element_text(size=12,face="bold"),axis.line = element_line(colour = "black", 
                      size = 1, linetype = "solid"),plot.title = element_text(size=14))

ak_pl=ggplot(sp_ak, aes(fill=species, y=n, x=factor(best_mod)))+
  scale_fill_manual(values=c("darkgray", "darkgreen", "darkblue","darksalmon","darkred"))+
  ggtitle("Alaska")+
  geom_bar(position="stack", stat="identity") + 
  theme_minimal() +
  xlim(factor(seq(1:8)))+
  xlab('')+
  ylab('No. populations')+ 
  theme(text=element_text(size=12), axis.title=element_text(size=12,face="bold"),axis.line = element_line(colour = "black", 
                      size = 1, linetype = "solid"),plot.title = element_text(size=14))


pg1=plot_grid(or_pl+ theme(legend.position="none"),
          wa_pl+ theme(legend.position="none"),
          bc_pl+ theme(legend.position="none"),
          ak_pl+ theme(legend.position="none"),
          ncol=2,nrow=2,labels=c("A","B","C","D"))

legend= get_legend(bc_pl)

plot_grid(pg1,legend,rel_widths = c(3,.5))

```


## Ocean basins - Stan LFO (2/3n)

Top models broken down by ocean basin:

```{r, loo broken down by state and ocean basin}
sp_ocean = loo %>% group_by(ocean.basin,best_mod,species) %>% summarize(n=n())
sp_BS=subset(sp_ocean,ocean.basin=='BS')
sp_GOA=subset(sp_ocean,ocean.basin=='GOA')
sp_WC=subset(sp_ocean,ocean.basin=='WC')

WC_pl=ggplot(sp_WC, aes(fill=species, y=n, x=factor(best_mod)))+
  scale_fill_manual(values=c("darkgray", "darkgreen", "darkblue","darksalmon","darkred"))+ 
  ggtitle("West Coast")+
  geom_bar(position="stack", stat="identity") + 
  theme_minimal() +
  xlab('')+
  ylab('No. populations')+ 
  theme(text=element_text(size=12),axis.title=element_text(size=12,face="bold"),axis.line = element_line(colour = "black", 
                      size = 1, linetype = "solid"),plot.title = element_text(size=14))

GOA_pl=ggplot(sp_GOA, aes(fill=species, y=n, x=factor(best_mod)))+
  scale_fill_manual(values=c("darkgray", "darkgreen", "darkblue","darksalmon","darkred"))+
  ggtitle("Gulf of Alaska")+
  geom_bar(position="stack", stat="identity") + 
  theme_minimal() +
  xlim(factor(seq(1:8)))+
  xlab('')+
  ylab('No. populations')+ 
  theme(text=element_text(size=12),axis.title=element_text(size=12,face="bold"),axis.line = element_line(colour = "black", 
                      size = 1, linetype = "solid"),plot.title = element_text(size=14))

BS_pl=ggplot(sp_BS, aes(fill=species, y=n, x=factor(best_mod)))+
  scale_fill_manual(values=c("darkgray", "darkgreen", "darkblue","darksalmon","darkred"))+
  ggtitle("Bering Sea")+
  geom_bar(position="stack", stat="identity") + 
  theme_minimal() +
   xlim(factor(seq(1:8)))+
  xlab('')+
  ylab('No. populations')+ 
  theme(text=element_text(size=12), axis.title=element_text(size=12,face="bold"),axis.line = element_line(colour = "black", 
                      size = 1, linetype = "solid"),plot.title = element_text(size=14))

legend= get_legend(BS_pl)

plot_grid(WC_pl+ theme(legend.position="none"),
          GOA_pl+ theme(legend.position="none"),
          BS_pl+ theme(legend.position="none"),
          legend,
          ncol=2,nrow=2,labels=c("A","B","C"))

#legend= get_legend(WC_pl)

#plot_grid(pg1,legend,rel_widths = c(3,.5))



```

# TMB LFO-CV (L=10)
Out-of-sample performance is a key selection metric if we value predictive accuracy. Since spawner-recruitment data are time-series, we can establish a scenario where we attempt to predict future data using models built on historical observations through cross-validation. Starting with a minimum observation window, which we set here as 10 years, we iteratively build models for each remaining year of the data-series and determine how close model predictions are to each out-of-sample observation by calculating the log predictive density. We fit these models in Stan, and 

In turn, we convert these log predictive densities across the model posterior into model weights. Based on the model with the highest weight, the counts of populations best explained by each of the 8 models is:

## Top models - TMB LFO
```{r, TMB lfo model weights}
tmb_lfo=read.csv(here('outputs','ms_rmd','tmb_lfo_table.csv'))
tmb_lfo$lat=round(tmb_lfo$lat,2)
tmb_lfo$lon=round(tmb_lfo$lon,2)
table(tmb_lfo$best_mod)
round(table(tmb_lfo$best_mod)/nrow(tmb_lfo),3)
```
```{r, TMB lfo model weights by pop, warning = FALSE}

sp = tmb_lfo %>% group_by(best_mod,species) %>% summarize(n=n())

ggplot(sp, aes(fill=species, y=n, x=factor(best_mod)))+
  scale_fill_manual(values=c("darkgray", "darkgreen", "darkblue","darksalmon","darkred"))+ 
  ggtitle("Top-ranked model (L=10  TMB LFO)")+
  geom_bar(position="stack", stat="identity") + 
  theme_minimal() +
  xlab('')+
  ylab('No. populations')+ 
  theme(text=element_text(size=14),axis.text=element_text(size=14),axis.line = element_line(colour = "black", 
                      size = 1, linetype = "solid"),plot.title = element_text(size=14))
```

## State - TMB LFO

Top models broken down by state:

```{r, TMB lfo top mod broken down by state }
sp_state = tmb_lfo %>% group_by(state,best_mod,species) %>% summarize(n=n())
sp_ak=subset(sp_state,state=='AK')
sp_bc=subset(sp_state,state=='BC')
sp_wa=subset(sp_state,state=='WA')
sp_or=subset(sp_state,state=='OR')

or_pl=ggplot(sp_or, aes(fill=species, y=n, x=factor(best_mod)))+
  scale_fill_manual(values=c("darkgray", "darkgreen", "darkblue","darksalmon","darkred"))+ 
  ggtitle("Oregon")+
  geom_bar(position="stack", stat="identity") + 
  theme_minimal() +
  xlab('')+
  ylab('No. populations')+ 
  theme(text=element_text(size=12),axis.title=element_text(size=12,face="bold"),axis.line = element_line(colour = "black", 
                      size = 1, linetype = "solid"),plot.title = element_text(size=14))

wa_pl=ggplot(sp_wa, aes(fill=species, y=n, x=factor(best_mod)))+
  scale_fill_manual(values=c("darkgray", "darkgreen", "darkblue","darksalmon","darkred"))+
  ggtitle("Washington")+
  geom_bar(position="stack", stat="identity") + 
  theme_minimal() +
  xlim(factor(seq(1:8)))+
  xlab('')+
  ylab('No. populations')+ 
  theme(text=element_text(size=12),axis.title=element_text(size=12,face="bold"),axis.line = element_line(colour = "black", 
                      size = 1, linetype = "solid"),plot.title = element_text(size=14))

bc_pl=ggplot(sp_bc, aes(fill=species, y=n, x=factor(best_mod)))+
  scale_fill_manual(values=c("darkgray", "darkgreen", "darkblue","darksalmon","darkred"))+
  ggtitle("British Columbia")+
  geom_bar(position="stack", stat="identity") + 
  theme_minimal() +
  xlab('')+
  ylab('No. populations')+ 
  theme(text=element_text(size=12), axis.title=element_text(size=12,face="bold"),axis.line = element_line(colour = "black", 
                      size = 1, linetype = "solid"),plot.title = element_text(size=14))

ak_pl=ggplot(sp_ak, aes(fill=species, y=n, x=factor(best_mod)))+
  scale_fill_manual(values=c("darkgray", "darkgreen", "darkblue","darksalmon","darkred"))+
  ggtitle("Alaska")+
  geom_bar(position="stack", stat="identity") + 
  theme_minimal() +
  xlab('')+
  ylab('No. populations')+ 
  theme(text=element_text(size=12), axis.title=element_text(size=12,face="bold"),axis.line = element_line(colour = "black", 
                      size = 1, linetype = "solid"),plot.title = element_text(size=14))


pg1=plot_grid(or_pl+ theme(legend.position="none"),
          wa_pl+ theme(legend.position="none"),
          bc_pl+ theme(legend.position="none"),
          ak_pl+ theme(legend.position="none"),
          ncol=2,nrow=2,labels=c("A","B","C","D"))

legend= get_legend(bc_pl)

plot_grid(pg1,legend,rel_widths = c(3,.5))

```


## Ocean basins - TMB LFO

Top models broken down by ocean basin:

```{r, TMB lfo top mod broken down by state and ocean basin}
sp_ocean = tmb_lfo %>% group_by(ocean.basin,best_mod,species) %>% summarize(n=n())
sp_BS=subset(sp_ocean,ocean.basin=='BS')
sp_GOA=subset(sp_ocean,ocean.basin=='GOA')
sp_WC=subset(sp_ocean,ocean.basin=='WC')

WC_pl=ggplot(sp_WC, aes(fill=species, y=n, x=factor(best_mod)))+
  scale_fill_manual(values=c("darkgray", "darkgreen", "darkblue","darksalmon","darkred"))+ 
  ggtitle("West Coast")+
  geom_bar(position="stack", stat="identity") + 
  theme_minimal() +
  xlab('')+
  ylab('No. populations')+ 
  theme(text=element_text(size=12),axis.title=element_text(size=12,face="bold"),axis.line = element_line(colour = "black", 
                      size = 1, linetype = "solid"),plot.title = element_text(size=14))

GOA_pl=ggplot(sp_GOA, aes(fill=species, y=n, x=factor(best_mod)))+
  scale_fill_manual(values=c("darkgray", "darkgreen", "darkblue","darksalmon","darkred"))+
  ggtitle("Gulf of Alaska")+
  geom_bar(position="stack", stat="identity") + 
  theme_minimal() +
  xlim(factor(seq(1:8)))+
  xlab('')+
  ylab('No. populations')+ 
  theme(text=element_text(size=12),axis.title=element_text(size=12,face="bold"),axis.line = element_line(colour = "black", 
                      size = 1, linetype = "solid"),plot.title = element_text(size=14))

BS_pl=ggplot(sp_BS, aes(fill=species, y=n, x=factor(best_mod)))+
  scale_fill_manual(values=c("darkgray", "darkgreen", "darkblue","darksalmon","darkred"))+
  ggtitle("Bering Sea")+
  geom_bar(position="stack", stat="identity") + 
  theme_minimal() +
   xlim(factor(seq(1:8)))+
  xlab('')+
  ylab('No. populations')+ 
  theme(text=element_text(size=12), axis.title=element_text(size=12,face="bold"),axis.line = element_line(colour = "black", 
                      size = 1, linetype = "solid"),plot.title = element_text(size=14))

legend= get_legend(BS_pl)

plot_grid(WC_pl+ theme(legend.position="none"),
          GOA_pl+ theme(legend.position="none"),
          BS_pl+ theme(legend.position="none"),
          legend,
          ncol=2,nrow=2,labels=c("A","B","C"))

#legend= get_legend(WC_pl)

#plot_grid(pg1,legend,rel_widths = c(3,.5))



```

# TMB AICc

## Top models - TMB AIC
```{r, model weights AIC}
aic=read.csv(here('outputs','ms_rmd','aic_table.csv'))
aic$lat=round(aic$lat,2)
aic$lon=round(aic$lon,2)
table(aic$best_mod)
round(table(aic$best_mod)/nrow(aic),3)
```

```{r, AIC model weights by pop, warning = FALSE}

sp = aic %>% group_by(best_mod,species) %>% summarize(n=n())

ggplot(sp, aes(fill=species, y=n, x=factor(best_mod)))+
  scale_fill_manual(values=c("darkgray", "darkgreen", "darkblue","darksalmon","darkred"))+ 
  ggtitle("Top-ranked model (TMB AIC)")+
  geom_bar(position="stack", stat="identity") + 
  theme_minimal() +
  xlab('')+
  ylab('No. populations')+ 
  theme(text=element_text(size=14),axis.text=element_text(size=14),axis.line = element_line(colour = "black", 
                      size = 1, linetype = "solid"),plot.title = element_text(size=14))
```

## State - TMB AIC

Top models broken down by state:

```{r, AIC w broken down by state }
sp_state = aic %>% group_by(state,best_mod,species) %>% summarize(n=n())
sp_ak=subset(sp_state,state=='AK')
sp_bc=subset(sp_state,state=='BC')
sp_wa=subset(sp_state,state=='WA')
sp_or=subset(sp_state,state=='OR')

or_pl=ggplot(sp_or, aes(fill=species, y=n, x=factor(best_mod)))+
  scale_fill_manual(values=c("darkgray", "darkgreen", "darkblue","darksalmon","darkred"))+ 
  ggtitle("Oregon")+
  geom_bar(position="stack", stat="identity") + 
  theme_minimal() +
  xlim(factor(seq(1:8)))+
  xlab('')+
  ylab('No. populations')+ 
  theme(text=element_text(size=12),axis.title=element_text(size=12,face="bold"),axis.line = element_line(colour = "black", 
                      size = 1, linetype = "solid"),plot.title = element_text(size=14))

wa_pl=ggplot(sp_wa, aes(fill=species, y=n, x=factor(best_mod)))+
  scale_fill_manual(values=c("darkgray", "darkgreen", "darkblue","darksalmon","darkred"))+
  ggtitle("Washington")+
  geom_bar(position="stack", stat="identity") + 
  theme_minimal() +
  xlim(factor(seq(1:8)))+
  xlab('')+
  ylab('No. populations')+ 
  theme(text=element_text(size=12),axis.title=element_text(size=12,face="bold"),axis.line = element_line(colour = "black", 
                      size = 1, linetype = "solid"),plot.title = element_text(size=14))

bc_pl=ggplot(sp_bc, aes(fill=species, y=n, x=factor(best_mod)))+
  scale_fill_manual(values=c("darkgray", "darkgreen", "darkblue","darksalmon","darkred"))+
  ggtitle("British Columbia")+
  geom_bar(position="stack", stat="identity") + 
  theme_minimal() +
  xlim(factor(seq(1:8)))+
  xlab('')+
  ylab('No. populations')+ 
  theme(text=element_text(size=12), axis.title=element_text(size=12,face="bold"),axis.line = element_line(colour = "black", 
                      size = 1, linetype = "solid"),plot.title = element_text(size=14))

ak_pl=ggplot(sp_ak, aes(fill=species, y=n, x=factor(best_mod)))+
  scale_fill_manual(values=c("darkgray", "darkgreen", "darkblue","darksalmon","darkred"))+
  ggtitle("Alaska")+
  geom_bar(position="stack", stat="identity") + 
  theme_minimal() +
  xlim(factor(seq(1:8)))+
  xlab('')+
  ylab('No. populations')+ 
  theme(text=element_text(size=12), axis.title=element_text(size=12,face="bold"),axis.line = element_line(colour = "black", 
                      size = 1, linetype = "solid"),plot.title = element_text(size=14))


pg1=plot_grid(or_pl+ theme(legend.position="none"),
          wa_pl+ theme(legend.position="none"),
          bc_pl+ theme(legend.position="none"),
          ak_pl+ theme(legend.position="none"),
          ncol=2,nrow=2,labels=c("A","B","C","D"))

legend= get_legend(bc_pl)

plot_grid(pg1,legend,rel_widths = c(3,.5))

```


## Ocean basins - TMB AIC

Top models broken down by ocean basin:

```{r, top AIC model broken down by state and ocean basin}
sp_ocean = aic %>% group_by(ocean.basin,best_mod,species) %>% summarize(n=n())
sp_BS=subset(sp_ocean,ocean.basin=='BS')
sp_GOA=subset(sp_ocean,ocean.basin=='GOA')
sp_WC=subset(sp_ocean,ocean.basin=='WC')

WC_pl=ggplot(sp_WC, aes(fill=species, y=n, x=factor(best_mod)))+
  scale_fill_manual(values=c("darkgray", "darkgreen", "darkblue","darksalmon","darkred"))+ 
  ggtitle("West Coast")+
  geom_bar(position="stack", stat="identity") + 
  theme_minimal() +
  xlim(factor(seq(1:8)))+
  xlab('')+
  ylab('No. populations')+ 
  theme(text=element_text(size=12),axis.title=element_text(size=12,face="bold"),axis.line = element_line(colour = "black", 
                      size = 1, linetype = "solid"),plot.title = element_text(size=14))

GOA_pl=ggplot(sp_GOA, aes(fill=species, y=n, x=factor(best_mod)))+
  scale_fill_manual(values=c("darkgray", "darkgreen", "darkblue","darksalmon","darkred"))+
  ggtitle("Gulf of Alaska")+
  geom_bar(position="stack", stat="identity") + 
  theme_minimal() +
  xlim(factor(seq(1:8)))+
  xlab('')+
  ylab('No. populations')+ 
  theme(text=element_text(size=12),axis.title=element_text(size=12,face="bold"),axis.line = element_line(colour = "black", 
                      size = 1, linetype = "solid"),plot.title = element_text(size=14))

BS_pl=ggplot(sp_BS, aes(fill=species, y=n, x=factor(best_mod)))+
  scale_fill_manual(values=c("darkgray", "darkgreen", "darkblue","darksalmon","darkred"))+
  ggtitle("Bering Sea")+
  geom_bar(position="stack", stat="identity") + 
  theme_minimal() +
   xlim(factor(seq(1:8)))+
  xlab('')+
  ylab('No. populations')+ 
  theme(text=element_text(size=12), axis.title=element_text(size=12,face="bold"),axis.line = element_line(colour = "black", 
                      size = 1, linetype = "solid"),plot.title = element_text(size=14))

legend= get_legend(WC_pl)

plot_grid(WC_pl+ theme(legend.position="none"),
          GOA_pl+ theme(legend.position="none"),
          BS_pl+ theme(legend.position="none"),
          legend,
          ncol=2,nrow=2,labels=c("A","B","C"))

#legend= get_legend(WC_pl)

#plot_grid(pg1,legend,rel_widths = c(3,.5))



```

# TMB BIC

## Top models - TMB BIC
```{r, BIC model weights}
bic=read.csv(here('outputs','ms_rmd','aic_table.csv'))
bic$lat=round(bic$lat,2)
bic$lon=round(bic$lon,2)
table(bic$best_mod)
round(table(bic$best_mod)/nrow(bic),3)
```

```{r, BIC model weights by pop, warning = FALSE}

sp = bic %>% group_by(best_mod,species) %>% summarize(n=n())

ggplot(sp, aes(fill=species, y=n, x=factor(best_mod)))+
  scale_fill_manual(values=c("darkgray", "darkgreen", "darkblue","darksalmon","darkred"))+ 
  ggtitle("Top-ranked model (TMB BIC)")+
  geom_bar(position="stack", stat="identity") + 
  theme_minimal() +
  xlab('')+
  ylab('No. populations')+ 
  theme(text=element_text(size=14),axis.text=element_text(size=14),axis.line = element_line(colour = "black", 
                      size = 1, linetype = "solid"),plot.title = element_text(size=14))
```

## State - TMB BIC

Top models broken down by state:

```{r, top model BIC broken down by state }
sp_state = bic %>% group_by(state,best_mod,species) %>% summarize(n=n())
sp_ak=subset(sp_state,state=='AK')
sp_bc=subset(sp_state,state=='BC')
sp_wa=subset(sp_state,state=='WA')
sp_or=subset(sp_state,state=='OR')

or_pl=ggplot(sp_or, aes(fill=species, y=n, x=factor(best_mod)))+
  scale_fill_manual(values=c("darkgray", "darkgreen", "darkblue","darksalmon","darkred"))+ 
  ggtitle("Oregon")+
  geom_bar(position="stack", stat="identity") + 
  theme_minimal() +
  xlim(factor(seq(1:8)))+
  xlab('')+
  ylab('No. populations')+ 
  theme(text=element_text(size=12),axis.title=element_text(size=12,face="bold"),axis.line = element_line(colour = "black", 
                      size = 1, linetype = "solid"),plot.title = element_text(size=14))

wa_pl=ggplot(sp_wa, aes(fill=species, y=n, x=factor(best_mod)))+
  scale_fill_manual(values=c("darkgray", "darkgreen", "darkblue","darksalmon","darkred"))+
  ggtitle("Washington")+
  geom_bar(position="stack", stat="identity") + 
  theme_minimal() +
  xlim(factor(seq(1:8)))+
  xlab('')+
  ylab('No. populations')+ 
  theme(text=element_text(size=12),axis.title=element_text(size=12,face="bold"),axis.line = element_line(colour = "black", 
                      size = 1, linetype = "solid"),plot.title = element_text(size=14))

bc_pl=ggplot(sp_bc, aes(fill=species, y=n, x=factor(best_mod)))+
  scale_fill_manual(values=c("darkgray", "darkgreen", "darkblue","darksalmon","darkred"))+
  ggtitle("British Columbia")+
  geom_bar(position="stack", stat="identity") + 
  theme_minimal() +
  xlim(factor(seq(1:8)))+
  xlab('')+
  ylab('No. populations')+ 
  theme(text=element_text(size=12), axis.title=element_text(size=12,face="bold"),axis.line = element_line(colour = "black", 
                      size = 1, linetype = "solid"),plot.title = element_text(size=14))

ak_pl=ggplot(sp_ak, aes(fill=species, y=n, x=factor(best_mod)))+
  scale_fill_manual(values=c("darkgray", "darkgreen", "darkblue","darksalmon","darkred"))+
  ggtitle("Alaska")+
  geom_bar(position="stack", stat="identity") + 
  theme_minimal() +
  xlim(factor(seq(1:8)))+
  xlab('')+
  ylab('No. populations')+ 
  theme(text=element_text(size=12), axis.title=element_text(size=12,face="bold"),axis.line = element_line(colour = "black", 
                      size = 1, linetype = "solid"),plot.title = element_text(size=14))


pg1=plot_grid(or_pl+ theme(legend.position="none"),
          wa_pl+ theme(legend.position="none"),
          bc_pl+ theme(legend.position="none"),
          ak_pl+ theme(legend.position="none"),
          ncol=2,nrow=2,labels=c("A","B","C","D"))

legend= get_legend(bc_pl)

plot_grid(pg1,legend,rel_widths = c(3,.5))

```


## Ocean basins - TMB BIC

Top models broken down by ocean basin:

```{r, top model BIC broken down by ocean basin}
sp_ocean = bic %>% group_by(ocean.basin,best_mod,species) %>% summarize(n=n())
sp_BS=subset(sp_ocean,ocean.basin=='BS')
sp_GOA=subset(sp_ocean,ocean.basin=='GOA')
sp_WC=subset(sp_ocean,ocean.basin=='WC')

WC_pl=ggplot(sp_WC, aes(fill=species, y=n, x=factor(best_mod)))+
  scale_fill_manual(values=c("darkgray", "darkgreen", "darkblue","darksalmon","darkred"))+ 
  ggtitle("West Coast")+
  geom_bar(position="stack", stat="identity") + 
  theme_minimal() +
  xlim(factor(seq(1:8)))+
  xlab('')+
  ylab('No. populations')+ 
  theme(text=element_text(size=12),axis.title=element_text(size=12,face="bold"),axis.line = element_line(colour = "black", 
                      size = 1, linetype = "solid"),plot.title = element_text(size=14))

GOA_pl=ggplot(sp_GOA, aes(fill=species, y=n, x=factor(best_mod)))+
  scale_fill_manual(values=c("darkgray", "darkgreen", "darkblue","darksalmon","darkred"))+
  ggtitle("Gulf of Alaska")+
  geom_bar(position="stack", stat="identity") + 
  theme_minimal() +
  xlim(factor(seq(1:8)))+
  xlab('')+
  ylab('No. populations')+ 
  theme(text=element_text(size=12),axis.title=element_text(size=12,face="bold"),axis.line = element_line(colour = "black", 
                      size = 1, linetype = "solid"),plot.title = element_text(size=14))

BS_pl=ggplot(sp_BS, aes(fill=species, y=n, x=factor(best_mod)))+
  scale_fill_manual(values=c("darkgray", "darkgreen", "darkblue","darksalmon","darkred"))+
  ggtitle("Bering Sea")+
  geom_bar(position="stack", stat="identity") + 
  theme_minimal() +
   xlim(factor(seq(1:8)))+
  xlab('')+
  ylab('No. populations')+ 
  theme(text=element_text(size=12), axis.title=element_text(size=12,face="bold"),axis.line = element_line(colour = "black", 
                      size = 1, linetype = "solid"),plot.title = element_text(size=14))

legend= get_legend(WC_pl)

plot_grid(WC_pl+ theme(legend.position="none"),
          GOA_pl+ theme(legend.position="none"),
          BS_pl+ theme(legend.position="none"),
          legend,
          ncol=2,nrow=2,labels=c("A","B","C"))

#legend= get_legend(WC_pl)

#plot_grid(pg1,legend,rel_widths = c(3,.5))



```

# Population Overview - Stan LFO

By population, ordered by species and latitude of ocean entry, with weights for the predictive accuracy of each model. Red indicates higher weight.

```{r, lfo table}
formattable(lfo[,2:ncol(lfo)],
            list(area(col = 7:14) ~ color_tile("transparent", "red")))

```

# Population Overview - TMB LFO

By population, ordered by species and latitude of ocean entry, with weights for the predictive accuracy of each model. Red indicates higher weight.

```{r, tmb lfo table}
formattable(tmb_lfo[,2:ncol(tmb_lfo)],
            list(area(col = 7:14) ~ color_tile("transparent", "red")))

```
# Population Overview - AIC

By population, ordered by species and latitude of ocean entry, with weights for likelihood of each model. Red indicates higher weight.

```{r, AIC table}
formattable(aic[,2:ncol(aic)],
            list(area(col = 7:14) ~ color_tile("transparent", "red")))

```

# Population Overview - BIC

By population, ordered by species and latitude of ocean entry, with weights for likelihood of each model. Red indicates higher weight.

```{r, BIC table}
formattable(bic[,2:ncol(bic)],
            list(area(col = 7:14) ~ color_tile("transparent", "red")))

```
