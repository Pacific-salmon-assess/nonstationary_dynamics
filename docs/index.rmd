---
title: "Non-stationary model selection"
author: "D. Greenberg, C. Wor, C. Holt, & B. Connors"
date: "12/12/2022"
output:
  html_document:
    collapsed: no
    fig_caption: yes
    highlight: espresso
    number_sections: yes
    smooth_scroll: yes
    theme: sandstone
    toc: yes
    toc_float: yes
---
```{=html}
<style type="text/css">

body{ /* Normal  */
      font-size: 13px;
  }
td {  /* Table  */
  font-size: 13px;
}
h1.title {
  font-size: 24px;
  color: Black;
}
h1 { /* Header 1 */
  font-size: 19px;
  color: Black;
}
h2 { /* Header 2 */
    font-size: 15px;
  color: Black;
}
h3 { /* Header 3 */
    font-size: 15px;
  color: Black;
}
</style>
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(warning = FALSE)
```

# Overview

This document contains additional figures exploring the characteristics of the spawner-recruitment relationships for 267 Pacific salmon stocks located throughout the Northeast Pacific region.


```{r load,  include=FALSE}
library(here);library(ggplot2);library(dplyr);library(cowplot);library(formattable);library(ggspatial);library(sf);library(rnaturalearth);library(rnaturalearthdata)
options(dplyr.summarise.inform = FALSE)
stock_dat<- read.csv(here('data','filtered datasets','salmon_productivity_compilation_may2023.csv'))
stock_info<- read.csv(here('data','filtered datasets','all_stocks_info_may2023.csv'))
#Remove stocks with less than 15 years of recruitment data
stock_info_filtered=subset(stock_info,n.years>=16) #242 stocks
stock_info_filtered$stock.name=gsub('/','_',stock_info_filtered$stock.name)
stock_info_filtered$stock.name=gsub('&','and',stock_info_filtered$stock.name)

stock_info_filtered$state=factor(stock_info_filtered$state,levels=c('OR','WA','BC','AK'))
stock_info_filtered$ocean.basin=factor(stock_info_filtered$ocean.basin,levels=c('WC','GOA','BS'))

stock_dat2=subset(stock_dat,stock.id %in% stock_info_filtered$stock.id)
length(unique(stock_dat2$stock.id)) #242

stock_dat2$logR_S=log(stock_dat2$recruits/stock_dat2$spawners)

stock_info_filtered$state2=as.character(stock_info_filtered$state)
stock_info_filtered=stock_info_filtered %>% mutate(state2=ifelse(state=='OR','OR-WA',state2),
                                                   state2=ifelse(state=='WA','OR-WA',state2))
rownames(stock_info_filtered)=seq(1:nrow(stock_info_filtered))

```

```{r, plot colour schemes}
sp_cols=cbind(c('#6f9ba7',
'#316024',
'#295f8b',
'#a2450c',
'#811b0a'),c('Chinook','Chum','Coho','Pink','Sockeye'))

mod_col=cbind(c("azure4", "azure3", "cyan4","cadetblue3","deepskyblue4",'seagreen','olivedrab','darkgreen'),seq=1:8)

mc_col=cbind(c("azure3","deepskyblue4",'darkgreen'),c('static','dynamic','regime'))


mytheme = list(
  theme_classic(14)+
    theme(panel.background = element_blank(),strip.background = element_rect(colour=NA, fill=NA),panel.border = element_rect(fill = NA, color = "black"),
          legend.title = element_blank(),legend.position="bottom", strip.text = element_text(face="bold", size=13),
          axis.text=element_text(face="bold"),axis.title = element_text(face="bold",size=16),plot.title = element_text(face = "bold", hjust = 0.5,size=16))
)

```

# Spawner-recruit time-series overview
The goal of this document is to examine model performance of various stationary and non-stationary spawner-recruitment model forms for 267 Pacific salmon spawner-recruit time-series spanning five species of anadramous Pacific salmon (Chinook, Chum, Coho, Pink, and Sockeye) spanning from Oregon to Alaska.

## Map of timeseries
```{r, ts map,warning= FALSE,fig.dim = c(8, 6)}
world <- ne_countries(scale = "medium", returnclass = "sf")

all_lat_lon = stock_info_filtered %>% group_by(lat,lon,species) %>% summarize(n=n(),.groups = 'keep')
all_lat_lon$lon=ifelse(all_lat_lon$lon>0,-all_lat_lon$lon,all_lat_lon$lon)
ll_p=subset(all_lat_lon,species=='Pink')
ll_ch=subset(all_lat_lon,species=='Chum')
ll_soc=subset(all_lat_lon,species=='Sockeye')
ll_coh=subset(all_lat_lon,species=='Coho')
ll_chi=subset(all_lat_lon,species=='Chinook')

ggplot(data = world) + 
  geom_sf(fill= 'antiquewhite') +  xlab("Longitude") + ylab("Latitude") +
  geom_point(data = ll_p, mapping = aes(x = lon, y = lat), color = sp_cols[4], size = 2.2*log(ll_p$n+1), alpha = 0.7) +
  geom_point(data = ll_ch, mapping = aes(x = lon, y = lat), color = sp_cols[2], size = 2.2*log(ll_ch$n+1), alpha = 0.7) +
  geom_point(data =  ll_soc, mapping = aes(x = lon, y = lat), color = sp_cols[5], size = 2.2*log(ll_soc$n+1), alpha = 0.7) +
  geom_point(data =  ll_coh, mapping = aes(x = lon, y = lat), color = sp_cols[3], size = 2.2*log(ll_coh$n+1), alpha = 0.7) +
  geom_point(data = ll_chi, mapping = aes(x = lon, y = lat), color = sp_cols[1], size = 2.2*log(ll_chi$n+1), alpha = 0.7) +
    annotate(geom = 'text', x = -155, y = 54.5, label = 'Chinook', color = sp_cols[1], size = 4.5) + 
  annotate(geom = 'text', x = -155, y = 53, label = 'Chum', color = sp_cols[2], size = 4.5) + 
  annotate(geom = 'text', x = -155, y = 51.5, label = 'Coho', color = sp_cols[3], size = 4.5) + 
  annotate(geom = 'text', x = -155, y = 50, label = 'Pink', color = sp_cols[4], size = 4.5) + 
  annotate(geom = 'text', x = -155, y = 48.5, label = 'Sockeye', color = sp_cols[5], size = 4.5) + 
  annotate(geom = 'point', x = -145, y = 54, size = 2.2*log(1+1)) +
  annotate(geom = 'point', x = -145, y = 53, size = 2.2*log(3+1)) + 
  annotate(geom = 'point', x = -145, y = 51.5, size = 2.2*log(10+1)) + 
  annotate(geom = 'point', x = -145, y = 50, size = 2.2*log(20+1)) + 
  annotate(geom = 'text', x = -142, y = 55,label='n', size = 3.5) +
  annotate(geom = 'text', x = -142, y = 54,label='1', size = 3.5) +
  annotate(geom = 'text', x = -142, y = 53,label='3', size = 3.5) + 
  annotate(geom = 'text', x = -142, y = 51.5,label='10', size = 3.5) + 
  annotate(geom = 'text', x = -142, y = 50,label='20', size = 3.5) + 
  annotation_scale(location = 'bl', width_hint = 0.5) + 
  annotation_north_arrow(location = 'bl', which_north = 'true', pad_x = unit(0.35, 'in'), pad_y = unit(0.25, 'in'), style = north_arrow_fancy_orienteering) + 
  coord_sf(xlim = c(-170, -120), ylim = c(47, 72), expand = T) +
theme(panel.grid.major = element_line(color = gray(.5), linetype = 'dashed', size = 0.1), panel.background = element_rect(fill = 'lightblue1'),legend.title = element_blank())

```

## States/Provinces

```{r, ts by state}
sp_sum<- stock_info_filtered %>% group_by(species,state) %>% summarize(n=n(),.groups='keep')
sp_sum$state=factor(sp_sum$state,levels=c('OR','WA','BC','AK'))

ggplot(sp_sum, aes(fill=species, y=n, x=state))+
scale_fill_manual(values=sp_cols[match(levels(factor(sp_sum$species)),sp_cols[,2])])+ 
  geom_bar(position="stack", stat="identity") +
xlab('')+ylab('No. time-series')+
           mytheme
          

```

## Ocean basins

```{r, ts by ocean}
sp_sum<- stock_info_filtered %>% group_by(species,ocean.basin) %>% summarize(n=n(),.groups='keep')

ggplot(sp_sum, aes(fill=species, y=n, x=ocean.basin))+
scale_fill_manual(values=sp_cols[match(levels(factor(sp_sum$species)),sp_cols[,2])])+ 
  geom_bar(position="stack", stat="identity") + theme_minimal() +
xlab('')+ylab('No. time-series')+
            theme(panel.background = element_blank(),strip.background = element_rect(colour=NA, fill=NA),panel.border = element_rect(fill = NA, color = "black"),
                  strip.text = element_text(face="bold", size=12),
                  axis.text=element_text(face="bold"),axis.title = element_text(face="bold"),plot.title = element_text(face = "bold", hjust = 0.5,size=15))

```

## Series length

```{r, ts length}
sp_sum<- stock_info_filtered %>% group_by(n.years,species) %>% summarize(n=n(),.groups='keep')

ggplot(sp_sum, aes(fill=species, y=n, x=n.years))+
scale_fill_manual(values=sp_cols[match(levels(factor(sp_sum$species)),sp_cols[,2])])+ 
  geom_bar(position="stack", stat="identity") + theme_minimal() +
xlab('Years')+ylab('No. time-series')+
 mytheme

```


#Models

We fit three classes of spawner-recruitment models with 8 models in total, all building off the Ricker stock-recruitment curve:

+ Stationary models (Time-Invariant)
    1. Simple (model **1**):  
    $log(R_t/S_t) = \alpha - \beta*S_t + w_t$  
    $w_t \sim N(0,\sigma)$  
    2. AR(1) (model **2**):  
    $log(R_t/S_t) = \alpha - \beta*S_t + w_t$  
    $w_t = \epsilon_t + \rho*\epsilon_{t-1}$  
    $\epsilon_t \sim N(0,\sigma)$
                                                                           
+ Dynamic linear models (Time-Varying)
    3. Dynamic $\alpha$ (model **3**):  
    $log(R_t/S_t) = \alpha_t - \beta*S_t + w_t$  
    $\alpha_t = \alpha_{t-1} + v_{t}$  
    $v_t \sim N(0,\sigma_{\alpha})$  
    
    4. Dynamic $\beta$ (model **4**):  
    $log(R_t/S_t) = \alpha - \beta_t*S_t + w_t$  
    $\beta_t = \beta_{t-1} + u_{t}$   
    $u_t \sim N(0,\sigma_{\beta})$  
    
    5. Dynamic $\alpha$ and $\beta$ (model **5**):  
    $log(R_t/S_t) = \alpha_t - \beta_t*S_t + w_t$  
    $\alpha_t = \alpha_{t-1} + v_{t}$  
    $\beta_t = \beta_{t-1} + u_{t}$  
    $v_t \sim N(0,\sigma_{\alpha})$  
    $u_t \sim N(0,\sigma_{\beta})$  
        
+ Regime shift (Hidden Markov) models (Time-Varying)
    6. $\alpha$ Regime (model **6**):  
    $log(R_t/S_t) = \alpha_k - \beta*S_t + w_t$
    7. $\beta$ Regime (model **7**):  
    $log(R_t/S_t) = \alpha - \beta_k*S_t + w_t$
    8. $\alpha$ and $\beta$ Regime (model **8**):   
    $log(R_t/S_t) = \alpha_k - \beta_k*S_t + w_t$


#Stock Characteristics

Here we include an overview of parameters estimated for each stock fit from the aforementioned models.

```{r, load model outputs}
pl1=list() #params list - m1
pl2=list() #params list - m2
pl3=list() #params list - m3
pl4=list() #params list - m4
pl5=list() #params list - m5
pl6=list() #params list - m6
pl7=list() #params list - m7


for(i in 1:nrow(stock_info_filtered)){
  pl1[[i]]=read.csv(here('outputs','parameters',paste(sprintf("%03d", i),stock_info_filtered$stock.name[i],sep=''),'m1.csv'))  
  pl2[[i]]=read.csv(here('outputs','parameters',paste(sprintf("%03d", i),stock_info_filtered$stock.name[i],sep=''),'m2.csv'))  
  pl3[[i]]=read.csv(here('outputs','parameters',paste(sprintf("%03d", i),stock_info_filtered$stock.name[i],sep=''),'m3.csv'))  
  pl4[[i]]=read.csv(here('outputs','parameters',paste(sprintf("%03d", i),stock_info_filtered$stock.name[i],sep=''),'m4.csv'))  
  pl5[[i]]=read.csv(here('outputs','parameters',paste(sprintf("%03d", i),stock_info_filtered$stock.name[i],sep=''),'m5.csv'))  
  pl6[[i]]=read.csv(here('outputs','parameters',paste(sprintf("%03d", i),stock_info_filtered$stock.name[i],sep=''),'m6.csv'))  
  pl7[[i]]=read.csv(here('outputs','parameters',paste(sprintf("%03d", i),stock_info_filtered$stock.name[i],sep=''),'m7.csv'))  
}

```

## Productivity - log(alpha)

Log($\alpha$) estimated from the autocorrelated Ricker function (;model 2) for 267 Pacific salmon stocks. The light histogram is the entire posterior distribution among all stocks, while the dark histogram in the foreground indicates the distribution of median estimates among the 267 stocks:

```{r, stock char - log a}
m_alpha=unlist(lapply(pl2,function(x) median(x[,intersect(names(x), 'log_a')])))

d_alpha_l=lapply(pl1,function(x) x[,intersect(names(x), 'log_a')])
d_alpha=do.call('cbind',d_alpha_l)

par(mar=c(4,5,1,1))
hist(as.vector(d_alpha),col=adjustcolor('gray',alpha=0.4),xlim=c(min(d_alpha),max(d_alpha)),border=adjustcolor('white',alpha=0.4),breaks=50,freq=T,main='',xlab=expression(paste('log(',alpha,')')),yaxt='n',ylab='')

par(new=T)
hist(m_alpha,col=adjustcolor('black',alpha=0.4),xlim=c(min(d_alpha),max(d_alpha)),border=adjustcolor('white',alpha=0.2),breaks=30,freq=T,ylim=c(0,50),main='',xlab='')
ticksat <- seq(-1,4,by=0.1)
axis(1, ticksat, col="black", labels=NA,
     tcl=-0.2, lwd=0, lwd.ticks=1)
ticksat <- seq(-1,4,by=0.2)
axis(1, ticksat, col="black", labels=NA,
     tcl=-0.5, lwd=0, lwd.ticks=1)
```
Summary of the median estimate of log($\alpha$) among all stocks:

```{r}
summary(as.vector(m_alpha))
```


Log($\alpha$) estimated from the autocorrelated Ricker function (model 2) broken down by species:

```{r, stock char - log a by species}
par(mar = c(3, 2, 1, 1))
chi_alpha=d_alpha[,as.numeric(rownames(stock_info_filtered[stock_info_filtered$species=='Chinook',]))]
chu_alpha=d_alpha[,as.numeric(rownames(stock_info_filtered[stock_info_filtered$species=='Chum',]))]
coh_alpha=d_alpha[,as.numeric(rownames(stock_info_filtered[stock_info_filtered$species=='Coho',]))]
pi_alpha1=d_alpha[,as.numeric(rownames(stock_info_filtered[stock_info_filtered$species=='Pink-Even',]))]
pi_alpha2=d_alpha[,as.numeric(rownames(stock_info_filtered[stock_info_filtered$species=='Pink-odd',]))]
pi_alpha=cbind(pi_alpha1,pi_alpha2)
soc_alpha=d_alpha[,as.numeric(rownames(stock_info_filtered[stock_info_filtered$species=='Sockeye',]))]

par(mfrow=c(5,1))
hist(as.vector(chi_alpha),col=adjustcolor(sp_cols[1],alpha=0.4),xlim=c(min(d_alpha),max(d_alpha)),border=adjustcolor('white',alpha=0.2),breaks=50,freq=T,main='',xlab='',yaxt='n',ylab='n')
text(3.5,par('usr')[4]*0.9,'Chinook',col=sp_cols[1],cex=1.8)
par(new=T)
m_alpha=apply(chi_alpha,2,median)
hist(m_alpha,col=adjustcolor('black',alpha=0.4),xlim=c(min(d_alpha),max(d_alpha)),border=adjustcolor('white',alpha=0.2),breaks=30,freq=T,ylim=c(0,20),main='',xlab='')
ticksat <- seq(-1,4,by=0.1)
axis(1, ticksat, col="black", labels=NA,
     tcl=-0.2, lwd=0, lwd.ticks=1)
ticksat <- seq(-1,4,by=0.2)
axis(1, ticksat, col="black", labels=NA,
     tcl=-0.5, lwd=0, lwd.ticks=1)
#par(new=T)
hist(as.vector(chu_alpha),col=adjustcolor(sp_cols[2],alpha=0.4),xlim=c(min(d_alpha),max(d_alpha)),border=adjustcolor('white',alpha=0.2),breaks=50,freq=F,main='',xlab='',yaxt='n',ylab='n')
text(3.5,par('usr')[4]*0.9,'Chum',col=sp_cols[2],cex=1.8)
par(new=T)
m_alpha=apply(chu_alpha,2,median)
hist(m_alpha,col=adjustcolor('black',alpha=0.4),xlim=c(min(d_alpha),max(d_alpha)),border=adjustcolor('white',alpha=0.2),breaks=30,freq=T,ylim=c(0,10),main='',xlab='')
ticksat <- seq(-1,4,by=0.1)
axis(1, ticksat, col="black", labels=NA,
     tcl=-0.2, lwd=0, lwd.ticks=1)
ticksat <- seq(-1,4,by=0.2)
axis(1, ticksat, col="black", labels=NA,
     tcl=-0.5, lwd=0, lwd.ticks=1)
#par(new=T)
hist(as.vector(coh_alpha),col=adjustcolor(sp_cols[3],alpha=0.4),xlim=c(min(d_alpha),max(d_alpha)),border=adjustcolor('white',alpha=0.2),breaks=50,freq=F,main='',xlab='',yaxt='n',ylab='n')
text(3.5,par('usr')[4]*0.9,'Coho',col=sp_cols[3],cex=1.8)
par(new=T)
m_alpha=apply(coh_alpha,2,median)
hist(m_alpha,col=adjustcolor('black',alpha=0.4),xlim=c(min(d_alpha),max(d_alpha)),border=adjustcolor('white',alpha=0.2),breaks=30,freq=T,ylim=c(0,10),main='',xlab='')
ticksat <- seq(-1,4,by=0.1)
axis(1, ticksat, col="black", labels=NA,
     tcl=-0.2, lwd=0, lwd.ticks=1)
ticksat <- seq(-1,4,by=0.2)
axis(1, ticksat, col="black", labels=NA,
     tcl=-0.5, lwd=0, lwd.ticks=1)
#par(new=T)
hist(as.vector(pi_alpha),col=adjustcolor(sp_cols[4],alpha=0.4),xlim=c(min(d_alpha),max(d_alpha)),border=adjustcolor('white',alpha=0.2),breaks=50,freq=F,main='',xlab='',yaxt='n',ylab='n')
text(3.5,par('usr')[4]*0.9,'Pink',col=sp_cols[4],cex=1.8)
par(new=T)
m_alpha=apply(pi_alpha,2,median)
hist(m_alpha,col=adjustcolor('black',alpha=0.4),xlim=c(min(d_alpha),max(d_alpha)),border=adjustcolor('white',alpha=0.2),breaks=30,freq=T,ylim=c(0,10),main='',xlab='')
ticksat <- seq(-1,4,by=0.1)
axis(1, ticksat, col="black", labels=NA,
     tcl=-0.2, lwd=0, lwd.ticks=1)
ticksat <- seq(-1,4,by=0.2)
axis(1, ticksat, col="black", labels=NA,
     tcl=-0.5, lwd=0, lwd.ticks=1)
#par(new=T)
hist(as.vector(soc_alpha),col=adjustcolor(sp_cols[5],alpha=0.4),xlim=c(min(d_alpha),max(d_alpha)),border=adjustcolor('white',alpha=0.2),breaks=50,freq=F,main='',xlab='',yaxt='n',ylab='n')
text(3.5,par('usr')[4]*0.9,'Sockeye',col=sp_cols[5],cex=1.3)
par(new=T)
m_alpha=apply(soc_alpha,2,median)
hist(m_alpha,col=adjustcolor('black',alpha=0.4),xlim=c(min(d_alpha),max(d_alpha)),border=adjustcolor('white',alpha=0.2),breaks=30,freq=T,ylim=c(0,20),main='',xlab='')
mtext(expression(paste('log(',alpha,')')),side=1,line=2)
ticksat <- seq(-1,4,by=0.1)
axis(1, ticksat, col="black", labels=NA,
     tcl=-0.2, lwd=0, lwd.ticks=1)
ticksat <- seq(-1,4,by=0.2)
axis(1, ticksat, col="black", labels=NA,
     tcl=-0.5, lwd=0, lwd.ticks=1)
```

## Capacity - Smax

$Smax$ (1/beta) estimated from the simple Ricker function (model 2) for 267 Pacific salmon stocks:

```{r, stock char - Smax, fig.dim = c(8, 6)}
m_smax=unlist(lapply(pl2,function(x) median(x[,intersect(names(x), 'Smax')])))

d_smax_l=lapply(pl1,function(x) x[,intersect(names(x), 'Smax')])
d_smax=do.call('cbind',d_smax_l)

par(mfrow=c(1,1))
par(mar=c(4,5,1,1))
hist(as.vector(log10(d_smax)),col=adjustcolor('gray',alpha=0.4),border=adjustcolor('white',alpha=0.4),breaks=50,freq=T,main='',xlim=c(min(as.vector(log10(d_smax))),max(as.vector(log10(d_smax)))),yaxt='n',ylab='',xaxt='n',xlab='Smax')

par(new=T)
hist(log10(m_smax),col=adjustcolor('black',alpha=0.4),xlim=c(min(log10(d_smax)),max(log10(d_smax))),border=adjustcolor('white',alpha=0.2),breaks=30,freq=T,ylim=c(0,50),main='',xaxt='n',xlab='')
pow <- 0:7
ticksat <- as.vector(sapply(pow, function(p) (1:10)*10^p))
axis(1, log10(ticksat), col="black", labels=NA,
     tcl=-0.2, lwd=0, lwd.ticks=1)

axis(1, col="black", at=seq(0,8,by=1),   tcl=-0.45, cex.axis=1.2,
     labels=c(expression(1),expression(10),expression(100),expression('1K'),expression('10K'),expression('100K'),expression('1M'),expression('10M'),expression('100M')))

```

Smax (1/beta) estimated from the simple Ricker function (model 1) broken down by species:

```{r, stock char - Smax by species, fig.dim = c(14, 10)}
chi_smax=d_smax[,as.numeric(rownames(stock_info_filtered[stock_info_filtered$species=='Chinook',]))]
chu_smax=d_smax[,as.numeric(rownames(stock_info_filtered[stock_info_filtered$species=='Chum',]))]
coh_smax=d_smax[,as.numeric(rownames(stock_info_filtered[stock_info_filtered$species=='Coho',]))]
pi_smax1=d_smax[,as.numeric(rownames(stock_info_filtered[stock_info_filtered$species=='Pink-Even',]))]
pi_smax2=d_smax[,as.numeric(rownames(stock_info_filtered[stock_info_filtered$species=='Pink-odd',]))]
pi_smax=cbind(pi_smax1,pi_smax2)
soc_smax=d_smax[,as.numeric(rownames(stock_info_filtered[stock_info_filtered$species=='Sockeye',]))]

par(mar = c(3, 2, 1, 1))
#par(mfrow=c(5,1))
hist(log10(as.vector(chi_smax)),col=adjustcolor(sp_cols[1],alpha=0.4),xlim=c(min(log10(d_smax)),max(log10(d_smax))),border=adjustcolor('white',alpha=0.2),breaks=50,freq=T,main='',xlab='',yaxt='n',ylab='n',xaxt='n')
text(par('usr')[2]*0.8,par('usr')[4]*0.9,'Chinook',col=sp_cols[1],cex=1.3)
par(new=T)
m_smax=apply(chi_smax,2,median)
hist(log10(m_smax),col=adjustcolor('black',alpha=0.4),xlim=c(min(log10(d_smax)),max(log10(d_smax))),border=adjustcolor('white',alpha=0.2),breaks=30,freq=T,ylim=c(0,20),main='',xlab='',xaxt='n')
pow <- 0:7
ticksat <- as.vector(sapply(pow, function(p) (1:10)*10^p))
axis(1, log10(ticksat), col="black", labels=NA,
     tcl=-0.2, lwd=0, lwd.ticks=1)

axis(1, col="black", at=seq(0,8,by=1),   tcl=-0.45, cex.axis=1.2,
     labels=c(expression(1),expression(10),expression(100),expression('1K'),expression('10K'),expression('100K'),expression('1M'),expression('10M'),expression('100M')))

#par(new=T)
hist(log10(as.vector(chu_smax)),col=adjustcolor(sp_cols[2],alpha=0.4),xlim=c(min(log10(d_smax)),max(log10(d_smax))),border=adjustcolor('white',alpha=0.2),breaks=50,freq=T,main='',xlab='',yaxt='n',ylab='n',xaxt='n')
text(par('usr')[2]*0.8,par('usr')[4]*0.9,'Chum',col=sp_cols[2],cex=1.3)
par(new=T)
m_smax=apply(chu_smax,2,median)
hist(log10(m_smax),col=adjustcolor('black',alpha=0.4),xlim=c(min(log10(d_smax)),max(log10(d_smax))),border=adjustcolor('white',alpha=0.2),breaks=30,freq=T,ylim=c(0,20),main='',xlab='',xaxt='n')
pow <- 0:7
ticksat <- as.vector(sapply(pow, function(p) (1:10)*10^p))
axis(1, log10(ticksat), col="black", labels=NA,
     tcl=-0.2, lwd=0, lwd.ticks=1)

axis(1, col="black", at=seq(0,8,by=1),   tcl=-0.45, cex.axis=1.2,
     labels=c(expression(1),expression(10),expression(100),expression('1K'),expression('10K'),expression('100K'),expression('1M'),expression('10M'),expression('100M')))

#par(new=T)
hist(log10(as.vector(coh_smax)),col=adjustcolor(sp_cols[3],alpha=0.4),xlim=c(min(log10(d_smax)),max(log10(d_smax))),border=adjustcolor('white',alpha=0.2),breaks=50,freq=T,main='',xlab='',yaxt='n',ylab='n',xaxt='n')
text(par('usr')[2]*0.8,par('usr')[4]*0.9,'Coho',col=sp_cols[3],cex=1.3)
par(new=T)
m_smax=apply(coh_smax,2,median)
hist(log10(m_smax),col=adjustcolor('black',alpha=0.4),xlim=c(min(log10(d_smax)),max(log10(d_smax))),border=adjustcolor('white',alpha=0.2),breaks=30,freq=T,ylim=c(0,20),main='',xlab='',xaxt='n')
pow <- 0:7
ticksat <- as.vector(sapply(pow, function(p) (1:10)*10^p))
axis(1, log10(ticksat), col="black", labels=NA,
     tcl=-0.2, lwd=0, lwd.ticks=1)

axis(1, col="black", at=seq(0,8,by=1),   tcl=-0.45, cex.axis=1.2,
     labels=c(expression(1),expression(10),expression(100),expression('1K'),expression('10K'),expression('100K'),expression('1M'),expression('10M'),expression('100M')))

#par(new=T)
hist(log10(as.vector(pi_smax)),col=adjustcolor(sp_cols[4],alpha=0.4),xlim=c(min(log10(d_smax)),max(log10(d_smax))),border=adjustcolor('white',alpha=0.2),breaks=50,freq=T,main='',xlab='',yaxt='n',ylab='n',xaxt='n')
text(par('usr')[2]*0.8,par('usr')[4]*0.9,'Pink',col=sp_cols[4],cex=1.3)
par(new=T)
m_smax=apply(pi_smax,2,median)
hist(log10(m_smax),col=adjustcolor('black',alpha=0.4),xlim=c(min(log10(d_smax)),max(log10(d_smax))),border=adjustcolor('white',alpha=0.2),breaks=30,freq=T,ylim=c(0,20),main='',xlab='',xaxt='n')
pow <- 0:7
ticksat <- as.vector(sapply(pow, function(p) (1:10)*10^p))
axis(1, log10(ticksat), col="black", labels=NA,
     tcl=-0.2, lwd=0, lwd.ticks=1)

axis(1, col="black", at=seq(0,8,by=1),   tcl=-0.45, cex.axis=1.2,
     labels=c(expression(1),expression(10),expression(100),expression('1K'),expression('10K'),expression('100K'),expression('1M'),expression('10M'),expression('100M')))
#par(new=T)
hist(log10(as.vector(soc_smax)),col=adjustcolor(sp_cols[5],alpha=0.4),xlim=c(min(log10(d_smax)),max(log10(d_smax))),border=adjustcolor('white',alpha=0.2),breaks=50,freq=T,main='',xlab='',yaxt='n',ylab='n',xaxt='n')
text(par('usr')[2]*0.8,par('usr')[4]*0.9,'Sockeye',col=sp_cols[5],cex=1.3)
par(new=T)
m_smax=apply(soc_smax,2,median)
hist(log10(m_smax),col=adjustcolor('black',alpha=0.4),xlim=c(min(log10(d_smax)),max(log10(d_smax))),border=adjustcolor('white',alpha=0.2),breaks=30,freq=T,ylim=c(0,20),main='',xlab='',xaxt='n')
pow <- 0:7
ticksat <- as.vector(sapply(pow, function(p) (1:10)*10^p))
axis(1, log10(ticksat), col="black", labels=NA,
     tcl=-0.2, lwd=0, lwd.ticks=1)

axis(1, col="black", at=seq(0,8,by=1),   tcl=-0.45, cex.axis=1.2,
     labels=c(expression(1),expression(10),expression(100),expression('1K'),expression('10K'),expression('100K'),expression('1M'),expression('10M'),expression('100M')))

mtext('Smax',side=1,line=2)
```

## Sigma

$\sigma$ (residual deviance) estimated from the simple Ricker function (model 1) for 267 Pacific salmon stocks:

```{r, stock char - sigma}
m_sigma=unlist(lapply(pl2,function(x) median(x[,intersect(names(x), 'sigma_AR')])))

d_sigma_l=lapply(pl2,function(x) x[,intersect(names(x), 'sigma_AR')])
d_sigma=do.call('cbind',d_sigma_l)

par(mfrow=c(1,1))
par(mar=c(4,5,1,1))
hist(as.vector(d_sigma),col=adjustcolor('gray',alpha=0.4),xlim=c(0,2.5),border=adjustcolor('white',alpha=0.4),breaks=50,freq=T,main='',xlab='',yaxt='n',ylab='')

par(new=T)
hist(m_sigma,col=adjustcolor('black',alpha=0.4),xlim=c(0,2.5),border=adjustcolor('white',alpha=0.2),breaks=30,freq=T,ylim=c(0,50),main='',xlab=expression(paste(sigma)),xaxt='n',ylab='')
ticksat <- seq(0,2.5,by=0.1)
axis(1, ticksat, col="black", labels=NA,
     tcl=-0.2, lwd=0, lwd.ticks=1)

summary(as.vector(m_sigma))
```

$\sigma$ (residual deviance) broken down by species:

```{r, stock char - sigma by species, warnings=FALSE}
chi_sigma=d_sigma[,as.numeric(rownames(stock_info_filtered[stock_info_filtered$species=='Chinook',]))]
chu_sigma=d_sigma[,as.numeric(rownames(stock_info_filtered[stock_info_filtered$species=='Chum',]))]
coh_sigma=d_sigma[,as.numeric(rownames(stock_info_filtered[stock_info_filtered$species=='Coho',]))]
pi_sigma1=d_sigma[,as.numeric(rownames(stock_info_filtered[stock_info_filtered$species=='Pink-Even',]))]
pi_sigma2=d_sigma[,as.numeric(rownames(stock_info_filtered[stock_info_filtered$species=='Pink-odd',]))]
pi_sigma=cbind(pi_sigma1,pi_sigma2)
soc_sigma=d_sigma[,as.numeric(rownames(stock_info_filtered[stock_info_filtered$species=='Sockeye',]))]


par(mar = c(3, 2, 1, 1))
hist(as.vector(chi_sigma),col=adjustcolor(sp_cols[1],alpha=0.4),xlim=c(0,2.5),border=adjustcolor('white',alpha=0.2),breaks=50,freq=T,main='',xlab='',yaxt='n',ylab='')
text(par('usr')[2]*0.8,par('usr')[4]*0.9,'Chinook',col=sp_cols[1],cex=1.3)
par(new=T)
m_sig=apply(chi_sigma,2,median)
hist(m_sig,col=adjustcolor('black',alpha=0.4),xlim=c(0,2.5),border=adjustcolor('white',alpha=0.2),breaks=30,freq=T,ylim=c(0,20),main='',xlab='')
axis(1, ticksat, col="black", labels=NA,
     tcl=-0.2, lwd=0, lwd.ticks=1)
#par(new=T)
hist(as.vector(chu_sigma),col=adjustcolor(sp_cols[2],alpha=0.4),xlim=c(0,2.5),border=adjustcolor('white',alpha=0.2),breaks=50,freq=T,main='',xlab='',yaxt='n',ylab='')
text(par('usr')[2]*0.8,par('usr')[4]*0.9,'Chum',col=sp_cols[2],cex=1.3)
par(new=T)
m_sig=apply(chu_sigma,2,median)
hist(m_sig,col=adjustcolor('black',alpha=0.4),xlim=c(0,2.5),border=adjustcolor('white',alpha=0.2),breaks=30,freq=T,ylim=c(0,20),main='',xlab='')
axis(1, ticksat, col="black", labels=NA,
     tcl=-0.2, lwd=0, lwd.ticks=1)
#par(new=T)
hist(as.vector(coh_sigma),col=adjustcolor(sp_cols[3],alpha=0.4),xlim=c(0,2.5),border=adjustcolor('white',alpha=0.2),breaks=50,freq=T,main='',xlab='',yaxt='n',ylab='')
text(par('usr')[2]*0.8,par('usr')[4]*0.9,'Coho',col=sp_cols[3],cex=1.3)
par(new=T)
m_sig=apply(coh_sigma,2,median)
hist(m_sig,col=adjustcolor('black',alpha=0.4),xlim=c(0,2.5),border=adjustcolor('white',alpha=0.2),breaks=30,freq=T,ylim=c(0,20),main='',xlab='')
axis(1, ticksat, col="black", labels=NA,
     tcl=-0.2, lwd=0, lwd.ticks=1)
#par(new=T)
hist(as.vector(pi_sigma),col=adjustcolor(sp_cols[4],alpha=0.4),xlim=c(0,2.5),border=adjustcolor('white',alpha=0.2),breaks=50,freq=T,main='',xlab='',yaxt='n',ylab='')
text(par('usr')[2]*0.8,par('usr')[4]*0.9,'Pink',col=sp_cols[4],cex=1.3)
par(new=T)
m_sig=apply(pi_sigma,2,median)
hist(m_sig,col=adjustcolor('black',alpha=0.4),xlim=c(0,2.5),border=adjustcolor('white',alpha=0.2),breaks=30,freq=T,ylim=c(0,20),main='',xlab='')
axis(1, ticksat, col="black", labels=NA,
     tcl=-0.2, lwd=0, lwd.ticks=1)
#par(new=T)
hist(as.vector(soc_sigma),col=adjustcolor(sp_cols[5],alpha=0.4),xlim=c(0,2.5),border=adjustcolor('white',alpha=0.2),breaks=50,freq=T,main='',xlab='',yaxt='n',ylab='')
text(par('usr')[2]*0.8,par('usr')[4]*0.9,'Sockeye',col=sp_cols[5],cex=1.3)
par(new=T)
m_sig=apply(soc_sigma,2,median)
hist(m_sig,col=adjustcolor('black',alpha=0.4),xlim=c(0,2.5),border=adjustcolor('white',alpha=0.2),breaks=30,freq=T,ylim=c(0,20),main='',xlab='')
axis(1, ticksat, col="black", labels=NA,
     tcl=-0.2, lwd=0, lwd.ticks=1)

mtext(expression(paste(sigma)),side=1,line=2,cex=1.4)
```

## Autocorrelation (Rho)


$\rho$, autocorrelation coefficient for residuals from the Ricker function (model 2) for 267 Pacific salmon stocks:

```{r, stock char - rho, warnings=FALSE}
m_rho=unlist(lapply(pl2,function(x) median(x[,intersect(names(x), 'rho')])))

d_rho_l=lapply(pl2,function(x) x[,intersect(names(x), 'rho')])
d_rho=do.call('cbind',d_rho_l)

par(mfrow=c(1,1))
par(mar=c(4,5,1,1))
hist(as.vector(d_rho),col=adjustcolor('gray',alpha=0.4),xlim=c(-1,1),border=adjustcolor('white',alpha=0.4),breaks=50,freq=T,main='',xlab='',yaxt='n',ylab='')

par(new=T)
hist(m_rho,col=adjustcolor('black',alpha=0.4),xlim=c(-1,1),border=adjustcolor('white',alpha=0.2),breaks=30,freq=T,ylim=c(0,100),main='',xlab='',xaxt='n',ylab='')
ticksat <- seq(0,2.5,by=0.1)
axis(1, ticksat, col="black", labels=NA,
     tcl=-0.2, lwd=0, lwd.ticks=1)

mtext(expression(paste(rho)),side=1,line=2.2,cex=1.4)
```

$\rho$, autocorrelation broken down by species:

```{r, stock char - rho by species, warnings=FALSE}
chi_rho=d_rho[,as.numeric(rownames(stock_info_filtered[stock_info_filtered$species=='Chinook',]))]
chu_rho=d_rho[,as.numeric(rownames(stock_info_filtered[stock_info_filtered$species=='Chum',]))]
coh_rho=d_rho[,as.numeric(rownames(stock_info_filtered[stock_info_filtered$species=='Coho',]))]
pi_rho1=d_rho[,as.numeric(rownames(stock_info_filtered[stock_info_filtered$species=='Pink-Even',]))]
pi_rho2=d_rho[,as.numeric(rownames(stock_info_filtered[stock_info_filtered$species=='Pink-odd',]))]
pi_rho=cbind(pi_rho1,pi_rho2)
soc_rho=d_rho[,as.numeric(rownames(stock_info_filtered[stock_info_filtered$species=='Sockeye',]))]

par(mfrow=c(5,1))
par(mar = c(3, 2, 1, 1))
hist(as.vector(chi_rho),col=adjustcolor(sp_cols[1],alpha=0.4),xlim=c(-1,1),border=adjustcolor('white',alpha=0.2),breaks=50,freq=T,main='',xlab='',yaxt='n',ylab='')
text(par('usr')[2]*0.8,par('usr')[4]*0.9,'Chinook',col=sp_cols[1],cex=1.3)
par(new=T)
m_sig=apply(chi_rho,2,median)
hist(m_sig,col=adjustcolor('black',alpha=0.4),xlim=c(-1,1),border=adjustcolor('white',alpha=0.2),breaks=30,freq=T,ylim=c(0,20),main='',xlab='')
axis(1, ticksat, col="black", labels=NA,
     tcl=-0.2, lwd=0, lwd.ticks=1)
#par(new=T)
hist(as.vector(chu_rho),col=adjustcolor(sp_cols[2],alpha=0.4),xlim=c(-1,1),border=adjustcolor('white',alpha=0.2),breaks=50,freq=T,main='',xlab='',yaxt='n',ylab='')
text(par('usr')[2]*0.8,par('usr')[4]*0.9,'Chum',col=sp_cols[2],cex=1.3)
par(new=T)
m_sig=apply(chu_rho,2,median)
hist(m_sig,col=adjustcolor('black',alpha=0.4),xlim=c(-1,1),border=adjustcolor('white',alpha=0.2),breaks=30,freq=T,ylim=c(0,20),main='',xlab='')
axis(1, ticksat, col="black", labels=NA,
     tcl=-0.2, lwd=0, lwd.ticks=1)
#par(new=T)
hist(as.vector(coh_rho),col=adjustcolor(sp_cols[3],alpha=0.4),xlim=c(-1,1),border=adjustcolor('white',alpha=0.2),breaks=50,freq=T,main='',xlab='',yaxt='n',ylab='')
text(par('usr')[2]*0.8,par('usr')[4]*0.9,'Coho',col=sp_cols[3],cex=1.3)
par(new=T)
m_sig=apply(coh_rho,2,median)
hist(m_sig,col=adjustcolor('black',alpha=0.4),xlim=c(-1,1),border=adjustcolor('white',alpha=0.2),breaks=30,freq=T,ylim=c(0,20),main='',xlab='')
axis(1, ticksat, col="black", labels=NA,
     tcl=-0.2, lwd=0, lwd.ticks=1)
#par(new=T)
hist(as.vector(pi_rho),col=adjustcolor(sp_cols[4],alpha=0.4),xlim=c(-1,1),border=adjustcolor('white',alpha=0.2),breaks=50,freq=T,main='',xlab='',yaxt='n',ylab='')
text(par('usr')[2]*0.8,par('usr')[4]*0.9,'Pink',col=sp_cols[4],cex=1.3)
par(new=T)
m_sig=apply(pi_rho,2,median)
hist(m_sig,col=adjustcolor('black',alpha=0.4),xlim=c(-1,1),border=adjustcolor('white',alpha=0.2),breaks=20,freq=T,ylim=c(0,20),main='',xlab='')
axis(1, ticksat, col="black", labels=NA,
     tcl=-0.2, lwd=0, lwd.ticks=1)
#par(new=T)
hist(as.vector(soc_rho),col=adjustcolor(sp_cols[5],alpha=0.4),xlim=c(-1,1),border=adjustcolor('white',alpha=0.2),breaks=50,freq=T,main='',xlab='',yaxt='n',ylab='')
text(par('usr')[2]*0.8,par('usr')[4]*0.9,'Sockeye',col=sp_cols[5],cex=1.3)
par(new=T)
m_sig=apply(soc_rho,2,median)
hist(m_sig,col=adjustcolor('black',alpha=0.4),xlim=c(-1,1),border=adjustcolor('white',alpha=0.2),breaks=30,freq=T,ylim=c(0,20),main='',xlab='')
axis(1, ticksat, col="black", labels=NA,
     tcl=-0.2, lwd=0, lwd.ticks=1)

mtext(expression(paste(rho)),side=1,line=2.2,cex=1.2)
```

#Productivity trends

Measured in terms of 

```{r, prod trends}
#rescale alpha for each stock

prod_scale=matrix(nrow=nrow(stock_info_filtered),ncol=max(stock_dat2$broodyear)-min(stock_dat2$broodyear)+1)
colnames(prod_scale)=seq(min(stock_dat2$broodyear),max(stock_dat2$broodyear))
for(i in 1:nrow(stock_info_filtered)){
  prod=pl3[[i]][,grepl('log_a',colnames(pl3[[i]]))]
  prod_scale=prod/median(unlist(prod))
  m_prod_scale=apply(prod_scale,2,median)
  }

```

#Capacity trends
```{r, cap trends}


```

#Regimes
```{r, regimes}


```


# S-R Plots
```{r, sr plots, results= 'asis'}

#ordered by species, then stock
for(q in 1:5){
  sp=subset(stock_dat2,species==levels(factor(stock_dat2$species))[q])
  rearg=as.numeric(rownames(stock_info_filtered[stock_info_filtered$species==levels(factor(stock_info_filtered$species))[q],]))
  
   cat('\n')  
   cat("## ", levels(factor(stock_dat2$species))[q], "\n") #nested region header
   
  for(i in 1:length(unique(sp$stock))){
 s<- subset(sp,stock==unique(sp$stock)[i])
 s<- s[complete.cases(s$logR_S),] 
  
  df=data.frame(S=s$spawners,R=s$recruits,by=s$broodyear,logRS=s$logR_S)

   cat('\n')  
   cat("### ", gsub('-.*','',unique(sp$stock)[i]), "\n") #nested region header
   
   
par(mfrow=c(1,1))   
by_q=round(quantile(df$by,seq(0,1,by=0.1)))
cols=rev(RColorBrewer::brewer.pal(11, 'RdYlBu'))
col.p=cols[cut(df$by, 11, labels = FALSE)]
plot(R~S,data=df,bty='l',pch=21,cex=1.5,bg='black',xlim=c(0,max(df$S)),ylim=c(0,max(df$R)),type='n')
lines(R~S,data=df)
text(y=par('usr')[4]*0.9,x=par('usr')[2]*0.05,paste('alpha:',round(median(pl2[[i]][,grepl('log_a',colnames(pl2[[i]]))]),3),sep=' '))
text(y=par('usr')[4]*0.85,x=par('usr')[2]*0.05,paste('smax:',round(median(pl2[[i]][,grepl('Smax',colnames(pl2[[i]]))]),0),sep=' '))
text(y=par('usr')[4]*0.8,x=par('usr')[2]*0.05,paste('sigma:',round(median(pl2[[i]][,grepl('sigma_AR',colnames(pl2[[i]]))]),2),sep=' '))
text(y=par('usr')[4]*0.75,x=par('usr')[2]*0.05,paste('rho:',round(median(pl2[[i]][,grepl('rho',colnames(pl2[[i]]))]),2),sep=' '))
mtext(side=3,at=(0.65)*max(df$S),'begins',padj=-1.4,cex=0.8)
mtext(side=3,at=(0.65)*max(df$S),by_q[1],col=cols[1],padj=.2,cex=0.8)
mtext(side=3,at=(0.70)*max(df$S),by_q[3],col=cols[3],padj=.2,cex=0.8)
mtext(side=3,at=(0.75)*max(df$S),by_q[5],col=cols[5],padj=.2,cex=0.8)
mtext(side=3,at=(0.80)*max(df$S),by_q[7],col=cols[7],padj=.2,cex=0.8)
mtext(side=3,at=(0.85)*max(df$S),by_q[9],col=cols[9],padj=.2,cex=0.8)
mtext(side=3,at=(0.9)*max(df$S),by_q[11],col=cols[11],padj=.2,cex=0.8)
mtext(side=3,at=(0.9)*max(df$S),'ends',padj=-1.4,cex=0.8)

x_new=seq(0,max(na.omit(df$S)),length.out=1000)
p1=exp(median(pl1[[rearg[i]]][,grepl('log_a',colnames(pl1[[rearg[i]]]))])-median(pl1[[rearg[i]]][,grepl('b',colnames(pl1[[rearg[i]]]))])*x_new)*x_new
p2=exp(median(pl2[[rearg[i]]][,grepl('log_a',colnames(pl2[[rearg[i]]]))])-median(pl2[[rearg[i]]][,grepl('b',colnames(pl2[[rearg[i]]]))])*x_new)*x_new

lines(p1~x_new,lwd=3)
lines(p2~x_new,lwd=3,col='darkgray',lty=5)
points(R~S,data=df,pch=21,cex=1.5,bg=col.p)

pr1=median(pl1[[rearg[i]]][,grepl('log_a',colnames(pl1[[rearg[i]]]))])-median(pl1[[rearg[i]]][,grepl('b',colnames(pl1[[rearg[i]]]))])*df$S
plot(df$logRS-pr1~df$by,bty='l',type='l',ylab='residuals',xlab='year')
abline(h=0,lty=2)
points(df$logRS-pr1~df$by,pch=21,bg=col.p,cex=1.5)

#dynamic prod
#par(mfrow=c(1,2))
by_q=round(quantile(df$by,seq(0,1,by=0.1)))
cols=rev(RColorBrewer::brewer.pal(11, 'RdYlBu'))
col.p=cols[cut(df$by, 11, labels = FALSE)]
plot(R~S,data=df,bty='l',pch=21,cex=1.5,bg='black',main='dynamic prod.',xlim=c(0,max(df$S)),ylim=c(0,max(df$R)),type='n')
lines(R~S,data=df)
for(t in 1:nrow(df)){
  p=exp(median(pl3[[rearg[i]]][,grepl('log_a',colnames(pl3[[rearg[i]]]))][,t])-median(pl3[[rearg[i]]][,grepl('b',colnames(pl3[[rearg[i]]]))])*x_new)*x_new
  lines(p~x_new,lwd=2,col=col.p[t])
}
points(R~S,data=df,pch=21,cex=1.5,bg=col.p)

plot(apply(pl3[[rearg[i]]][,grepl('log_a',colnames(pl3[[rearg[i]]]))],2,median)~seq(min(df$by),max(df$by)),data=df,bty='l',ylab='alpha',xlab='year',ylim=c(quantile(unlist(pl3[[rearg[i]]][,grepl('log_a',colnames(pl3[[rearg[i]]]))]),0.01),quantile(unlist(pl3[[rearg[i]]][,grepl('log_a',colnames(pl3[[rearg[i]]]))]),0.99)),type='n')
lines(apply(pl3[[rearg[i]]][,grepl('log_a',colnames(pl3[[rearg[i]]]))],2,median)~seq(min(df$by),max(df$by)),lwd=1)
points(apply(pl3[[rearg[i]]][,grepl('log_a',colnames(pl3[[rearg[i]]]))],2,median)~seq(min(df$by),max(df$by)),pch=21,cex=1.5,bg=col.p)
lci=apply(pl3[[rearg[i]]][,grepl('log_a',colnames(pl3[[rearg[i]]]))],2,quantile,0.05)
uci=apply(pl3[[rearg[i]]][,grepl('log_a',colnames(pl3[[rearg[i]]]))],2,quantile,0.95)
x<- c(seq(min(df$by),max(df$by)), rev(seq(min(df$by),max(df$by))))
y<- c(lci, rev(uci))
polygon(x, y, col = adjustcolor('gray', alpha = 0.2), border=NA) # Add uncertainty polygon


#dynamic smax
#  par(mfrow=c(1,2))
by_q=round(quantile(df$by,seq(0,1,by=0.1)))
cols=rev(RColorBrewer::brewer.pal(11, 'RdYlBu'))
col.p=cols[cut(seq(min(df$by),max(df$by)), 11, labels = FALSE)]
plot(R~S,data=df,bty='l',pch=21,cex=1.5,bg='black',main='dynamic cap.',xlim=c(0,max(df$S)),ylim=c(0,max(df$R)),type='n')
lines(R~S,data=df)
for(t in 1:nrow(df)){
  p=exp(median(pl4[[rearg[i]]][,grepl('log_a',colnames(pl4[[rearg[i]]]))])-median(1/pl4[[rearg[i]]][,grepl('Smax',colnames(pl4[[rearg[i]]]))][,t])*x_new)*x_new
  lines(p~x_new,lwd=2,col=col.p[t])
}
points(R~S,data=df,pch=21,cex=1.5,bg=col.p)


plot(apply(pl4[[rearg[i]]][,grepl('Smax',colnames(pl4[[rearg[i]]]))],2,median)~seq(min(df$by),max(df$by)),data=df,bty='l',pch=21,cex=1.5,bg=col.p,ylab='Smax',xlab='year',ylim=c(0,quantile(unlist(pl4[[rearg[i]]][,grepl('Smax',colnames(pl4[[rearg[i]]]))]),0.95)))
lci=apply(pl4[[rearg[i]]][,grepl('Smax',colnames(pl4[[rearg[i]]]))],2,quantile,0.05)
uci=apply(pl4[[rearg[i]]][,grepl('Smax',colnames(pl4[[rearg[i]]]))],2,quantile,0.95)
x<- c(seq(min(df$by),max(df$by)), rev(seq(min(df$by),max(df$by))))
y<- c(lci, rev(uci))
polygon(x, y, col = adjustcolor('gray', alpha = 0.2), border=NA) # Add uncertainty polygon
lines(apply(pl4[[rearg[i]]][,grepl('Smax',colnames(pl4[[rearg[i]]]))],2,median)~seq(min(df$by),max(df$by)),lwd=1)


#prod regimes
#  par(mfrow=c(1,2))
plot(R~S,data=df,bty='l',pch=21,cex=1.5,type='n',main='regime prod.',xlim=c(0,max(df$S)),ylim=c(0,max(df$R)))
cols=RColorBrewer::brewer.pal(10, 'BrBG')
col.p=cols[cut(1-apply(pl5[[rearg[i]]][,grepl('gamma',colnames(pl5[[rearg[i]]]))][,1:nrow(df)],2,median), breaks = seq(0,1,by=0.1), labels = FALSE)]
lines(R~S,data=df)
p=exp(median(pl5[[rearg[i]]][,grepl('log_a',colnames(pl5[[rearg[i]]]))][,1])-median(pl5[[rearg[i]]][,grepl('b',colnames(pl5[[rearg[i]]]))])*x_new)*x_new
lines(p~x_new,lwd=2,col=cols[1])
p=exp(median(pl5[[rearg[i]]][,grepl('log_a',colnames(pl5[[rearg[i]]]))][,2])-median(pl5[[rearg[i]]][,grepl('b',colnames(pl5[[rearg[i]]]))])*x_new)*x_new
lines(p~x_new,lwd=2,col=cols[length(cols)])
points(R~S,data=df,pch=21,cex=1.5,bg=col.p)


plot(1-apply(pl5[[rearg[i]]][,grepl('gamma',colnames(pl5[[rearg[i]]]))][,1:nrow(df)],2,median)~df$by,data=df,bty='l',pch=21,cex=1.5,bg='black',ylab='p(high prod. regime)',xlab='year',ylim=c(0,1),type='n')
lci=1-apply(pl5[[rearg[i]]][,grepl('gamma',colnames(pl5[[rearg[i]]]))][,1:nrow(df)],2,quantile,0.05)
uci=1-apply(pl5[[rearg[i]]][,grepl('gamma',colnames(pl5[[rearg[i]]]))][,1:nrow(df)],2,quantile,0.95)
x<- c(df$by, rev(df$by))
y<- c(lci, rev(uci))
polygon(x, y, col = adjustcolor('gray', alpha = 0.2), border=NA) # Add uncertainty polygon
lines(1-apply(pl5[[rearg[i]]][,grepl('gamma',colnames(pl5[[rearg[i]]]))][,1:nrow(df)],2,median)~df$by,lwd=1)
points(1-apply(pl5[[rearg[i]]][,grepl('gamma',colnames(pl5[[rearg[i]]]))][,1:nrow(df)],2,median)~df$by,pch=21,cex=1.5,bg=col.p)

#smax regimes
# par(mfrow=c(1,2))
plot(R~S,data=df,bty='l',pch=21,cex=1.5,type='n',main='regime cap.',xlim=c(0,max(df$S)),ylim=c(0,max(df$R)))
cols=RColorBrewer::brewer.pal(10,'BrBG')
col.p=rev(cols)[cut(1-apply(pl6[[rearg[i]]][,grepl('gamma',colnames(pl6[[rearg[i]]]))][,1:nrow(df)],2,median), breaks = seq(0,1,by=0.1), labels = FALSE)]
lines(R~S,data=df)
p=exp(median(pl6[[rearg[i]]][,grepl('log_a',colnames(pl6[[rearg[i]]]))])-median(pl6[[rearg[i]]][,grepl('b',colnames(pl6[[rearg[i]]]))][,1])*x_new)*x_new
lines(p~x_new,lwd=2,col=cols[length(cols)])
p=exp(median(pl6[[rearg[i]]][,grepl('log_a',colnames(pl6[[rearg[i]]]))])-median(pl6[[rearg[i]]][,grepl('b',colnames(pl6[[rearg[i]]]))][,2])*x_new)*x_new
lines(p~x_new,lwd=2,col=cols[1])
points(R~S,data=df,pch=21,cex=1.5,bg=col.p)

plot(apply(pl6[[rearg[i]]][,grepl('gamma',colnames(pl6[[rearg[i]]]))][,1:nrow(df)],2,median)~df$by,data=df,bty='l',pch=21,cex=1.5,bg='black',ylab='p(high cap. regime)',xlab='year',ylim=c(0,1),type='n')
lci=apply(pl6[[rearg[i]]][,grepl('gamma',colnames(pl6[[rearg[i]]]))][,1:nrow(df)],2,quantile,0.05)
uci=apply(pl6[[rearg[i]]][,grepl('gamma',colnames(pl6[[rearg[i]]]))][,1:nrow(df)],2,quantile,0.95)
x<- c(df$by, rev(df$by))
y<- c(lci, rev(uci))
polygon(x, y, col = adjustcolor('gray', alpha = 0.2), border=NA) # Add uncertainty polygon
lines(apply(pl6[[rearg[i]]][,grepl('gamma',colnames(pl6[[rearg[i]]]))][,1:nrow(df)],2,median)~df$by,lwd=1)
points(apply(pl6[[rearg[i]]][,grepl('gamma',colnames(pl6[[rearg[i]]]))][,1:nrow(df)],2,median)~df$by,pch=21,cex=1.5,bg=col.p)

#prod & smax regimes
# par(mfrow=c(1,2))
plot(R~S,data=df,bty='l',pch=21,cex=1.5,type='n',main='regime prod. cap.',xlim=c(0,max(df$S)),ylim=c(0,max(df$R)))
cols=RColorBrewer::brewer.pal(11,'BrBG')
col.p=cols[cut(1-apply(pl7[[rearg[i]]][,grepl('gamma',colnames(pl7[[rearg[i]]]))][,1:nrow(df)],2,median), breaks = seq(0,1,by=0.1), labels = FALSE)]
lines(R~S,data=df)
p=exp(median(pl7[[rearg[i]]][,grepl('log_a',colnames(pl7[[rearg[i]]]))][,1])-median(pl7[[rearg[i]]][,grepl('b',colnames(pl7[[rearg[i]]]))][,1])*x_new)*x_new
lines(p~x_new,lwd=2,col=cols[1])
p=exp(median(pl7[[rearg[i]]][,grepl('log_a',colnames(pl7[[rearg[i]]]))][,2])-median(pl7[[rearg[i]]][,grepl('b',colnames(pl7[[rearg[i]]]))][,2])*x_new)*x_new
lines(p~x_new,lwd=2,col=cols[length(cols)])
points(R~S,data=df,pch=21,cex=1.5,bg=col.p)

plot(1-apply(pl7[[rearg[i]]][,grepl('gamma',colnames(pl7[[rearg[i]]]))][,1:nrow(df)],2,median)~df$by,data=df,bty='l',pch=21,cex=1.5,bg='black',ylab='p(high prod. regime)',xlab='year',ylim=c(0,1),type='n')
lci=1-apply(pl7[[rearg[i]]][,grepl('gamma',colnames(pl7[[rearg[i]]]))][,1:nrow(df)],2,quantile,0.05)
uci=1-apply(pl7[[rearg[i]]][,grepl('gamma',colnames(pl7[[rearg[i]]]))][,1:nrow(df)],2,quantile,0.95)
x<- c(df$by, rev(df$by))
y<- c(lci, rev(uci))
polygon(x, y, col = adjustcolor('gray', alpha = 0.2), border=NA) # Add uncertainty polygon
lines(1-apply(pl7[[rearg[i]]][,grepl('gamma',colnames(pl7[[rearg[i]]]))][,1:nrow(df)],2,median)~df$by,lwd=1)
points(1-apply(pl7[[rearg[i]]][,grepl('gamma',colnames(pl7[[rearg[i]]]))][,1:nrow(df)],2,median)~df$by,pch=21,cex=1.5,bg=col.p)

  }
   
}
```
