---
title: "Non-stationary dynamics in Pacific salmon productivity"
author: "D. Greenberg, C. Wor, C. Holt, & B. Connors"
date: 'February 2025'
output:
  html_document:
    collapsed: no
    fig_caption: yes
    highlight: espresso
    number_sections: yes
    smooth_scroll: yes
    theme: sandstone
    toc: yes
    toc_float: yes
---
```{=html}
<style type="text/css">

body{ /* Normal  */
      font-size: 13px;
  }
td {  /* Table  */
  font-size: 13px;
}
h1.title {
  font-size: 24px;
  color: Black;
}
h1 { /* Header 1 */
  font-size: 19px;
  color: Black;
}
h2 { /* Header 2 */
    font-size: 15px;
  color: Black;
}
h3 { /* Header 3 */
    font-size: 15px;
  color: Black;
}
</style>
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(warning = FALSE)
```

# Overview

This document contains additional figures exploring the characteristics of the spawner-recruitment relationships for 318 Pacific salmon stocks located throughout the Northeast Pacific region.


```{r load,  include=FALSE}
library(here);library(ggplot2);library(dplyr);library(cowplot);library(ggspatial);library(sf);library(rnaturalearth)
options(dplyr.summarise.inform = FALSE)
stock_dat<- read.csv(here('data','filtered datasets','salmon_productivity_compilation2024-10-17.csv'))
stock_dat$stock=gsub('/','_',stock_dat$stock)
stock_dat$stock=gsub('&','and',stock_dat$stock)
stock_info<- read.csv(here('data','filtered datasets','stock_info2024-10-17.csv'))
#Remove stocks with less than 15 years of recruitment data
stock_info$stock.name=gsub('/','_',stock_info$stock.name)
stock_info$stock.name=gsub('&','and',stock_info$stock.name)

stock_info$state=factor(stock_info$state,levels=c('WA','BC','AK'))
stock_info$ocean.basin=factor(stock_info$ocean.basin,levels=c('WC','SEAK','GOA','BS'))

stock_dat2=subset(stock_dat,stock.id %in% stock_info$stock.id)
#length(unique(stock_dat2$stock)) #267
stock_dat2$logR_S=log(stock_dat2$recruits/stock_dat2$spawners)

stock_info$species2=gsub("-.*", "", stock_info$species) # collapse even/odd pinks together



```

```{r, plot colour schemes}
sp_cols=cbind(c('#6f9ba7',
'#316024',
'#295f8b',
'#a2450c',
'#811b0a'),c('Chinook','Chum','Coho','Pink','Sockeye'))

basin_cols=cbind(c('#ffc454',
                  '#64a95d',
                    '#007779',
                  '#003f5c')
                ,c('WC','SEAK','GOA','BS'))

state_cols=cbind(c('#edf8b1',
                  '#1c9099',
                  '#67a9cf')
                ,c('WA','BC','AK'))

mytheme = list(
  theme_classic(14)+
    theme(panel.background = element_blank(),strip.background = element_rect(colour=NA, fill=NA),panel.border = element_rect(fill = NA, color = "black"),
          legend.title = element_blank(),legend.position="bottom", strip.text = element_text(face="bold", size=13),
          axis.text=element_text(face="bold"),axis.title = element_text(face="bold",size=16),plot.title = element_text(face = "bold", hjust = 0.5,size=16))
)

```



## Map of timeseries
```{r, ts map,warning= FALSE,fig.dim = c(8, 6)}
world <- ne_countries(scale = "medium", returnclass = "sf")

all_lat_lon = stock_info %>% group_by(lat,lon,species2) %>% summarize(n=n(),.groups = 'keep')
all_lat_lon$lon=ifelse(all_lat_lon$lon>0,-all_lat_lon$lon,all_lat_lon$lon)
all_lat_lon$ocean.basin=stock_info$ocean.basin[match(all_lat_lon$lat,stock_info$lat)]
ll_p=subset(all_lat_lon,species2=='Pink')
ll_ch=subset(all_lat_lon,species2=='Chum')
ll_coh=subset(all_lat_lon,species2=='Coho')
ll_soc=subset(all_lat_lon,species2=='Sockeye')
ll_chi=subset(all_lat_lon,species2=='Chinook')

ggplot(data = world) + 
  geom_sf(fill= 'antiquewhite') +  xlab("Longitude") + ylab("Latitude") +
  geom_point(data = ll_p, mapping = aes(x = lon, y = lat), color = sp_cols[4], size = 2.2*log(ll_p$n+1), alpha = 0.7) +
  geom_point(data = ll_ch, mapping = aes(x = lon, y = lat), color = sp_cols[2], size = 2.2*log(ll_ch$n+1), alpha = 0.7) +
  geom_point(data =  ll_soc, mapping = aes(x = lon, y = lat), color = sp_cols[5], size = 2.2*log(ll_soc$n+1), alpha = 0.7) +
  geom_point(data =  ll_coh, mapping = aes(x = lon, y = lat), color = sp_cols[3], size = 2.2*log(ll_coh$n+1), alpha = 0.7) +
  geom_point(data = ll_chi, mapping = aes(x = lon, y = lat), color = sp_cols[1], size = 2.2*log(ll_chi$n+1), alpha = 0.7) +
  annotate(geom = 'text', x = -155, y = 54.5, label = 'Chinook', color = sp_cols[1], size = 4.5) + 
  annotate(geom = 'text', x = -155, y = 53, label = 'Chum', color = sp_cols[2], size = 4.5) + 
  annotate(geom = 'text', x = -155, y = 51.5, label = 'Coho', color = sp_cols[3], size = 4.5) + 
  annotate(geom = 'text', x = -155, y = 50, label = 'Pink', color = sp_cols[4], size = 4.5) + 
  annotate(geom = 'text', x = -155, y = 48.5, label = 'Sockeye', color = sp_cols[5], size = 4.5) + 
  annotate(geom = 'point', x = -145, y = 54, size = 2.2*log(1+1)) +
  annotate(geom = 'point', x = -145, y = 53, size = 2.2*log(3+1)) + 
  annotate(geom = 'point', x = -145, y = 51.5, size = 2.2*log(10+1)) + 
  annotate(geom = 'point', x = -145, y = 50, size = 2.2*log(20+1)) + 
  annotate(geom = 'text', x = -142, y = 55,label='n', size = 3.5) +
  annotate(geom = 'text', x = -142, y = 54,label='1', size = 3.5) +
  annotate(geom = 'text', x = -142, y = 53,label='3', size = 3.5) + 
  annotate(geom = 'text', x = -142, y = 51.5,label='10', size = 3.5) + 
  annotate(geom = 'text', x = -142, y = 50,label='20', size = 3.5) + 
  annotation_scale(location = 'bl', width_hint = 0.5) + 
  annotation_north_arrow(location = 'bl', which_north = 'true', pad_x = unit(0.35, 'in'), pad_y = unit(0.25, 'in'), style = north_arrow_fancy_orienteering) + 
  coord_sf(xlim = c(-170, -120), ylim = c(47, 71), expand = T) +
theme(panel.grid.major = element_line(color = gray(.5), linetype = 'dashed', linewidth = 0.1), panel.background = element_rect(fill = 'white'),legend.title = element_blank())

```

## States/Provinces
Number of spawner-recruit time-series by state/province jurisdiction: Washington (WA), British Columbia (BC), Alaska (AK).

```{r, ts by state}
sp_sum<- stock_info %>% group_by(species2,state) %>% summarize(n=n(),.groups='keep')
sp_sum$state=factor(sp_sum$state,levels=c('WA','BC','AK'))

ggplot(sp_sum, aes(fill=species2, y=n, x=state))+
scale_fill_manual(values=sp_cols[match(levels(factor(sp_sum$species2)),sp_cols[,2])])+ 
  geom_bar(position="stack", stat="identity") +
xlab('')+ylab('Number of time-series')+
           mytheme
          

```

## Ocean basins/Large Marine Ecosystems

Number of spawner-recruit time-series by Large Marine Ecosystem: West Coast (WC), Southeast Alaska/North Coast British Columbia (SEAK), Gulf of Alaska (GOA), and Bering Sea (BS).

```{r, ts by ocean}
sp_sum<- stock_info %>% group_by(species2,ocean.basin) %>% summarize(n=n(),.groups='keep')

ggplot(sp_sum, aes(fill=species2, y=n, x=ocean.basin))+
scale_fill_manual(values=sp_cols[match(levels(factor(sp_sum$species2)),sp_cols[,2])],name='Species')+ 
  geom_bar(position="stack", stat="identity") + theme_minimal() +
xlab('')+ylab('Number of time-series')+
            theme(panel.background = element_blank(),strip.background = element_rect(colour=NA, fill=NA),panel.border = element_rect(fill = NA, color = "black"),
                  strip.text = element_text(face="bold", size=12),
                  axis.text=element_text(face="bold"),axis.title = element_text(face="bold"),plot.title = element_text(face = "bold", hjust = 0.5,size=15))

```

## Series length

Distribution of spawner-recruit time-series lengths (number of years of brood cohort observations) broken down by species.

```{r, ts length}
sp_sum<- stock_info %>% group_by(n.years,species2) %>% summarize(n=n(),.groups='keep')

ggplot(sp_sum, aes(fill=species2, y=n, x=n.years))+
scale_fill_manual(values=sp_cols[match(levels(factor(sp_sum$species2)),sp_cols[,2])])+ 
  geom_bar(position="stack", stat="identity") + theme_minimal() +
xlab('Years')+ylab('No. time-series')+
 mytheme

```



# Stock parameters - static

For each species, we fit a multi-stock Ricker spawner-recruit model with static parameters (model 1 in match text). Productivity ($alpha$) is hierarchically structured based on geography (sub-regions nested within large marine ecosystems). All other parameters are sampled independently for each stock.

```{r, load model outputs}
#static models
stc.chk=readRDS('../outputs/model fits/hier_fit_chinook.RDS')
stc.cho=readRDS('../outputs/model fits/hier_fit_coho.RDS')
stc.chm=readRDS('../outputs/model fits/hier_fit_chum.RDS')
stc.pke=readRDS('../outputs/model fits/hier_fit_pinke.RDS')
stc.pko=readRDS('../outputs/model fits/hier_fit_pinko.RDS')
stc.scy=readRDS('../outputs/model fits/hier_fit_sockeye.RDS')

#visual assets
sp_cols=cbind(c('#6f9ba7',
                '#316024',
                '#295f8b',
                '#a2450c',
                '#811b0a'),c('Chinook','Chum','Coho','Pink','Sockeye'))

basin_cols=cbind(c('#ffc454',
                   '#64a95d',
                   '#007779',
                   '#003f5c')
                 ,c('WC','SEAK','GOA','BS'))

#metadata
stk.info=read.csv(here('data','filtered datasets','stock_info2024-10-17.csv'))
chk.info=subset(stk.info,species=='Chinook')
scy.info=subset(stk.info,species=='Sockeye')
chm.info=subset(stk.info,species=='Chum')
cho.info=subset(stk.info,species=='Coho')
pke.info=subset(stk.info,species=='Pink-Even')
pko.info=subset(stk.info,species=='Pink-Odd')

#broken down by LME
#wc
chk.wc=which(chk.info$ocean.basin=='WC')
chm.wc=which(chm.info$ocean.basin=='WC')
cho.wc=which(cho.info$ocean.basin=='WC')
pke.wc=which(pke.info$ocean.basin=='WC')
pko.wc=which(pko.info$ocean.basin=='WC')
scy.wc=which(scy.info$ocean.basin=='WC')
#nbc-seak
chk.seak=which(chk.info$ocean.basin=='SEAK')
chm.seak=which(chm.info$ocean.basin=='SEAK')
cho.seak=which(cho.info$ocean.basin=='SEAK')
pke.seak=which(pke.info$ocean.basin=='SEAK')
pko.seak=which(pko.info$ocean.basin=='SEAK')
scy.seak=which(scy.info$ocean.basin=='SEAK')
#gulf
chk.goa=which(chk.info$ocean.basin=='GOA')
chm.goa=which(chm.info$ocean.basin=='GOA')
cho.goa=which(cho.info$ocean.basin=='GOA')
pke.goa=which(pke.info$ocean.basin=='GOA')
pko.goa=which(pko.info$ocean.basin=='GOA')
scy.goa=which(scy.info$ocean.basin=='GOA')
#bering
chk.bs=which(chk.info$ocean.basin=='BS')
chm.bs=which(chm.info$ocean.basin=='BS')
cho.bs=which(cho.info$ocean.basin=='BS')
pke.bs=which(pke.info$ocean.basin=='BS')
pko.bs=which(pko.info$ocean.basin=='BS')
scy.bs=which(scy.info$ocean.basin=='BS')
```

## Productivity

Productivity, log($\alpha$), estimated at different hierarchical levels.

### Global (all stocks)

Mean productivity, among all stocks, for each species.

```{r, global log a}
glob.alpha.chk=stc.chk$draws(variable='log_a0',format='draws_matrix')
glob.alpha.chm=stc.chm$draws(variable='log_a0',format='draws_matrix')
glob.alpha.cho=stc.cho$draws(variable='log_a0',format='draws_matrix')
glob.alpha.pke=stc.pke$draws(variable='log_a0',format='draws_matrix')
glob.alpha.pko=stc.pko$draws(variable='log_a0',format='draws_matrix')
glob.alpha.scy=stc.scy$draws(variable='log_a0',format='draws_matrix')

par(mfrow=c(3,2))
par(mar=c(4,5,3,1))
min=0
max=3

hist(as.vector(glob.alpha.chk),border=adjustcolor('white',alpha=0.4),xlim=c(min,max),col=adjustcolor(sp_cols[1,1],alpha=0.4),main='Chinook',breaks=50,freq=T,xlab='',yaxt='n',ylab='')
abline(v=median(glob.alpha.chk),col=adjustcolor(sp_cols[1,1],alpha=0.8))
ticksat <- seq(0,3,by=0.1)
axis(1, ticksat, col="black", labels=NA,
     tcl=-0.2, lwd=0, lwd.ticks=1)
ticksat <- seq(0,3,by=0.5)
axis(1, ticksat, col="black", labels=NA,
     tcl=-0.5, lwd=0, lwd.ticks=1)
hist(as.vector(glob.alpha.scy),border=adjustcolor('white',alpha=0.4),xlim=c(min,max),col=adjustcolor(sp_cols[5,1],alpha=0.4),main='Sockeye',breaks=50,freq=T,xlab='',yaxt='n',ylab='')
abline(v=median(glob.alpha.scy),col=adjustcolor(sp_cols[5,1],alpha=0.8))
ticksat <- seq(0,3,by=0.1)
axis(1, ticksat, col="black", labels=NA,
     tcl=-0.2, lwd=0, lwd.ticks=1)
ticksat <- seq(0,3,by=0.5)
axis(1, ticksat, col="black", labels=NA,
     tcl=-0.5, lwd=0, lwd.ticks=1)
hist(as.vector(glob.alpha.chm),border=adjustcolor('white',alpha=0.4),xlim=c(min,max),col=adjustcolor(sp_cols[2,1],alpha=0.4),main='Chum',breaks=50,freq=T,xlab='',yaxt='n',ylab='')
abline(v=median(glob.alpha.chm),col=adjustcolor(sp_cols[2,1],alpha=0.8))
ticksat <- seq(0,3,by=0.1)
axis(1, ticksat, col="black", labels=NA,
     tcl=-0.2, lwd=0, lwd.ticks=1)
ticksat <- seq(0,3,by=0.5)
axis(1, ticksat, col="black", labels=NA,
     tcl=-0.5, lwd=0, lwd.ticks=1)

hist(as.vector(glob.alpha.cho),border=adjustcolor('white',alpha=0.4),xlim=c(min,max),col=adjustcolor(sp_cols[3,1],alpha=0.4),main='Coho',breaks=50,freq=T,xlab='',yaxt='n',ylab='')
abline(v=median(glob.alpha.cho),col=adjustcolor(sp_cols[2,1],alpha=0.8))
ticksat <- seq(0,3,by=0.1)
axis(1, ticksat, col="black", labels=NA,
     tcl=-0.2, lwd=0, lwd.ticks=1)
ticksat <- seq(0,3,by=0.5)
axis(1, ticksat, col="black", labels=NA,
     tcl=-0.5, lwd=0, lwd.ticks=1)

hist(as.vector(glob.alpha.pke),border=adjustcolor('white',alpha=0.4),xlim=c(min,max),col=adjustcolor(sp_cols[4,1],alpha=0.4),main='Pink - Even',breaks=50,freq=T,xlab=expression(paste('log(',alpha,')')),yaxt='n',ylab='',cex.lab=1.4)
abline(v=median(glob.alpha.pke),col=adjustcolor(sp_cols[4,1],alpha=0.8))
ticksat <- seq(0,3,by=0.1)
axis(1, ticksat, col="black", labels=NA,
     tcl=-0.2, lwd=0, lwd.ticks=1)
ticksat <- seq(0,3,by=0.5)
axis(1, ticksat, col="black", labels=NA,
     tcl=-0.5, lwd=0, lwd.ticks=1)

hist(as.vector(glob.alpha.pko),border=adjustcolor('white',alpha=0.4),xlim=c(min,max),col=adjustcolor(sp_cols[4,1],alpha=0.4),main='Pink - Odd',breaks=50,freq=T,xlab=expression(paste('log(',alpha,')')),yaxt='n',ylab='',cex.lab=1.4)
abline(v=median(glob.alpha.pko),col=adjustcolor(sp_cols[4,1],alpha=0.8))
ticksat <- seq(0,3,by=0.1)
axis(1, ticksat, col="black", labels=NA,
     tcl=-0.2, lwd=0, lwd.ticks=1)
ticksat <- seq(0,3,by=0.5)
axis(1, ticksat, col="black", labels=NA,
     tcl=-0.5, lwd=0, lwd.ticks=1)
```


###Large Marine Ecosystem

Posterior estimates of mean productivity for each Large Marine Ecosystem (N = 4 total) and species. Vertical lines indicate medians for each region.
```{r, LME log a}
lme.alpha.chk=stc.chk$draws(variable='log_a_or',format='draws_matrix')
lme.alpha.chm=stc.chm$draws(variable='log_a_or',format='draws_matrix')
lme.alpha.cho=stc.cho$draws(variable='log_a_or',format='draws_matrix')
lme.alpha.pke=stc.pke$draws(variable='log_a_or',format='draws_matrix')
lme.alpha.pko=stc.pko$draws(variable='log_a_or',format='draws_matrix')
lme.alpha.scy=stc.scy$draws(variable='log_a_or',format='draws_matrix')

par(mfrow=c(3,2))
par(mar=c(4,5,3,1))

g4=density(lme.alpha.chk[,4],bw=0.03)
g3=density(lme.alpha.chk[,3],bw=0.03)
g2=density(lme.alpha.chk[,2],bw=0.03)
g1=density(lme.alpha.chk[,1],bw=0.03)

ymax=3

plot(g4$y~g4$x,type='l',bty='n',col=basin_cols[4,1],yaxt='n',ylab='',lwd=3,xlab='',main='Chinook',ylim=c(0,ymax),xlim=c(0,3))
lines(g3$y~g3$x,lwd=3,col=basin_cols[3,1])
lines(g2$y~g2$x,lwd=3,col=basin_cols[2,1])
lines(g1$y~g1$x,lwd=3,col=basin_cols[1,1])
abline(v=median(lme.alpha.chk[,4]),col=adjustcolor(basin_cols[4,1],alpha=0.95),lwd=2)
abline(v=median(lme.alpha.chk[,3]),col=adjustcolor(basin_cols[3,1],alpha=0.95),lwd=2)
abline(v=median(lme.alpha.chk[,2]),col=adjustcolor(basin_cols[2,1],alpha=0.95),lwd=2)
abline(v=median(lme.alpha.chk[,1]),col=adjustcolor(basin_cols[1,1],alpha=0.95),lwd=2)
ticksat <- seq(0,3,by=0.1)
axis(1, ticksat, col="black", labels=NA,
     tcl=-0.2, lwd=0, lwd.ticks=1)
ticksat <- seq(0,3,by=0.5)
axis(1, ticksat, col="black", labels=NA,
     tcl=-0.5, lwd=0, lwd.ticks=1)

text(x=2.9,y=par('usr')[4]-0.25,'BS',col=basin_cols[1,1],cex=1.5)
text(x=2.9,y=par('usr')[4]-0.5,'GOA',col=basin_cols[2,1],cex=1.5)
text(x=2.9,y=par('usr')[4]-0.75,'SEAK',col=basin_cols[3,1],cex=1.5)
text(x=2.9,y=par('usr')[4]-1,'WC',col=basin_cols[4,1],cex=1.5)


g4=density(lme.alpha.scy[,4],bw=0.03)
g3=density(lme.alpha.scy[,3],bw=0.03)
g2=density(lme.alpha.scy[,2],bw=0.03)
g1=density(lme.alpha.scy[,1],bw=0.03)

ymax=max(c(g4$y,g3$y,g2$y,g1$y))

plot(g4$y~g4$x,type='l',bty='n',col=basin_cols[4,1],yaxt='n',ylab='',lwd=3,xlab='',main='Sockeye',ylim=c(0,ymax),xlim=c(0,3))
lines(g3$y~g3$x,lwd=3,col=basin_cols[3,1])
lines(g2$y~g2$x,lwd=3,col=basin_cols[2,1])
lines(g1$y~g1$x,lwd=3,col=basin_cols[1,1])
abline(v=median(lme.alpha.scy[,4]),col=adjustcolor(basin_cols[4,1],alpha=0.95),lwd=2)
abline(v=median(lme.alpha.scy[,3]),col=adjustcolor(basin_cols[3,1],alpha=0.95),lwd=2)
abline(v=median(lme.alpha.scy[,2]),col=adjustcolor(basin_cols[2,1],alpha=0.95),lwd=2)
abline(v=median(lme.alpha.scy[,1]),col=adjustcolor(basin_cols[1,1],alpha=0.95),lwd=2)
ticksat <- seq(0,3,by=0.1)
axis(1, ticksat, col="black", labels=NA,
     tcl=-0.2, lwd=0, lwd.ticks=1)
ticksat <- seq(0,3,by=0.5)
axis(1, ticksat, col="black", labels=NA,
     tcl=-0.5, lwd=0, lwd.ticks=1)

g4=density(lme.alpha.chm[,4],bw=0.03)
g3=density(lme.alpha.chm[,3],bw=0.03)
g2=density(lme.alpha.chm[,2],bw=0.03)
g1=density(lme.alpha.chm[,1],bw=0.03)

ymax=max(c(g4$y,g3$y,g2$y,g1$y))

plot(g4$y~g4$x,type='l',bty='n',col=basin_cols[4,1],yaxt='n',ylab='',lwd=3,xlab='',main='Chum',ylim=c(0,ymax),xlim=c(0,3))
lines(g3$y~g3$x,lwd=3,col=basin_cols[3,1])
lines(g2$y~g2$x,lwd=3,col=basin_cols[2,1])
lines(g1$y~g1$x,lwd=3,col=basin_cols[1,1])
abline(v=median(lme.alpha.chm[,4]),col=adjustcolor(basin_cols[4,1],alpha=0.95),lwd=2)
abline(v=median(lme.alpha.chm[,2]),col=adjustcolor(basin_cols[2,1],alpha=0.95),lwd=2)
abline(v=median(lme.alpha.chm[,1]),col=adjustcolor(basin_cols[1,1],alpha=0.95),lwd=2)
ticksat <- seq(0,3,by=0.1)
axis(1, ticksat, col="black", labels=NA,
     tcl=-0.2, lwd=0, lwd.ticks=1)
ticksat <- seq(0,3,by=0.5)
axis(1, ticksat, col="black", labels=NA,
     tcl=-0.5, lwd=0, lwd.ticks=1)



g3=density(lme.alpha.cho[,3],bw=0.03)
g2=density(lme.alpha.cho[,2],bw=0.03)
g1=density(lme.alpha.cho[,1],bw=0.03)

ymax=max(c(g3$y,g2$y,g1$y))

plot(g3$y~g3$x,type='l',bty='n',col=basin_cols[4,1],yaxt='n',ylab='',lwd=3,xlab='',main='Coho',ylim=c(0,ymax),xlim=c(0,3))
lines(g2$y~g2$x,lwd=3,col=basin_cols[3,1])
lines(g1$y~g1$x,lwd=3,col=basin_cols[2,1])
abline(v=median(lme.alpha.cho[,3]),col=adjustcolor(basin_cols[4,1],alpha=0.95),lwd=2)
abline(v=median(lme.alpha.cho[,2]),col=adjustcolor(basin_cols[3,1],alpha=0.95),lwd=2)
abline(v=median(lme.alpha.cho[,1]),col=adjustcolor(basin_cols[2,1],alpha=0.95),lwd=2)
ticksat <- seq(0,3,by=0.1)
axis(1, ticksat, col="black", labels=NA,
     tcl=-0.2, lwd=0, lwd.ticks=1)
ticksat <- seq(0,3,by=0.5)
axis(1, ticksat, col="black", labels=NA,
     tcl=-0.5, lwd=0, lwd.ticks=1)

g4=density(lme.alpha.pke[,4],bw=0.03)
g3=density(lme.alpha.pke[,3],bw=0.03)
g2=density(lme.alpha.pke[,2],bw=0.03)
g1=density(lme.alpha.pke[,1],bw=0.03)

ymax=max(c(g4$y,g3$y,g2$y,g1$y))

plot(g4$y~g4$x,type='l',bty='n',col=basin_cols[4,1],yaxt='n',ylab='',lwd=3,xlab=expression(paste('log(',alpha,')')),main='Pink (even)',ylim=c(0,ymax),xlim=c(0,3),cex.lab=1.4)
lines(g3$y~g3$x,lwd=3,col=basin_cols[3,1])
lines(g2$y~g2$x,lwd=3,col=basin_cols[2,1])
lines(g1$y~g1$x,lwd=3,col=basin_cols[1,1])
abline(v=median(lme.alpha.pke[,4]),col=adjustcolor(basin_cols[4,1],alpha=0.95),lwd=2)
abline(v=median(lme.alpha.pke[,3]),col=adjustcolor(basin_cols[3,1],alpha=0.95),lwd=2)
abline(v=median(lme.alpha.pke[,2]),col=adjustcolor(basin_cols[2,1],alpha=0.95),lwd=2)
abline(v=median(lme.alpha.pke[,1]),col=adjustcolor(basin_cols[1,1],alpha=0.95),lwd=2)
ticksat <- seq(0,3,by=0.1)
axis(1, ticksat, col="black", labels=NA,
     tcl=-0.2, lwd=0, lwd.ticks=1)
ticksat <- seq(0,3,by=0.5)
axis(1, ticksat, col="black", labels=NA,
     tcl=-0.5, lwd=0, lwd.ticks=1)

g4=density(lme.alpha.pko[,4],bw=0.03)
g3=density(lme.alpha.pko[,3],bw=0.03)
g2=density(lme.alpha.pko[,2],bw=0.03)
g1=density(lme.alpha.pko[,1],bw=0.03)

ymax=max(c(g4$y,g3$y,g2$y,g1$y))

plot(g4$y~g4$x,type='l',bty='n',col=basin_cols[4,1],yaxt='n',ylab='',lwd=3,xlab=expression(paste('log(',alpha,')')),main='Pink (odd)',ylim=c(0,ymax),xlim=c(0,3),cex.lab=1.4)
lines(g3$y~g3$x,lwd=3,col=basin_cols[3,1])
lines(g2$y~g2$x,lwd=3,col=basin_cols[2,1])
lines(g1$y~g1$x,lwd=3,col=basin_cols[1,1])
abline(v=median(lme.alpha.pko[,4]),col=adjustcolor(basin_cols[4,1],alpha=0.95),lwd=2)
abline(v=median(lme.alpha.pko[,3]),col=adjustcolor(basin_cols[3,1],alpha=0.95),lwd=2)
abline(v=median(lme.alpha.pko[,2]),col=adjustcolor(basin_cols[2,1],alpha=0.95),lwd=2)
abline(v=median(lme.alpha.pko[,1]),col=adjustcolor(basin_cols[1,1],alpha=0.95),lwd=2)
ticksat <- seq(0,3,by=0.1)
axis(1, ticksat, col="black", labels=NA,
     tcl=-0.2, lwd=0, lwd.ticks=1)
ticksat <- seq(0,3,by=0.5)
axis(1, ticksat, col="black", labels=NA,
     tcl=-0.5, lwd=0, lwd.ticks=1)
```

###Sub-Region

Mean productivity estimated for each sub-region, representing either large watersheds or coastal regions, for each species. Vertical lines indicate the posterior median value and numbers in parenthesis indicate stock sample size for that species in the sub-region.

```{r, subregion log a}

sr.alpha.chk=stc.chk$draws(variable='log_a_sr',format='draws_matrix')
sr.alpha.chm=stc.chm$draws(variable='log_a_sr',format='draws_matrix')
sr.alpha.cho=stc.cho$draws(variable='log_a_sr',format='draws_matrix')
sr.alpha.pke=stc.pke$draws(variable='log_a_sr',format='draws_matrix')
sr.alpha.pko=stc.pko$draws(variable='log_a_sr',format='draws_matrix')
sr.alpha.scy=stc.scy$draws(variable='log_a_sr',format='draws_matrix')
```

#### Chinook 
```{r, subregion chk}

###chinook####
srs.chk=levels(factor(chk.info$region))
n.chk=chk.info %>%group_by(region)%>%summarize(n=n())

min=0
max=3

par(mfrow=c(5,3))
par(mar=c(4,5,3,1))
for(i in 1:length(srs.chk)){
if(i>=12){
  hist(sr.alpha.chk[,i],border=adjustcolor('white',alpha=0.4),xlim=c(min,max),col=adjustcolor(sp_cols[1,1],alpha=0.4),breaks=50,freq=T,main=paste(srs.chk[i],' (',n.chk$n[i],')',sep=''),xlab=expression(paste('log(',alpha,')')),yaxt='n',ylab='')
abline(v=median(sr.alpha.chk[,i]),col=adjustcolor(sp_cols[1,1],alpha=0.8))
ticksat <- seq(0,3,by=0.1)
axis(1, ticksat, col="black", labels=NA,
     tcl=-0.2, lwd=0, lwd.ticks=1)
ticksat <- seq(0,3,by=0.5)
axis(1, ticksat, col="black", labels=NA,
     tcl=-0.5, lwd=0, lwd.ticks=1)
}else{
  hist(sr.alpha.chk[,i],border=adjustcolor('white',alpha=0.4),xlim=c(min,max),col=adjustcolor(sp_cols[1,1],alpha=0.4),breaks=50,freq=T,main=paste(srs.chk[i],' (',n.chk$n[i],')',sep=''),xlab='',yaxt='n',ylab='')
abline(v=median(sr.alpha.chk[,i]),col=adjustcolor(sp_cols[1,1],alpha=0.8))
ticksat <- seq(0,3,by=0.1)
axis(1, ticksat, col="black", labels=NA,
     tcl=-0.2, lwd=0, lwd.ticks=1)
ticksat <- seq(0,3,by=0.5)
axis(1, ticksat, col="black", labels=NA,
     tcl=-0.5, lwd=0, lwd.ticks=1)
}  
}
```

####Sockeye

```{r, subregion scy}
srs.scy=levels(factor(scy.info$region))
n.scy=scy.info %>%group_by(region)%>%summarize(n=n())

min=0
max=3

par(mfrow=c(5,3))
par(mar=c(4,5,3,1))
for(i in 1:length(srs.scy)){
if(i>=12){
  hist(sr.alpha.scy[,i],border=adjustcolor('white',alpha=0.4),xlim=c(min,max),col=adjustcolor(sp_cols[5,1],alpha=0.4),breaks=50,freq=T,main=paste(srs.scy[i],' (',n.scy$n[i],')',sep=''),xlab=expression(paste('log(',alpha,')')),yaxt='n',ylab='')
abline(v=median(sr.alpha.scy[,i]),col=adjustcolor(sp_cols[5,1],alpha=0.8))
ticksat <- seq(0,3,by=0.1)
axis(1, ticksat, col="black", labels=NA,
     tcl=-0.2, lwd=0, lwd.ticks=1)
ticksat <- seq(0,3,by=0.5)
axis(1, ticksat, col="black", labels=NA,
     tcl=-0.5, lwd=0, lwd.ticks=1)
}else{
  hist(sr.alpha.scy[,i],border=adjustcolor('white',alpha=0.4),xlim=c(min,max),col=adjustcolor(sp_cols[5,1],alpha=0.4),breaks=50,freq=T,main=paste(srs.scy[i],' (',n.scy$n[i],')',sep=''),xlab='',yaxt='n',ylab='')
abline(v=median(sr.alpha.scy[,i]),col=adjustcolor(sp_cols[5,1],alpha=0.8))
ticksat <- seq(0,3,by=0.1)
axis(1, ticksat, col="black", labels=NA,
     tcl=-0.2, lwd=0, lwd.ticks=1)
ticksat <- seq(0,3,by=0.5)
axis(1, ticksat, col="black", labels=NA,
     tcl=-0.5, lwd=0, lwd.ticks=1)
}  
}
```

####Chum

```{r, subregion chm}
srs.chm=levels(factor(chm.info$region))
n.chm=chm.info %>%group_by(region)%>%summarize(n=n())

min=0
max=3

par(mfrow=c(5,3))
par(mar=c(4,5,3,1))
for(i in 1:length(srs.chm)){
if(i>=12){
  hist(sr.alpha.chm[,i],border=adjustcolor('white',alpha=0.4),xlim=c(min,max),col=adjustcolor(sp_cols[2,1],alpha=0.4),breaks=50,freq=T,main=paste(srs.chm[i],' (',n.chm$n[i],')',sep=''),xlab=expression(paste('log(',alpha,')')),yaxt='n',ylab='')
abline(v=median(sr.alpha.chm[,i]),col=adjustcolor(sp_cols[2,1],alpha=0.8))
ticksat <- seq(0,3,by=0.1)
axis(1, ticksat, col="black", labels=NA,
     tcl=-0.2, lwd=0, lwd.ticks=1)
ticksat <- seq(0,3,by=0.5)
axis(1, ticksat, col="black", labels=NA,
     tcl=-0.5, lwd=0, lwd.ticks=1)
}else{
  hist(sr.alpha.chm[,i],border=adjustcolor('white',alpha=0.4),xlim=c(min,max),col=adjustcolor(sp_cols[2,1],alpha=0.4),breaks=50,freq=T,main=paste(srs.chm[i],' (',n.chm$n[i],')',sep=''),xlab='',yaxt='n',ylab='')
abline(v=median(sr.alpha.chm[,i]),col=adjustcolor(sp_cols[2,1],alpha=0.8))
ticksat <- seq(0,3,by=0.1)
axis(1, ticksat, col="black", labels=NA,
     tcl=-0.2, lwd=0, lwd.ticks=1)
ticksat <- seq(0,3,by=0.5)
axis(1, ticksat, col="black", labels=NA,
     tcl=-0.5, lwd=0, lwd.ticks=1)
}  
}
```

####Coho
```{r, subregion cho}
srs.cho=levels(factor(cho.info$region))
n.cho=cho.info %>%group_by(region)%>%summarize(n=n())

min=0
max=3

par(mfrow=c(5,3))
par(mar=c(4,5,3,1))
for(i in 1:length(srs.cho)){
if(i>=12){
  hist(sr.alpha.cho[,i],border=adjustcolor('white',alpha=0.4),xlim=c(min,max),col=adjustcolor(sp_cols[3,1],alpha=0.4),breaks=50,freq=T,main=paste(srs.cho[i],' (',n.cho$n[i],')',sep=''),xlab=expression(paste('log(',alpha,')')),yaxt='n',ylab='')
abline(v=median(sr.alpha.cho[,i]),col=adjustcolor(sp_cols[3,1],alpha=0.8))
ticksat <- seq(0,3,by=0.1)
axis(1, ticksat, col="black", labels=NA,
     tcl=-0.2, lwd=0, lwd.ticks=1)
ticksat <- seq(0,3,by=0.5)
axis(1, ticksat, col="black", labels=NA,
     tcl=-0.5, lwd=0, lwd.ticks=1)
}else{
  hist(sr.alpha.cho[,i],border=adjustcolor('white',alpha=0.4),xlim=c(min,max),col=adjustcolor(sp_cols[3,1],alpha=0.4),breaks=50,freq=T,main=paste(srs.cho[i],' (',n.cho$n[i],')',sep=''),xlab='',yaxt='n',ylab='')
abline(v=median(sr.alpha.cho[,i]),col=adjustcolor(sp_cols[3,1],alpha=0.8))
ticksat <- seq(0,3,by=0.1)
axis(1, ticksat, col="black", labels=NA,
     tcl=-0.2, lwd=0, lwd.ticks=1)
ticksat <- seq(0,3,by=0.5)
axis(1, ticksat, col="black", labels=NA,
     tcl=-0.5, lwd=0, lwd.ticks=1)
}  
}
```

####Pink - Even
```{r, subregion pke}
srs.pke=levels(factor(pke.info$region))
n.pke=pke.info %>%group_by(region)%>%summarize(n=n())

min=0
max=3

par(mfrow=c(5,3))
par(mar=c(4,5,3,1))
for(i in 1:length(srs.pke)){
if(i>=12){
  hist(sr.alpha.pke[,i],border=adjustcolor('white',alpha=0.4),xlim=c(min,max),col=adjustcolor(sp_cols[4,1],alpha=0.4),breaks=50,freq=T,main=paste(srs.pke[i],' (',n.pke$n[i],')',sep=''),xlab=expression(paste('log(',alpha,')')),yaxt='n',ylab='')
abline(v=median(sr.alpha.pke[,i]),col=adjustcolor(sp_cols[4,1],alpha=0.8))
ticksat <- seq(0,3,by=0.1)
axis(1, ticksat, col="black", labels=NA,
     tcl=-0.2, lwd=0, lwd.ticks=1)
ticksat <- seq(0,3,by=0.5)
axis(1, ticksat, col="black", labels=NA,
     tcl=-0.5, lwd=0, lwd.ticks=1)
}else{
  hist(sr.alpha.pke[,i],border=adjustcolor('white',alpha=0.4),xlim=c(min,max),col=adjustcolor(sp_cols[4,1],alpha=0.4),breaks=50,freq=T,main=paste(srs.pke[i],' (',n.pke$n[i],')',sep=''),xlab='',yaxt='n',ylab='')
abline(v=median(sr.alpha.pke[,i]),col=adjustcolor(sp_cols[4,1],alpha=0.8))
ticksat <- seq(0,3,by=0.1)
axis(1, ticksat, col="black", labels=NA,
     tcl=-0.2, lwd=0, lwd.ticks=1)
ticksat <- seq(0,3,by=0.5)
axis(1, ticksat, col="black", labels=NA,
     tcl=-0.5, lwd=0, lwd.ticks=1)
}  
}
```

####Pink - Odd
```{r, subregion pko}
srs.pko=levels(factor(pko.info$region))
n.pko=pko.info %>%group_by(region)%>%summarize(n=n())

min=0
max=3

par(mfrow=c(5,3))
par(mar=c(4,5,3,1))
for(i in 1:length(srs.pko)){
if(i>=12){
  hist(sr.alpha.pko[,i],border=adjustcolor('white',alpha=0.4),xlim=c(min,max),col=adjustcolor(sp_cols[4,1],alpha=0.4),breaks=50,freq=T,main=paste(srs.pko[i],' (',n.pko$n[i],')',sep=''),xlab=expression(paste('log(',alpha,')')),yaxt='n',ylab='')
abline(v=median(sr.alpha.pko[,i]),col=adjustcolor(sp_cols[4,1],alpha=0.8))
ticksat <- seq(0,3,by=0.1)
axis(1, ticksat, col="black", labels=NA,
     tcl=-0.2, lwd=0, lwd.ticks=1)
ticksat <- seq(0,3,by=0.5)
axis(1, ticksat, col="black", labels=NA,
     tcl=-0.5, lwd=0, lwd.ticks=1)
}else{
  hist(sr.alpha.pko[,i],border=adjustcolor('white',alpha=0.4),xlim=c(min,max),col=adjustcolor(sp_cols[4,1],alpha=0.4),breaks=50,freq=T,main=paste(srs.pko[i],' (',n.pko$n[i],')',sep=''),xlab='',yaxt='n',ylab='')
abline(v=median(sr.alpha.pko[,i]),col=adjustcolor(sp_cols[4,1],alpha=0.8))
ticksat <- seq(0,3,by=0.1)
axis(1, ticksat, col="black", labels=NA,
     tcl=-0.2, lwd=0, lwd.ticks=1)
ticksat <- seq(0,3,by=0.5)
axis(1, ticksat, col="black", labels=NA,
     tcl=-0.5, lwd=0, lwd.ticks=1)
}  
}
```


## Smax (Capacity)

Posterior distribution of $Smax$, spawners where total recruits is maximized (1/$beta$), for all stocks of each species. Darker bars indicate the distribution of median estimates among all stocks.

```{r, smax}
smax.chk=stc.chk$draws(variable='Smax',format='draws_matrix')
smax.chm=stc.chm$draws(variable='Smax',format='draws_matrix')
smax.cho=stc.cho$draws(variable='Smax',format='draws_matrix')
smax.pke=stc.pke$draws(variable='Smax',format='draws_matrix')
smax.pko=stc.pko$draws(variable='Smax',format='draws_matrix')
smax.scy=stc.scy$draws(variable='Smax',format='draws_matrix')

par(mfrow=c(3,2))
par(mar=c(3,5,3,1))
ymax=max(hist(apply(log10(smax.scy),2,median),plot=FALSE)$counts)

hist(as.vector(log10(smax.chk)),border=adjustcolor('white',alpha=0.4),xlim=c(0,8),col=adjustcolor(sp_cols[1,1],alpha=0.4),breaks=seq(0,20,by=0.1),freq=T,main='Chinook',xlab='',yaxt='n',ylab='',xaxt='n')
pow <- 0:7
ticksat <- as.vector(sapply(pow, function(p) (1:10)*10^p))
axis(1, log10(ticksat), col="black", labels=NA,
     tcl=-0.2, lwd=0, lwd.ticks=1)
axis(1, col="black", at=seq(0,8,by=1),   tcl=-0.45, cex.axis=1.2,
     labels=c(expression(1),expression(10),expression(100),expression('1K'),expression('10K'),expression('100K'),expression('1M'),expression('10M'),expression('100M')))
par(new=T)
hist(apply(log10(smax.chk),2,median),border=adjustcolor('white',alpha=0.4),xlim=c(0,8),ylim=c(0,ymax*0.5),col=adjustcolor(sp_cols[1,1],alpha=0.8),breaks=seq(0,20,by=0.05),freq=T,main='Chinook',xlab='',yaxt='n',ylab='',xaxt='n')


hist(as.vector(log10(smax.scy)),border=adjustcolor('white',alpha=0.4),xlim=c(0,8),col=adjustcolor(sp_cols[5,1],alpha=0.4),breaks=seq(0,20,by=0.1),freq=T,main='Sockeye',xlab='',yaxt='n',ylab='',xaxt='n')
pow <- 0:7
ticksat <- as.vector(sapply(pow, function(p) (1:10)*10^p))
axis(1, log10(ticksat), col="black", labels=NA,
     tcl=-0.2, lwd=0, lwd.ticks=1)
axis(1, col="black", at=seq(0,8,by=1),   tcl=-0.45, cex.axis=1.2,
     labels=c(expression(1),expression(10),expression(100),expression('1K'),expression('10K'),expression('100K'),expression('1M'),expression('10M'),expression('100M')))
par(new=T)
hist(apply(log10(smax.scy),2,median),border=adjustcolor('white',alpha=0.4),xlim=c(0,8),ylim=c(0,ymax*0.5),col=adjustcolor(sp_cols[5,1],alpha=0.8),breaks=seq(0,20,by=0.05),freq=T,main='',xlab='',yaxt='n',ylab='',xaxt='n')


hist(as.vector(log10(smax.chm)),border=adjustcolor('white',alpha=0.4),xlim=c(0,max(log10(smax.chm))),col=adjustcolor(sp_cols[2,1],alpha=0.4),breaks=seq(0,20,by=0.1),freq=T,main='Chum',xlab='',yaxt='n',ylab='',xaxt='n')
pow <- 0:7
ticksat <- as.vector(sapply(pow, function(p) (1:10)*10^p))
axis(1, log10(ticksat), col="black", labels=NA,
     tcl=-0.2, lwd=0, lwd.ticks=1)
axis(1, col="black", at=seq(0,8,by=1),   tcl=-0.45, cex.axis=1.2,
     labels=c(expression(1),expression(10),expression(100),expression('1K'),expression('10K'),expression('100K'),expression('1M'),expression('10M'),expression('100M')))
par(new=T)
hist(apply(log10(smax.chm),2,median),border=adjustcolor('white',alpha=0.4),xlim=c(0,8),ylim=c(0,ymax*0.5),col=adjustcolor(sp_cols[2,1],alpha=0.8),breaks=seq(0,20,by=0.05),freq=T,main='',xlab='',yaxt='n',ylab='',xaxt='n')

hist(as.vector(log10(smax.cho)),border=adjustcolor('white',alpha=0.4),xlim=c(0,8),col=adjustcolor(sp_cols[3,1],alpha=0.4),breaks=seq(0,20,by=0.1),freq=T,main='Coho',xlab='',yaxt='n',ylab='',xaxt='n')
ticksat <- as.vector(sapply(pow, function(p) (1:10)*10^p))
axis(1, log10(ticksat), col="black", labels=NA,
     tcl=-0.2, lwd=0, lwd.ticks=1)
axis(1, col="black", at=seq(0,8,by=1),   tcl=-0.45, cex.axis=1.2,
     labels=c(expression(1),expression(10),expression(100),expression('1K'),expression('10K'),expression('100K'),expression('1M'),expression('10M'),expression('100M')))
par(new=T)
hist(apply(log10(smax.cho),2,median),border=adjustcolor('white',alpha=0.4),xlim=c(0,8),ylim=c(0,ymax*0.5),col=adjustcolor(sp_cols[3,1],alpha=0.8),breaks=seq(0,20,by=0.05),freq=T,main='',xlab='',yaxt='n',ylab='',xaxt='n')

par(mar=c(5,5,3,1))
hist(as.vector(log10(smax.pke)),border=adjustcolor('white',alpha=0.4),xlim=c(0,8),col=adjustcolor(sp_cols[4,1],alpha=0.4),breaks=seq(0,20,by=0.1),freq=T,main='Pink-Even',xlab='Capacity (Smax)',yaxt='n',ylab='',xaxt='n',cex.lab=1.5)
ticksat <- as.vector(sapply(pow, function(p) (1:10)*10^p))
axis(1, log10(ticksat), col="black", labels=NA,
     tcl=-0.2, lwd=0, lwd.ticks=1)
axis(1, col="black", at=seq(0,8,by=1),   tcl=-0.45, cex.axis=1.2,
     labels=c(expression(1),expression(10),expression(100),expression('1K'),expression('10K'),expression('100K'),expression('1M'),expression('10M'),expression('100M')))
par(new=T)
hist(apply(log10(smax.pke),2,median),border=adjustcolor('white',alpha=0.4),xlim=c(0,8),ylim=c(0,ymax*0.5),col=adjustcolor(sp_cols[4,1],alpha=0.8),breaks=seq(0,20,by=0.05),freq=T,main='',xlab='',yaxt='n',ylab='',xaxt='n')

hist(as.vector(log10(smax.pko)),border=adjustcolor('white',alpha=0.4),xlim=c(0,8),col=adjustcolor(sp_cols[4,1],alpha=0.4),breaks=seq(0,20,by=0.1),freq=T,main='Pink-Odd',xlab='Capacity (Smax)',yaxt='n',ylab='',xaxt='n',cex.lab=1.5)
ticksat <- as.vector(sapply(pow, function(p) (1:10)*10^p))
axis(1, log10(ticksat), col="black", labels=NA,
     tcl=-0.2, lwd=0, lwd.ticks=1)
axis(1, col="black", at=seq(0,8,by=1),   tcl=-0.45, cex.axis=1.2,
     labels=c(expression(1),expression(10),expression(100),expression('1K'),expression('10K'),expression('100K'),expression('1M'),expression('10M'),expression('100M')))
par(new=T)
hist(apply(log10(smax.pko),2,median),border=adjustcolor('white',alpha=0.4),xlim=c(0,8),ylim=c(0,ymax*0.5),col=adjustcolor(sp_cols[4,1],alpha=0.8),breaks=seq(0,20,by=0.05),freq=T,main='',xlab='',yaxt='n',ylab='',xaxt='n')


```

## Smsy

Posterior distribution of $Smsy$, spawners where maximum sustainable yield would be achieved, for all stocks of each species. Darker bars indicate the distribution of median estimates among all stocks.

```{r, smsy}
smsy.chk=stc.chk$draws(variable='Smsy',format='draws_matrix')
smsy.chm=stc.chm$draws(variable='Smsy',format='draws_matrix')
smsy.cho=stc.cho$draws(variable='Smsy',format='draws_matrix')
smsy.pke=stc.pke$draws(variable='Smsy',format='draws_matrix')
smsy.pko=stc.pko$draws(variable='Smsy',format='draws_matrix')
smsy.scy=stc.scy$draws(variable='Smsy',format='draws_matrix')

#set negative values to 0
smsy.chk=apply(smsy.chk,1:2,function(x){ifelse(x<1,NA,x)})
ymax=max(hist(apply(log10(na.omit(smsy.scy)),2,median),plot=FALSE)$counts)

par(mfrow=c(3,2))
par(mar=c(3,5,3,1))
hist(as.vector(log10(na.omit(smsy.chk))),border=adjustcolor('white',alpha=0.4),xlim=c(0,8),col=adjustcolor(sp_cols[1,1],alpha=0.4),breaks=seq(0,20,by=0.1),freq=T,main='Chinook',xlab='',yaxt='n',ylab='',xaxt='n')
pow <- 0:7
ticksat <- as.vector(sapply(pow, function(p) (1:10)*10^p))
axis(1, log10(ticksat), col="black", labels=NA,
     tcl=-0.2, lwd=0, lwd.ticks=1)
axis(1, col="black", at=seq(0,8,by=1),   tcl=-0.45, cex.axis=1.2,
     labels=c(expression(1),expression(10),expression(100),expression('1K'),expression('10K'),expression('100K'),expression('1M'),expression('10M'),expression('100M')))
par(new=T)
hist(apply(log10(na.omit(smsy.chk)),2,median),border=adjustcolor('white',alpha=0.4),xlim=c(0,8),ylim=c(0,ymax*0.5),col=adjustcolor(sp_cols[1,1],alpha=0.8),breaks=seq(0,20,by=0.05),freq=T,main='Chinook',xlab='',yaxt='n',ylab='',xaxt='n')

smsy.scy=apply(smsy.scy,1:2,function(x){ifelse(x<1,NA,x)})

hist(as.vector(log10(na.omit(smsy.scy))),border=adjustcolor('white',alpha=0.4),xlim=c(0,8),col=adjustcolor(sp_cols[5,1],alpha=0.4),breaks=seq(0,20,by=0.1),freq=T,main='Sockeye',xlab='',yaxt='n',ylab='',xaxt='n')
pow <- 0:7
ticksat <- as.vector(sapply(pow, function(p) (1:10)*10^p))
axis(1, log10(ticksat), col="black", labels=NA,
     tcl=-0.2, lwd=0, lwd.ticks=1)
axis(1, col="black", at=seq(0,8,by=1),   tcl=-0.45, cex.axis=1.2,
     labels=c(expression(1),expression(10),expression(100),expression('1K'),expression('10K'),expression('100K'),expression('1M'),expression('10M'),expression('100M')))
par(new=T)
hist(apply(log10(na.omit(smsy.scy)),2,median),border=adjustcolor('white',alpha=0.4),xlim=c(0,8),ylim=c(0,ymax*0.5),col=adjustcolor(sp_cols[5,1],alpha=0.8),breaks=seq(0,20,by=0.05),freq=T,main='',xlab='',yaxt='n',ylab='',xaxt='n')

smsy.chm=apply(smsy.chm,1:2,function(x){ifelse(x<1,NA,x)})

hist(as.vector(log10(na.omit(smsy.chm))),border=adjustcolor('white',alpha=0.4),xlim=c(0,8),col=adjustcolor(sp_cols[2,1],alpha=0.4),breaks=seq(0,20,by=0.1),freq=T,main='Chum',xlab='',yaxt='n',ylab='',xaxt='n')
pow <- 0:7
ticksat <- as.vector(sapply(pow, function(p) (1:10)*10^p))
axis(1, log10(ticksat), col="black", labels=NA,
     tcl=-0.2, lwd=0, lwd.ticks=1)
axis(1, col="black", at=seq(0,8,by=1),   tcl=-0.45, cex.axis=1.2,
     labels=c(expression(1),expression(10),expression(100),expression('1K'),expression('10K'),expression('100K'),expression('1M'),expression('10M'),expression('100M')))
par(new=T)
hist(apply(log10(na.omit(smsy.chm)),2,median),border=adjustcolor('white',alpha=0.4),xlim=c(0,8),ylim=c(0,ymax*0.5),col=adjustcolor(sp_cols[2,1],alpha=0.8),breaks=seq(0,20,by=0.05),freq=T,main='',xlab='',yaxt='n',ylab='',xaxt='n')

smsy.cho=apply(smsy.cho,1:2,function(x){ifelse(x<1,NA,x)})

hist(as.vector(log10(na.omit(smsy.cho))),border=adjustcolor('white',alpha=0.4),xlim=c(0,8),col=adjustcolor(sp_cols[3,1],alpha=0.4),breaks=seq(0,20,by=0.1),freq=T,main='Chum',xlab='',yaxt='n',ylab='',xaxt='n')
pow <- 0:7
ticksat <- as.vector(sapply(pow, function(p) (1:10)*10^p))
axis(1, log10(ticksat), col="black", labels=NA,
     tcl=-0.2, lwd=0, lwd.ticks=1)
axis(1, col="black", at=seq(0,8,by=1),   tcl=-0.45, cex.axis=1.2,
     labels=c(expression(1),expression(10),expression(100),expression('1K'),expression('10K'),expression('100K'),expression('1M'),expression('10M'),expression('100M')))
par(new=T)
hist(apply(log10(na.omit(smsy.cho)),2,median),border=adjustcolor('white',alpha=0.4),xlim=c(0,8),ylim=c(0,ymax*0.5),col=adjustcolor(sp_cols[3,1],alpha=0.8),breaks=seq(0,20,by=0.05),freq=T,main='',xlab='',yaxt='n',ylab='',xaxt='n')

par(mar=c(5,5,3,1))
smsy.pke=apply(smsy.pke,1:2,function(x){ifelse(x<1,NA,x)})

hist(as.vector(log10(na.omit(smsy.pke))),border=adjustcolor('white',alpha=0.4),xlim=c(0,8),col=adjustcolor(sp_cols[4,1],alpha=0.4),breaks=seq(0,20,by=0.1),freq=T,main='Pink-Even',xlab='Smsy',yaxt='n',ylab='',xaxt='n',cex.lab=1.5)
ticksat <- as.vector(sapply(pow, function(p) (1:10)*10^p))
axis(1, log10(ticksat), col="black", labels=NA,
     tcl=-0.2, lwd=0, lwd.ticks=1)
axis(1, col="black", at=seq(0,8,by=1),   tcl=-0.45, cex.axis=1.2,
     labels=c(expression(1),expression(10),expression(100),expression('1K'),expression('10K'),expression('100K'),expression('1M'),expression('10M'),expression('100M')))
par(new=T)
hist(apply(log10(na.omit(smsy.pke)),2,median),border=adjustcolor('white',alpha=0.4),xlim=c(0,8),ylim=c(0,ymax*0.5),col=adjustcolor(sp_cols[4,1],alpha=0.8),breaks=seq(0,20,by=0.05),freq=T,main='',xlab='',yaxt='n',ylab='',xaxt='n')

smsy.pko=apply(smsy.pko,1:2,function(x){ifelse(x<1,NA,x)})

hist(as.vector(log10(na.omit(smsy.pko))),border=adjustcolor('white',alpha=0.4),xlim=c(0,8),col=adjustcolor(sp_cols[4,1],alpha=0.4),breaks=seq(0,20,by=0.1),freq=T,main='Pink-Odd',xlab='Smsy',yaxt='n',ylab='',xaxt='n',cex.lab=1.5)
ticksat <- as.vector(sapply(pow, function(p) (1:10)*10^p))
axis(1, log10(ticksat), col="black", labels=NA,
     tcl=-0.2, lwd=0, lwd.ticks=1)
axis(1, col="black", at=seq(0,8,by=1),   tcl=-0.45, cex.axis=1.2,
     labels=c(expression(1),expression(10),expression(100),expression('1K'),expression('10K'),expression('100K'),expression('1M'),expression('10M'),expression('100M')))
par(new=T)
hist(apply(log10(na.omit(smsy.pko)),2,median),border=adjustcolor('white',alpha=0.4),xlim=c(0,8),ylim=c(0,ymax*0.5),col=adjustcolor(sp_cols[4,1],alpha=0.8),breaks=seq(0,20,by=0.05),freq=T,main='',xlab='',yaxt='n',ylab='',xaxt='n')


```

## Sigma

Posterior distribution of $\sigma$, the residual deviance, for all stocks of each species. Darker bars indicate the distribution of median estimates among all stocks and black vertical lines represent the median of the entire posterior.


```{r, sigma}
glob.sigma.chk=stc.chk$draws(variable='sigma',format='draws_matrix')
glob.sigma.chm=stc.chm$draws(variable='sigma',format='draws_matrix')
glob.sigma.cho=stc.cho$draws(variable='sigma',format='draws_matrix')
glob.sigma.pke=stc.pke$draws(variable='sigma',format='draws_matrix')
glob.sigma.pko=stc.pko$draws(variable='sigma',format='draws_matrix')
glob.sigma.scy=stc.scy$draws(variable='sigma',format='draws_matrix')

par(mfrow=c(3,2))
ymax=max(hist(apply(glob.sigma.scy,2,median),plot=FALSE)$counts)

min=0
max=3
par(mar=c(3,2,3,1))
hist(as.vector(glob.sigma.chk),border=adjustcolor('white',alpha=0.4),xlim=c(min,max),col=adjustcolor(sp_cols[1,1],alpha=0.4),breaks=seq(0,20,by=0.05),freq=T,xlab='',yaxt='n',ylab='',main='Chinook')
ticksat <- seq(0,3,by=0.1)
axis(1, ticksat, col="black", labels=NA,
     tcl=-0.2, lwd=0, lwd.ticks=1)
ticksat <- seq(0,3,by=0.5)
axis(1, ticksat, col="black", labels=NA,
     tcl=-0.5, lwd=0, lwd.ticks=1)
par(new=T)
hist(apply(glob.sigma.chk,2,median),border=adjustcolor('white',alpha=0.4),xlim=c(0,max),ylim=c(0,ymax*0.5),col=adjustcolor(sp_cols[1,1],alpha=0.8),breaks=seq(0,20,by=0.025),freq=T,main='',xlab='',yaxt='n',ylab='',xaxt='n')
abline(v=median(glob.sigma.chk),col=adjustcolor('black',alpha=0.8))


hist(as.vector(glob.sigma.scy),border=adjustcolor('white',alpha=0.4),xlim=c(min,max),col=adjustcolor(sp_cols[5,1],alpha=0.4),breaks=seq(0,20,by=0.05),freq=T,main='Sockeye',xlab='',yaxt='n',ylab='')
ticksat <- seq(0,3,by=0.1)
axis(1, ticksat, col="black", labels=NA,
     tcl=-0.2, lwd=0, lwd.ticks=1)
ticksat <- seq(0,3,by=0.5)
axis(1, ticksat, col="black", labels=NA,
     tcl=-0.5, lwd=0, lwd.ticks=1)
par(new=T)
hist(apply(glob.sigma.scy,2,median),border=adjustcolor('white',alpha=0.4),xlim=c(0,max),ylim=c(0,ymax*0.5),col=adjustcolor(sp_cols[5,1],alpha=0.8),breaks=seq(0,20,by=0.025),freq=T,main='',xlab='',yaxt='n',ylab='',xaxt='n')
abline(v=median(glob.sigma.scy),col=adjustcolor('black',alpha=0.8))


hist(as.vector(glob.sigma.chm),border=adjustcolor('white',alpha=0.4),xlim=c(min,max),col=adjustcolor(sp_cols[2,1],alpha=0.4),breaks=seq(0,20,by=0.05),freq=T,main='Chum',xlab='',yaxt='n',ylab='')
ticksat <- seq(0,3,by=0.1)
axis(1, ticksat, col="black", labels=NA,
     tcl=-0.2, lwd=0, lwd.ticks=1)
ticksat <- seq(0,3,by=0.5)
axis(1, ticksat, col="black", labels=NA,
     tcl=-0.5, lwd=0, lwd.ticks=1)
par(new=T)
hist(apply(glob.sigma.chm,2,median),border=adjustcolor('white',alpha=0.4),xlim=c(0,max),ylim=c(0,ymax*0.5),col=adjustcolor(sp_cols[2,1],alpha=0.8),breaks=seq(0,20,by=0.025),freq=T,main='',xlab='',yaxt='n',ylab='',xaxt='n')
abline(v=median(glob.sigma.chm),col=adjustcolor('black',alpha=0.8))

hist(as.vector(glob.sigma.cho),border=adjustcolor('white',alpha=0.4),xlim=c(min,max),col=adjustcolor(sp_cols[3,1],alpha=0.4),breaks=seq(0,20,by=0.05),freq=T,main='Coho',xlab='',yaxt='n',ylab='')
ticksat <- seq(0,3,by=0.1)
axis(1, ticksat, col="black", labels=NA,
     tcl=-0.2, lwd=0, lwd.ticks=1)
ticksat <- seq(0,3,by=0.5)
axis(1, ticksat, col="black", labels=NA,
     tcl=-0.5, lwd=0, lwd.ticks=1)
par(new=T)
hist(apply(glob.sigma.cho,2,median),border=adjustcolor('white',alpha=0.4),xlim=c(0,max),ylim=c(0,ymax*0.5),col=adjustcolor(sp_cols[3,1],alpha=0.8),breaks=seq(0,20,by=0.025),freq=T,main='',xlab='',yaxt='n',ylab='',xaxt='n')
abline(v=median(glob.sigma.cho),col=adjustcolor('black',alpha=0.8))

par(mar=c(4,2,3,1))
hist(as.vector(glob.sigma.pke),border=adjustcolor('white',alpha=0.4),xlim=c(min,max),col=adjustcolor(sp_cols[4,1],alpha=0.4),breaks=seq(0,20,by=0.05),freq=T,main='Pink (even)',xlab=expression(sigma),yaxt='n',ylab='',cex.lab=1.4)
ticksat <- seq(0,3,by=0.1)
axis(1, ticksat, col="black", labels=NA,
     tcl=-0.2, lwd=0, lwd.ticks=1)
ticksat <- seq(0,3,by=0.5)
axis(1, ticksat, col="black", labels=NA,
     tcl=-0.5, lwd=0, lwd.ticks=1)
par(new=T)
hist(apply(glob.sigma.pke,2,median),border=adjustcolor('white',alpha=0.4),xlim=c(0,max),ylim=c(0,ymax*0.5),col=adjustcolor(sp_cols[4,1],alpha=0.8),breaks=seq(0,20,by=0.025),freq=T,main='',xlab='',yaxt='n',ylab='',xaxt='n')
abline(v=median(glob.sigma.pke),col=adjustcolor('black',alpha=0.8))


hist(as.vector(glob.sigma.pko),border=adjustcolor('white',alpha=0.4),xlim=c(min,max),col=adjustcolor(sp_cols[4,1],alpha=0.4),breaks=seq(0,20,by=0.05),freq=T,main='Pink (odd)',xlab=expression(sigma),yaxt='n',ylab='',cex.lab=1.4)
ticksat <- seq(0,3,by=0.1)
axis(1, ticksat, col="black", labels=NA,
     tcl=-0.2, lwd=0, lwd.ticks=1)
ticksat <- seq(0,3,by=0.5)
axis(1, ticksat, col="black", labels=NA,
     tcl=-0.5, lwd=0, lwd.ticks=1)
par(new=T)
hist(apply(glob.sigma.pko,2,median),border=adjustcolor('white',alpha=0.4),xlim=c(0,max),ylim=c(0,ymax*0.5),col=adjustcolor(sp_cols[4,1],alpha=0.8),breaks=seq(0,20,by=0.025),freq=T,main='',xlab='',yaxt='n',ylab='',xaxt='n')
abline(v=median(glob.sigma.pko),col=adjustcolor('black',alpha=0.8))


```


## Rho (autocorrelation)

Posterior distribution of $\rho$, the 1-year residual autocorrelation, for all stocks of each species. Darker bars indicate the distribution of median estimates among all stocks and black vertical lines represent the median of the entire posterior.


```{r, rho}
glob.rho.chk=stc.chk$draws(variable='rho',format='draws_matrix')
glob.rho.chm=stc.chm$draws(variable='rho',format='draws_matrix')
glob.rho.cho=stc.cho$draws(variable='rho',format='draws_matrix')
glob.rho.pke=stc.pke$draws(variable='rho',format='draws_matrix')
glob.rho.pko=stc.pko$draws(variable='rho',format='draws_matrix')
glob.rho.scy=stc.scy$draws(variable='rho',format='draws_matrix')

par(mfrow=c(3,2))

min=-1
max=1
ymax=max(hist(apply(glob.rho.scy,2,median),plot=FALSE)$counts)

par(mar=c(3,2,3,1))
hist(as.vector(glob.rho.chk),border=adjustcolor('white',alpha=0.4),xlim=c(min,max),col=adjustcolor(sp_cols[1,1],alpha=0.4),breaks=seq(-1,1,by=0.05),freq=T,main='Chinook',xlab=expression(rho),yaxt='n',ylab='')
abline(v=median(glob.rho.chk),col=adjustcolor(sp_cols[1,1],alpha=0.8))
ticksat <- seq(0,4,by=0.1)
axis(1, ticksat, col="black", labels=NA,
     tcl=-0.2, lwd=0, lwd.ticks=1)
ticksat <- seq(0,4,by=0.5)
axis(1, ticksat, col="black", labels=NA,
     tcl=-0.5, lwd=0, lwd.ticks=1)
par(new=T)
hist(apply(glob.rho.chk,2,median),border=adjustcolor('white',alpha=0.4),xlim=c(min,max),ylim=c(0,ymax),col=adjustcolor(sp_cols[1,1],alpha=0.8),breaks=seq(-1,1,by=0.025),freq=T,main='',xlab='',yaxt='n',ylab='',xaxt='n')
abline(v=median(glob.rho.chk),col=adjustcolor('black',alpha=0.8))


hist(as.vector(glob.rho.scy),border=adjustcolor('white',alpha=0.4),xlim=c(min,max),col=adjustcolor(sp_cols[5,1],alpha=0.4),breaks=seq(-1,1,by=0.05),freq=T,main='Sockeye',xlab=expression(rho),yaxt='n',ylab='')
abline(v=median(glob.rho.scy),col=adjustcolor(sp_cols[1,1],alpha=0.8))
ticksat <- seq(0,4,by=0.1)
axis(1, ticksat, col="black", labels=NA,
     tcl=-0.2, lwd=0, lwd.ticks=1)
ticksat <- seq(0,4,by=0.5)
axis(1, ticksat, col="black", labels=NA,
     tcl=-0.5, lwd=0, lwd.ticks=1)
par(new=T)
hist(apply(glob.rho.scy,2,median),border=adjustcolor('white',alpha=0.4),xlim=c(min,max),ylim=c(0,ymax),col=adjustcolor(sp_cols[5,1],alpha=0.8),breaks=seq(-1,1,by=0.025),freq=T,main='',xlab='',yaxt='n',ylab='',xaxt='n')
abline(v=median(glob.rho.scy),col=adjustcolor('black',alpha=0.8))


hist(as.vector(glob.rho.chm),border=adjustcolor('white',alpha=0.4),xlim=c(min,max),col=adjustcolor(sp_cols[2,1],alpha=0.4),breaks=seq(-1,1,by=0.05),freq=T,main='Chum',xlab=expression(rho),yaxt='n',ylab='')
abline(v=median(glob.rho.chm),col=adjustcolor(sp_cols[1,1],alpha=0.8))
ticksat <- seq(0,4,by=0.1)
axis(1, ticksat, col="black", labels=NA,
     tcl=-0.2, lwd=0, lwd.ticks=1)
ticksat <- seq(0,4,by=0.5)
axis(1, ticksat, col="black", labels=NA,
     tcl=-0.5, lwd=0, lwd.ticks=1)
par(new=T)
hist(apply(glob.rho.chm,2,median),border=adjustcolor('white',alpha=0.4),xlim=c(min,max),ylim=c(0,ymax),col=adjustcolor(sp_cols[2,1],alpha=0.8),breaks=seq(-1,1,by=0.025),freq=T,main='',xlab='',yaxt='n',ylab='',xaxt='n')
abline(v=median(glob.rho.chm),col=adjustcolor('black',alpha=0.8))

hist(as.vector(glob.rho.cho),border=adjustcolor('white',alpha=0.4),xlim=c(min,max),col=adjustcolor(sp_cols[3,1],alpha=0.4),breaks=seq(-1,1,by=0.05),freq=T,main='Coho',xlab=expression(rho),yaxt='n',ylab='')
abline(v=median(glob.rho.cho),col=adjustcolor(sp_cols[1,1],alpha=0.8))
ticksat <- seq(0,4,by=0.1)
axis(1, ticksat, col="black", labels=NA,
     tcl=-0.2, lwd=0, lwd.ticks=1)
ticksat <- seq(0,4,by=0.5)
axis(1, ticksat, col="black", labels=NA,
     tcl=-0.5, lwd=0, lwd.ticks=1)
par(new=T)
hist(apply(glob.rho.cho,2,median),border=adjustcolor('white',alpha=0.4),xlim=c(min,max),ylim=c(0,ymax),col=adjustcolor(sp_cols[3,1],alpha=0.8),breaks=seq(-1,1,by=0.025),freq=T,main='',xlab='',yaxt='n',ylab='',xaxt='n')
abline(v=median(glob.rho.cho),col=adjustcolor('black',alpha=0.8))


par(mar=c(4,2,3,1))
hist(as.vector(glob.rho.pke),border=adjustcolor('white',alpha=0.4),xlim=c(min,max),col=adjustcolor(sp_cols[4,1],alpha=0.4),breaks=seq(-1,1,by=0.05),freq=T,main='Pink (even)',xlab=expression(rho),yaxt='n',ylab='')
abline(v=median(glob.rho.pke),col=adjustcolor(sp_cols[1,1],alpha=0.8))
ticksat <- seq(0,4,by=0.1)
axis(1, ticksat, col="black", labels=NA,
     tcl=-0.2, lwd=0, lwd.ticks=1)
ticksat <- seq(0,4,by=0.5)
axis(1, ticksat, col="black", labels=NA,
     tcl=-0.5, lwd=0, lwd.ticks=1)
par(new=T)
hist(apply(glob.rho.pke,2,median),border=adjustcolor('white',alpha=0.4),xlim=c(min,max),ylim=c(0,ymax),col=adjustcolor(sp_cols[4,1],alpha=0.8),breaks=seq(-1,1,by=0.025),freq=T,main='',xlab='',yaxt='n',ylab='',xaxt='n')
abline(v=median(glob.rho.pke),col=adjustcolor('black',alpha=0.8))


hist(as.vector(glob.rho.pko),border=adjustcolor('white',alpha=0.4),xlim=c(min,max),col=adjustcolor(sp_cols[4,1],alpha=0.4),breaks=seq(-1,1,by=0.05),freq=T,main='Pink (odd)',xlab=expression(rho),yaxt='n',ylab='')
abline(v=median(glob.rho.pko),col=adjustcolor(sp_cols[1,1],alpha=0.8))
ticksat <- seq(0,4,by=0.1)
axis(1, ticksat, col="black", labels=NA,
     tcl=-0.2, lwd=0, lwd.ticks=1)
ticksat <- seq(0,4,by=0.5)
axis(1, ticksat, col="black", labels=NA,
     tcl=-0.5, lwd=0, lwd.ticks=1)
par(new=T)
hist(apply(glob.rho.pko,2,median),border=adjustcolor('white',alpha=0.4),xlim=c(min,max),ylim=c(0,ymax),col=adjustcolor(sp_cols[4,1],alpha=0.8),breaks=seq(-1,1,by=0.025),freq=T,main='',xlab='',yaxt='n',ylab='',xaxt='n')
abline(v=median(glob.rho.pko),col=adjustcolor('black',alpha=0.8))


```


##Parameter correlations - productivity and capacity

This section examines the correlation between estimates of stock productivity (log($\alpha$)) and stock capacity ($Smax$), which can be examined both across stocks, which tests for potential scaling relationships (ie. are larger stocks more or less productive), and within the posterior sample for each stock (ie. what is the statistical correlation between estimating the two parameters of the Ricker relationship).

```{r, correlations in a & b}
alphas.chk=stc.chk$draws(variables='log_a',format='draws_matrix')
alphas.scy=stc.scy$draws(variables='log_a',format='draws_matrix')
alphas.chm=stc.chm$draws(variables='log_a',format='draws_matrix')
alphas.cho=stc.cho$draws(variables='log_a',format='draws_matrix')
alphas.pke=stc.pke$draws(variables='log_a',format='draws_matrix')
alphas.pko=stc.pko$draws(variables='log_a',format='draws_matrix')

corr.across.chk=NA
for(i in 1:nrow(alphas.chk)){
  corr.across.chk[i]=cor(as.vector(alphas.chk[i,]),as.vector(log(smax.chk[i,])))
}
corr.within.chk=NA
for(i in 1:ncol(alphas.chk)){
  corr.within.chk[i]=cor(as.vector(alphas.chk[,i]),as.vector(log(smax.chk[,i])))
}

corr.across.scy=NA
for(i in 1:nrow(alphas.scy)){
  corr.across.scy[i]=cor(as.vector(alphas.scy[i,]),as.vector(log(smax.scy[i,])))
}
corr.within.scy=NA
for(i in 1:ncol(alphas.scy)){
  corr.within.scy[i]=cor(as.vector(alphas.scy[,i]),as.vector(log(smax.scy[,i])))
}

corr.across.chm=NA
for(i in 1:nrow(alphas.chm)){
  corr.across.chm[i]=cor(as.vector(alphas.chm[i,]),as.vector(log(smax.chm[i,])))
}
corr.within.chm=NA
for(i in 1:ncol(alphas.chm)){
  corr.within.chm[i]=cor(as.vector(alphas.chm[,i]),as.vector(log(smax.chm[,i])))
}

corr.across.cho=NA
for(i in 1:nrow(alphas.cho)){
  corr.across.cho[i]=cor(as.vector(alphas.cho[i,]),as.vector(log(smax.cho[i,])))
}
corr.within.cho=NA
for(i in 1:ncol(alphas.cho)){
  corr.within.cho[i]=cor(as.vector(alphas.cho[,i]),as.vector(log(smax.cho[,i])))
}

corr.across.pke=NA
for(i in 1:nrow(alphas.pke)){
  corr.across.pke[i]=cor(as.vector(alphas.pke[i,]),as.vector(log(smax.pke[i,])))
}
corr.within.pke=NA
for(i in 1:ncol(alphas.pke)){
  corr.within.pke[i]=cor(as.vector(alphas.pke[,i]),as.vector(log(smax.pke[,i])))
}

corr.across.pko=NA
for(i in 1:nrow(alphas.pko)){
  corr.across.pko[i]=cor(as.vector(alphas.pko[i,]),as.vector(log(smax.pko[i,])))
}
corr.within.pko=NA
for(i in 1:ncol(alphas.pko)){
  corr.within.pko[i]=cor(as.vector(alphas.pko[,i]),as.vector(log(smax.pko[,i])))
}
```

###Among stock correlation

$r$ is the median correlation among stocks in each parameter.

```{r, among stock static corr}
par(mfrow=c(3,2))
par(mar=c(3,5,3,1))
#Correlations between alpha/beta across stocks
plot(apply(alphas.chk,2,median)~apply(log10(smax.chk),2,median),bty='l',ylab=expression(paste('Median Productivity - log(',alpha,')')),xlab='',pch=21,bg=adjustcolor(sp_cols[1,1],alpha.f=0.6),cex=2,cex.lab=1.4,main='Chinook',xlim=c(0,8),xaxt='n')
text(x=par('usr')[2]*0.9,y=par('usr')[4]*0.9,paste('r = ',round(median(corr.across.chk),2)),cex=1.2)
pow <- 0:7
ticksat <- as.vector(sapply(pow, function(p) (1:10)*10^p))
axis(1, log10(ticksat), col="black", labels=NA,
     tcl=-0.2, lwd=0, lwd.ticks=1)
axis(1, col="black", at=seq(0,8,by=1),   tcl=-0.45, cex.axis=1.2,
     labels=c(expression(1),expression(10),expression(100),expression('1K'),expression('10K'),expression('100K'),expression('1M'),expression('10M'),expression('100M')))

plot(apply(alphas.scy,2,median)~apply(log10(smax.scy),2,median),bty='l',ylab=expression(paste('Median Productivity - log(',alpha,')')),xlab='',pch=21,bg=adjustcolor(sp_cols[5,1],alpha.f=0.6),cex=2,cex.lab=1.4,main='Sockeye',xlim=c(0,8),xaxt='n')
text(x=par('usr')[2]*0.9,y=par('usr')[4]*0.9,paste('r = ',round(median(corr.across.scy),2)),cex=1.2)
pow <- 0:7
ticksat <- as.vector(sapply(pow, function(p) (1:10)*10^p))
axis(1, log10(ticksat), col="black", labels=NA,
     tcl=-0.2, lwd=0, lwd.ticks=1)
axis(1, col="black", at=seq(0,8,by=1),   tcl=-0.45, cex.axis=1.2,
     labels=c(expression(1),expression(10),expression(100),expression('1K'),expression('10K'),expression('100K'),expression('1M'),expression('10M'),expression('100M')))

plot(apply(alphas.chm,2,median)~apply(log10(smax.chm),2,median),bty='l',ylab=expression(paste('Median Productivity - log(',alpha,')')),xlab='',pch=21,bg=adjustcolor(sp_cols[2,1],alpha.f=0.6),cex=2,cex.lab=1.4,main='Chum',xlim=c(0,8),xaxt='n')
text(x=par('usr')[2]*0.9,y=par('usr')[4]*0.9,paste('r = ',round(median(corr.across.chm),2)),cex=1.2)
pow <- 0:7
ticksat <- as.vector(sapply(pow, function(p) (1:10)*10^p))
axis(1, log10(ticksat), col="black", labels=NA,
     tcl=-0.2, lwd=0, lwd.ticks=1)
axis(1, col="black", at=seq(0,8,by=1),   tcl=-0.45, cex.axis=1.2,
     labels=c(expression(1),expression(10),expression(100),expression('1K'),expression('10K'),expression('100K'),expression('1M'),expression('10M'),expression('100M')))

plot(apply(alphas.cho,2,median)~apply(log10(smax.cho),2,median),bty='l',ylab=expression(paste('Median Productivity - log(',alpha,')')),xlab='',pch=21,bg=adjustcolor(sp_cols[3,1],alpha.f=0.6),cex=2,cex.lab=1.4,main='Coho',xlim=c(0,8),xaxt='n')
text(x=par('usr')[2]*0.9,y=par('usr')[4]*0.9,paste('r = ',round(median(corr.across.cho),2)),cex=1.2)
pow <- 0:7
ticksat <- as.vector(sapply(pow, function(p) (1:10)*10^p))
axis(1, log10(ticksat), col="black", labels=NA,
     tcl=-0.2, lwd=0, lwd.ticks=1)
axis(1, col="black", at=seq(0,8,by=1),   tcl=-0.45, cex.axis=1.2,
     labels=c(expression(1),expression(10),expression(100),expression('1K'),expression('10K'),expression('100K'),expression('1M'),expression('10M'),expression('100M')))

par(mar=c(4,5,3,1))
plot(apply(alphas.pke,2,median)~apply(log10(smax.pke),2,median),bty='l',ylab=expression(paste('Median Productivity - log(',alpha,')')),xlab='Capacity (Smax)',pch=21,bg=adjustcolor(sp_cols[4,1],alpha.f=0.6),cex=2,cex.lab=1.4,main='Pink (even)',xlim=c(0,8),xaxt='n')
text(x=par('usr')[2]*0.9,y=par('usr')[4]*0.9,paste('r = ',round(median(corr.across.pke),2)),cex=1.2)
pow <- 0:7
ticksat <- as.vector(sapply(pow, function(p) (1:10)*10^p))
axis(1, log10(ticksat), col="black", labels=NA,
     tcl=-0.2, lwd=0, lwd.ticks=1)
axis(1, col="black", at=seq(0,8,by=1),   tcl=-0.45, cex.axis=1.2,
     labels=c(expression(1),expression(10),expression(100),expression('1K'),expression('10K'),expression('100K'),expression('1M'),expression('10M'),expression('100M')))

plot(apply(alphas.pko,2,median)~apply(log10(smax.pko),2,median),bty='l',ylab=expression(paste('Median Productivity - log(',alpha,')')),xlab='Capacity (Smax)',pch=21,bg=adjustcolor(sp_cols[4,1],alpha.f=0.6),cex=2,cex.lab=1.4,main='Pink (odd)',xlim=c(0,8),xaxt='n')
text(x=par('usr')[2]*0.9,y=par('usr')[4]*0.9,paste('r = ',round(median(corr.across.pko),2)),cex=1.2)
pow <- 0:7
ticksat <- as.vector(sapply(pow, function(p) (1:10)*10^p))
axis(1, log10(ticksat), col="black", labels=NA,
     tcl=-0.2, lwd=0, lwd.ticks=1)
axis(1, col="black", at=seq(0,8,by=1),   tcl=-0.45, cex.axis=1.2,
     labels=c(expression(1),expression(10),expression(100),expression('1K'),expression('10K'),expression('100K'),expression('1M'),expression('10M'),expression('100M')))

par(mfrow=c(3,2))
par(mar=c(4,5,3,1))
#productivity vs. capacity
hist(corr.across.chk,breaks=50,xlab='Correlation estimate',yaxt='n',ylab='',main='Chinook',border=adjustcolor('white',alpha=0.4),col=adjustcolor(sp_cols[1,1],alpha=0.4))
abline(v=median(corr.across.chk),col=adjustcolor(sp_cols[1,1],alpha=0.8))
hist(corr.across.scy,breaks=50,xlab='Correlation estimate',yaxt='n',ylab='',main='Sockeye',border=adjustcolor('white',alpha=0.4),col=adjustcolor(sp_cols[5,1],alpha=0.4))
abline(v=median(corr.across.scy),col=adjustcolor(sp_cols[5,1],alpha=0.8))

hist(corr.across.chm,breaks=50,xlab='Correlation estimate',yaxt='n',ylab='',main='Chum',border=adjustcolor('white',alpha=0.4),col=adjustcolor(sp_cols[2,1],alpha=0.4))
abline(v=median(corr.across.chm),col=adjustcolor(sp_cols[2,1],alpha=0.8))

hist(corr.across.cho,breaks=50,xlab='Correlation estimate',yaxt='n',ylab='',main='Coho',border=adjustcolor('white',alpha=0.4),col=adjustcolor(sp_cols[3,1],alpha=0.4))
abline(v=median(corr.across.cho),col=adjustcolor(sp_cols[3,1],alpha=0.8))

hist(corr.across.pke,breaks=50,xlab='Correlation estimate',yaxt='n',ylab='',main='Pink - even',border=adjustcolor('white',alpha=0.4),col=adjustcolor(sp_cols[4,1],alpha=0.4))
abline(v=median(corr.across.pke),col=adjustcolor(sp_cols[4,1],alpha=0.8))

hist(corr.across.pko,breaks=50,xlab='Correlation estimate',yaxt='n',ylab='',main='Pink - odd',border=adjustcolor('white',alpha=0.4),col=adjustcolor(sp_cols[4,1],alpha=0.4))
abline(v=median(corr.across.pko),col=adjustcolor(sp_cols[4,1],alpha=0.8))

```

###Within stock correlation

Distribution of the median correlation between each parameter in the posterior distribution of each stock.

```{r, within stock static corr}
par(mfrow=c(3,2))
par(mar=c(4,5,3,1))
#productivity vs. capacity
hist(corr.within.chk,breaks=30,xlab='Correlation estimate',yaxt='n',ylab='',main='Chinook',border=adjustcolor('white',alpha=0.4),col=adjustcolor(sp_cols[1,1],alpha=0.4))
abline(v=median(corr.within.chk),col=adjustcolor(sp_cols[1,1],alpha=0.8))
hist(corr.within.scy,breaks=30,xlab='Correlation estimate',yaxt='n',ylab='',main='Sockeye',border=adjustcolor('white',alpha=0.4),col=adjustcolor(sp_cols[5,1],alpha=0.4))
abline(v=median(corr.within.scy),col=adjustcolor(sp_cols[5,1],alpha=0.8))

hist(corr.within.chm,breaks=30,xlab='Correlation estimate',yaxt='n',ylab='',main='Chum',border=adjustcolor('white',alpha=0.4),col=adjustcolor(sp_cols[2,1],alpha=0.4))
abline(v=median(corr.within.chm),col=adjustcolor(sp_cols[2,1],alpha=0.8))

hist(corr.within.cho,breaks=30,xlab='Correlation estimate',yaxt='n',ylab='',main='Coho',border=adjustcolor('white',alpha=0.4),col=adjustcolor(sp_cols[3,1],alpha=0.4))
abline(v=median(corr.within.cho),col=adjustcolor(sp_cols[3,1],alpha=0.8))

hist(corr.within.pke,breaks=30,xlab='Correlation estimate',yaxt='n',ylab='',main='Pink - even',border=adjustcolor('white',alpha=0.4),col=adjustcolor(sp_cols[4,1],alpha=0.4))
abline(v=median(corr.within.pke),col=adjustcolor(sp_cols[4,1],alpha=0.8))

hist(corr.within.pko,breaks=30,xlab='Correlation estimate',yaxt='n',ylab='',main='Pink - odd',border=adjustcolor('white',alpha=0.4),col=adjustcolor(sp_cols[4,1],alpha=0.4))
abline(v=median(corr.within.pko),col=adjustcolor(sp_cols[4,1],alpha=0.8))


```


# Productivity trajectories

Trajectories of mean intrinsic productivity change throughout the time span fit with multi-stock models (model 2 in the main text).

```{r, tv model load}
tv.chk=readRDS('../outputs/model fits/tv_fit_chinook.RDS')
tv.cho=readRDS('../outputs/model fits/tv_fit_coho.RDS')
tv.chm=readRDS('../outputs/model fits/tv_fit_chum.RDS')
tv.pke=readRDS('../outputs/model fits/tv_fit_pinke.RDS')
tv.pko=readRDS('../outputs/model fits/tv_fit_pinko.RDS')
tv.scy=readRDS('../outputs/model fits/tv_fit_sockeye.RDS')

```

##Global (all stocks)
Geometric mean productivity, $\alpha$, (with shading indicating 90% credible intervals) for all stocks in each species.

```{r, global traj,fig.height=6,fig.width=8}
mu_loga.chk=tv.chk$draws(variables='mu_log_a',format='draws_matrix')
mu_loga.cho=tv.cho$draws(variables='mu_log_a',format='draws_matrix')
mu_loga.chm=tv.chm$draws(variables='mu_log_a',format='draws_matrix')
mu_loga.pke=tv.pke$draws(variables='mu_log_a',format='draws_matrix')
mu_loga.pko=tv.pko$draws(variables='mu_log_a',format='draws_matrix')
mu_loga.scy=tv.scy$draws(variables='mu_log_a',format='draws_matrix')

par(mfrow=c(1,1))
par(mar=c(5,5,1,1))
ylim=c(2,7)
plot(c(ylim[1],ylim[2])~c(min(stk.info$begin),max(stk.info$end)),bty='l',type='n',ylab=expression(paste("Mean Productivity, max. R/S")),xlab='Brood cohort year',cex.axis=1.3,cex.lab=1.3,ylim=c(2,7))
lines(apply(exp(mu_loga.chk),2,median)~seq(min(chk.info$begin),max(chk.info$end)),lwd=3,col=adjustcolor(sp_cols[1],alpha.f=0.9))
polygon(c(seq(min(chk.info$begin),max(chk.info$end)), rev(seq(min(chk.info$begin),max(chk.info$end)))), c(apply(exp(mu_loga.chk),2,quantile,0.05), rev(apply(exp(mu_loga.chk),2,quantile,0.95))), col = adjustcolor(sp_cols[1],alpha.f=0.1), border = NA)
lines(apply(exp(mu_loga.chm),2,median)~seq(min(chm.info$begin),max(chm.info$end)),lwd=3,col=adjustcolor(sp_cols[2],alpha.f=0.9))
polygon(c(seq(min(chm.info$begin),max(chm.info$end)), rev(seq(min(chm.info$begin),max(chm.info$end)))), c(apply(exp(mu_loga.chm),2,quantile,0.05), rev(apply(exp(mu_loga.chm),2,quantile,0.95))), col = adjustcolor(sp_cols[2],alpha.f=0.1), border = NA)
#lines(apply(exp(mu_loga.cho),2,median)~seq(min(cho.info$begin),max(cho.info$end)),lwd=3,col=adjustcolor(sp_cols[3],alpha.f=0.9))
#polygon(c(seq(min(cho.info$begin),max(cho.info$end)), rev(seq(min(cho.info$begin),max(cho.info$end)))), c(apply(exp(mu_loga.cho),2,quantile,0.05), rev(apply(exp(mu_loga.cho),2,quantile,0.95))), col = adjustcolor(sp_cols[3],alpha.f=0.1), border = NA)
lines(apply(exp(mu_loga.pke),2,median)~seq(min(pke.info$begin),max(pke.info$end)),lwd=3,col=adjustcolor(sp_cols[4],alpha.f=0.9))
polygon(c(seq(min(pke.info$begin),max(pke.info$end)), rev(seq(min(pke.info$begin),max(pke.info$end)))), c(apply(exp(mu_loga.pke),2,quantile,0.05), rev(apply(exp(mu_loga.pke),2,quantile,0.95))), col = adjustcolor(sp_cols[4],alpha.f=0.1), border = NA)
lines(apply(exp(mu_loga.pko),2,median)~seq(min(pko.info$begin),max(pko.info$end)),lwd=3,col=adjustcolor(sp_cols[4],alpha.f=0.9),lty=5)
polygon(c(seq(min(pko.info$begin),max(pko.info$end)), rev(seq(min(pko.info$begin),max(pko.info$end)))), c(apply(exp(mu_loga.pko),2,quantile,0.05), rev(apply(exp(mu_loga.pko),2,quantile,0.95))), col = adjustcolor(sp_cols[4],alpha.f=0.1), border = NA)
lines(apply(exp(mu_loga.scy),2,median)~seq(min(scy.info$begin),max(scy.info$end)),lwd=3,col=adjustcolor(sp_cols[5],alpha.f=0.9))
polygon(c(seq(min(scy.info$begin),max(scy.info$end)), rev(seq(min(scy.info$begin),max(scy.info$end)))), c(apply(exp(mu_loga.scy),2,quantile,0.05), rev(apply(exp(mu_loga.scy),2,quantile,0.95))), col = adjustcolor(sp_cols[5],alpha.f=0.1), border = NA)
lines(c(7,7)~c(2010,2013),col=adjustcolor(sp_cols[1],alpha.f=0.9),lwd=2)
lines(c(6.6,6.6)~c(2010,2013),col=adjustcolor(sp_cols[2],alpha.f=0.9),lwd=2)
lines(c(6.4,6.4)~c(2010,2013),col=adjustcolor(sp_cols[3],alpha.f=0.9),lwd=2)
lines(c(6.2,6.2)~c(2010,2013),col=adjustcolor(sp_cols[4],alpha.f=0.9),lwd=2)
lines(c(6,6)~c(2010,2013),col=adjustcolor(sp_cols[4],alpha.f=0.9),lwd=2,lty=5)
lines(c(6.8,6.8)~c(2010,2013),col=adjustcolor(sp_cols[5],alpha.f=0.9),lwd=2)
text(x=2018,y=7,'Chinook',col=sp_cols[1])
text(x=2018,y=6.6,'Chum',col=sp_cols[2])
text(x=2018,y=6.4,'Coho',col=sp_cols[3])
text(x=2018,y=6.2,'Pink (E)',col=sp_cols[4])
text(x=2018,y=6,'Pink (O)',col=sp_cols[4])
text(x=2018,y=6.8,'Sockeye',col=sp_cols[5])
```

## Large Marine Ecosystem
###Chinook
```{r, lme tvprod chk,fig.height=7,fig.width=16}
loga.chk=tv.chk$draws(variables='log_a_t',format='draws_matrix')
loga.chk.wc=loga.chk[,chk.wc]
loga.chk.seak=loga.chk[,chk.seak]
loga.chk.goa=loga.chk[,chk.goa]
loga.chk.bs=loga.chk[,chk.bs]

L=max(chk.info$end)-min(chk.info$begin)+1

#mean log(a) - WEst coast
mu_loga.chk.wc=matrix(nrow=nrow(loga.chk),ncol=L)
subset.rows=paste(',',chk.wc,']',sep='') #column name construction
subset.rows2=paste(subset.rows, collapse = "|") #conditional for grepl
wc.loga.chk=loga.chk[,grepl(subset.rows2,colnames(loga.chk))] #all log-a estimates for WC stocks
logat=wc.loga.chk
for(t in 1:L){
  colnames(logat)=gsub("]", ".", colnames(logat))
  colnames(logat)=gsub("log_a_t[", "log_a_t.", colnames(logat),fixed=T)
  
  logas=logat[,grepl(paste('log_a_t.',t,',',sep=''),colnames(logat))]
  mu_loga.chk.wc[,t]=apply(logas,1,mean)
}    

#mean log(a) - SE Alaska/NBC
mu_loga.chk.seak=matrix(nrow=nrow(loga.chk),ncol=L)
subset.rows=paste(',',chk.seak,']',sep='') #column name construction
subset.rows2=paste(subset.rows, collapse = "|") #conditional for grepl
seak.loga.chk=loga.chk[,grepl(subset.rows2,colnames(loga.chk))] #all log-a estimates for WC stocks
logat=seak.loga.chk
for(t in 1:L){
  colnames(logat)=gsub("]", ".", colnames(logat))
  colnames(logat)=gsub("log_a_t[", "log_a_t.", colnames(logat),fixed=T)
  
  logas=logat[,grepl(paste('log_a_t.',t,',',sep=''),colnames(logat))]
  mu_loga.chk.seak[,t]=apply(logas,1,mean)
}    

#mean log(a) - Gulf of Alaska
mu_loga.chk.goa=matrix(nrow=nrow(loga.chk),ncol=L)
subset.rows=paste(',',chk.goa,']',sep='') #column name construction
subset.rows2=paste(subset.rows, collapse = "|") #conditional for grepl
goa.loga.chk=loga.chk[,grepl(subset.rows2,colnames(loga.chk))] #all log-a estimates for WC stocks
logat=goa.loga.chk
for(t in 1:L){
  colnames(logat)=gsub("]", ".", colnames(logat))
  colnames(logat)=gsub("log_a_t[", "log_a_t.", colnames(logat),fixed=T)
  
  logas=logat[,grepl(paste('log_a_t.',t,',',sep=''),colnames(logat))]
  mu_loga.chk.goa[,t]=apply(logas,1,mean)
}    

#mean log(a) - Bering sea
mu_loga.chk.bs=matrix(nrow=nrow(loga.chk),ncol=L)
subset.rows=paste(',',chk.bs,']',sep='') #column name construction
subset.rows2=paste(subset.rows, collapse = "|") #conditional for grepl
bs.loga.chk=loga.chk[,grepl(subset.rows2,colnames(loga.chk))] #all log-a estimates for WC stocks
logat=bs.loga.chk
for(t in 1:L){
  colnames(logat)=gsub("]", ".", colnames(logat))
  colnames(logat)=gsub("log_a_t[", "log_a_t.", colnames(logat),fixed=T)
  
  logas=logat[,grepl(paste('log_a_t.',t,',',sep=''),colnames(logat))]
  mu_loga.chk.bs[,t]=apply(logas,1,mean)
}    

df=data.frame(by=seq(min(chk.info$begin),max(chk.info$end)),
              y.bs=apply(exp(mu_loga.chk.bs),2,median),y.bsl90=apply(exp(mu_loga.chk.bs),2,quantile,0.05),y.bsu90=apply(exp(mu_loga.chk.bs),2,quantile,0.95),
              y.goa=apply(exp(mu_loga.chk.goa),2,median),y.goal90=apply(exp(mu_loga.chk.goa),2,quantile,0.05),y.goau90=apply(exp(mu_loga.chk.goa),2,quantile,0.95),
              y.seak=apply(exp(mu_loga.chk.seak),2,median),y.seakl90=apply(exp(mu_loga.chk.seak),2,quantile,0.05),y.seaku90=apply(exp(mu_loga.chk.seak),2,quantile,0.95),
              y.wc=apply(exp(mu_loga.chk.wc),2,median),y.wcl90=apply(exp(mu_loga.chk.wc),2,quantile,0.05),y.wcu90=apply(exp(mu_loga.chk.wc),2,quantile,0.95)
              )
mytheme = list(
  theme_classic(14)+
    theme(panel.background = element_blank(),strip.background = element_rect(colour=NA, fill=NA),panel.border = element_blank(),
          legend.title = element_blank(),legend.position="bottom", strip.text = element_text(face="bold", size=13),
          axis.text=element_text(face="bold"),axis.title = element_text(face="bold",size=16),plot.title = element_text(face = "bold", hjust = 0.5,size=16))
)

prod=ggplot(df,aes(x=by,y=y.bs))+
  ylim(1,10)+
  geom_line(aes(y=y.bs),color=basin_cols[4],size=2)+
  geom_ribbon(aes(ymin = y.bsl90, ymax = y.bsu90), fill = basin_cols[4], alpha = 0.1) +
  geom_line(aes(y=y.goa),color=basin_cols[3],size=2)+
  geom_ribbon(aes(ymin = y.goal90, ymax = y.goau90), fill = basin_cols[3], alpha = 0.1) +
  geom_line(aes(y=y.seak),color=basin_cols[2],size=2)+
  geom_ribbon(aes(ymin = y.seakl90, ymax = y.seaku90), fill = basin_cols[2], alpha = 0.1) +
  geom_line(aes(y=y.wc),color=basin_cols[1],size=2)+
  geom_ribbon(aes(ymin = y.wcl90, ymax = y.wcu90), fill = basin_cols[1], alpha = 0.1) +
  xlab('Brood cohort year')+
  ylab(expression(paste('Mean productivity, max. R/S')))+
  ggtitle('Chinook')+
  mytheme

world <- rnaturalearth::ne_countries(scale = "medium", returnclass = "sf")

all_lat_lon.chk = chk.info %>% group_by(lat,lon) %>% summarize(n=n(),.groups = 'keep')
all_lat_lon.chk$lon=ifelse(all_lat_lon.chk$lon>0,-all_lat_lon.chk$lon,all_lat_lon.chk$lon) #need to fix the lat lons
all_lat_lon.chk$ocean.basin=chk.info$ocean.basin[match(all_lat_lon.chk$lat,chk.info$lat)]

ll_chk1=subset(all_lat_lon.chk,ocean.basin=='WC')
ll_chk2=subset(all_lat_lon.chk,ocean.basin=='SEAK')
ll_chk3=subset(all_lat_lon.chk,ocean.basin=='GOA')
ll_chk4=subset(all_lat_lon.chk,ocean.basin=='BS')


map=ggplot(data = world) + 
  geom_sf(fill= 'antiquewhite') +  xlab("") + ylab("") +
  geom_point(data =  ll_chk4, mapping = aes(x = lon, y = lat), color = basin_cols[4], size = 2.5*log(ll_chk4$n+2), alpha = 0.7) +
  geom_point(data =  ll_chk3, mapping = aes(x = lon, y = lat), color =basin_cols[3], size = 2.5*log(ll_chk3$n+2), alpha = 0.7) +
  geom_point(data =  ll_chk2, mapping = aes(x = lon, y = lat), color = basin_cols[2], size = 2.5*log(ll_chk2$n+2), alpha = 0.7) +
  geom_point(data =  ll_chk1, mapping = aes(x = lon, y = lat), color =basin_cols[1], size = 2.5*log(ll_chk1$n+2), alpha = 0.7) +
  annotate(geom = 'point', x = -165, y = 50, size = 2.5*log(1+2)) +
  annotate(geom = 'point', x = -165, y = 49, size = 2.5*log(3+2)) + 
  annotate(geom = 'point', x = -165, y = 48, size = 2.5*log(10+2)) + 
  annotate(geom = 'point', x = -165, y = 47, size = 2.5*log(20+2)) + 
  annotate(geom = 'text', x = -165, y = 51,label='n', size = 6) +
  annotate(geom = 'text', x = -162, y = 50,label='1', size = 5) +
  annotate(geom = 'text', x = -162, y = 49,label='3', size = 5) + 
  annotate(geom = 'text', x = -162, y = 48,label='10', size = 5) + 
  annotate(geom = 'text', x = -162, y = 47,label='20', size = 5) + 
  annotate(geom = 'text', x = -134, y = 50.5, label = 'West Coast', color = basin_cols[1], size = 7) + 
  annotate(geom = 'text', x = -134, y = 49.5, label = paste('n =', length(chk.wc)), color = basin_cols[1], size = 5) + 
  annotate(geom = 'text', x = -138, y = 54.5, label = 'SE Alaska', color = basin_cols[2], size = 7) + 
  annotate(geom = 'text', x = -138, y = 53.5, label = paste('n =', length(chk.seak)), color = basin_cols[2], size = 5) + 
  annotate(geom = 'text', x = -145, y = 57.5, label = 'Gulf of Alaska', color = basin_cols[3], size = 7) + 
  annotate(geom = 'text', x = -145, y = 56.5, label = paste('n =', length(chk.goa)), color = basin_cols[3], size = 5) + 
  annotate(geom = 'text', x = -164, y = 58, label = 'Bering Sea', color = basin_cols[4], size = 7) + 
  annotate(geom = 'text', x = -164, y = 57, label = paste('n =', length(chk.bs)), color = basin_cols[4], size = 5) + 
  annotation_scale(location = 'bl', width_hint = 0.5) + 
  annotation_north_arrow(location = 'bl', which_north = 'true', pad_x = unit(0.35, 'in'), pad_y = unit(0.25, 'in'), style = north_arrow_fancy_orienteering) + 
  coord_sf(xlim = c(-170, -124), ylim = c(46, 72), expand = T) +
  theme(panel.background = element_rect(fill = 'white'),legend.title = element_blank())

cowplot::plot_grid(prod,map,labels=c('A.','B.'),rel_widths = c(0.5,0.5))

```

###Sockeye
```{r,lme tvprod scy,fig.height=7,fig.width=16}
loga.scy=tv.scy$draws(variables='log_a_t',format='draws_matrix')
loga.scy.wc=loga.scy[,scy.wc]
loga.scy.seak=loga.scy[,scy.seak]
loga.scy.goa=loga.scy[,scy.goa]
loga.scy.bs=loga.scy[,scy.bs]

L=max(scy.info$end)-min(scy.info$begin)+1

#mean log(a) - WEst coast
mu_loga.scy.wc=matrix(nrow=nrow(loga.scy),ncol=L)
subset.rows=paste(',',scy.wc,']',sep='') #column name construction
subset.rows2=paste(subset.rows, collapse = "|") #conditional for grepl
wc.loga.scy=loga.scy[,grepl(subset.rows2,colnames(loga.scy))] #all log-a estimates for WC stocks
logat=wc.loga.scy
for(t in 1:L){
  colnames(logat)=gsub("]", ".", colnames(logat))
  colnames(logat)=gsub("log_a_t[", "log_a_t.", colnames(logat),fixed=T)
  
  logas=logat[,grepl(paste('log_a_t.',t,',',sep=''),colnames(logat))]
  mu_loga.scy.wc[,t]=apply(logas,1,mean)
}    

#mean log(a) - SE Alaska/NBC
mu_loga.scy.seak=matrix(nrow=nrow(loga.scy),ncol=L)
subset.rows=paste(',',scy.seak,']',sep='') #column name construction
subset.rows2=paste(subset.rows, collapse = "|") #conditional for grepl
seak.loga.scy=loga.scy[,grepl(subset.rows2,colnames(loga.scy))] #all log-a estimates for WC stocks
logat=seak.loga.scy
for(t in 1:L){
  colnames(logat)=gsub("]", ".", colnames(logat))
  colnames(logat)=gsub("log_a_t[", "log_a_t.", colnames(logat),fixed=T)
  
  logas=logat[,grepl(paste('log_a_t.',t,',',sep=''),colnames(logat))]
  mu_loga.scy.seak[,t]=apply(logas,1,mean)
}    

#mean log(a) - Gulf of Alaska
mu_loga.scy.goa=matrix(nrow=nrow(loga.scy),ncol=L)
subset.rows=paste(',',scy.goa,']',sep='') #column name construction
subset.rows2=paste(subset.rows, collapse = "|") #conditional for grepl
goa.loga.scy=loga.scy[,grepl(subset.rows2,colnames(loga.scy))] #all log-a estimates for WC stocks
logat=goa.loga.scy
for(t in 1:L){
  colnames(logat)=gsub("]", ".", colnames(logat))
  colnames(logat)=gsub("log_a_t[", "log_a_t.", colnames(logat),fixed=T)
  
  logas=logat[,grepl(paste('log_a_t.',t,',',sep=''),colnames(logat))]
  mu_loga.scy.goa[,t]=apply(logas,1,mean)
}    

#mean log(a) - Bering sea
mu_loga.scy.bs=matrix(nrow=nrow(loga.scy),ncol=L)
subset.rows=paste(',',scy.bs,']',sep='') #column name construction
subset.rows2=paste(subset.rows, collapse = "|") #conditional for grepl
bs.loga.scy=loga.scy[,grepl(subset.rows2,colnames(loga.scy))] #all log-a estimates for WC stocks
logat=bs.loga.scy
for(t in 1:L){
  colnames(logat)=gsub("]", ".", colnames(logat))
  colnames(logat)=gsub("log_a_t[", "log_a_t.", colnames(logat),fixed=T)
  
  logas=logat[,grepl(paste('log_a_t.',t,',',sep=''),colnames(logat))]
  mu_loga.scy.bs[,t]=apply(logas,1,mean)
}    

df=data.frame(by=seq(min(scy.info$begin),max(scy.info$end)),
              y.bs=apply(exp(mu_loga.scy.bs),2,median),y.bsl90=apply(exp(mu_loga.scy.bs),2,quantile,0.05),y.bsu90=apply(exp(mu_loga.scy.bs),2,quantile,0.95),
              y.goa=apply(exp(mu_loga.scy.goa),2,median),y.goal90=apply(exp(mu_loga.scy.goa),2,quantile,0.05),y.goau90=apply(exp(mu_loga.scy.goa),2,quantile,0.95),
              y.seak=apply(exp(mu_loga.scy.seak),2,median),y.seakl90=apply(exp(mu_loga.scy.seak),2,quantile,0.05),y.seaku90=apply(exp(mu_loga.scy.seak),2,quantile,0.95),
              y.wc=apply(exp(mu_loga.scy.wc),2,median),y.wcl90=apply(exp(mu_loga.scy.wc),2,quantile,0.05),y.wcu90=apply(exp(mu_loga.scy.wc),2,quantile,0.95)
)
mytheme = list(
  theme_classic(14)+
    theme(panel.background = element_blank(),strip.background = element_rect(colour=NA, fill=NA),panel.border = element_blank(),
          legend.title = element_blank(),legend.position="bottom", strip.text = element_text(face="bold", size=13),
          axis.text=element_text(face="bold"),axis.title = element_text(face="bold",size=16),plot.title = element_text(face = "bold", hjust = 0.5,size=16))
)

prod=ggplot(df,aes(x=by,y=y.bs))+
  ylim(1,10)+
  geom_line(aes(y=y.bs),color=basin_cols[4],size=2)+
  geom_ribbon(aes(ymin = y.bsl90, ymax = y.bsu90), fill = basin_cols[4], alpha = 0.1) +
  geom_line(aes(y=y.goa),color=basin_cols[3],size=2)+
  geom_ribbon(aes(ymin = y.goal90, ymax = y.goau90), fill = basin_cols[3], alpha = 0.1) +
  geom_line(aes(y=y.seak),color=basin_cols[2],size=2)+
  geom_ribbon(aes(ymin = y.seakl90, ymax = y.seaku90), fill = basin_cols[2], alpha = 0.1) +
  geom_line(aes(y=y.wc),color=basin_cols[1],size=2)+
  geom_ribbon(aes(ymin = y.wcl90, ymax = y.wcu90), fill = basin_cols[1], alpha = 0.1) +
  xlab('Brood cohort year')+
  ylab(expression(paste('Mean productivity, max. R/S')))+
  ggtitle('Sockeye')+
  mytheme

world <- rnaturalearth::ne_countries(scale = "medium", returnclass = "sf")

all_lat_lon.scy = scy.info %>% group_by(lat,lon) %>% summarize(n=n(),.groups = 'keep')
all_lat_lon.scy$lon=ifelse(all_lat_lon.scy$lon>0,-all_lat_lon.scy$lon,all_lat_lon.scy$lon) #need to fix the lat lons
all_lat_lon.scy$ocean.basin=scy.info$ocean.basin[match(all_lat_lon.scy$lat,scy.info$lat)]

ll_chk1=subset(all_lat_lon.scy,ocean.basin=='WC')
ll_chk2=subset(all_lat_lon.scy,ocean.basin=='SEAK')
ll_chk3=subset(all_lat_lon.scy,ocean.basin=='GOA')
ll_chk4=subset(all_lat_lon.scy,ocean.basin=='BS')


map=ggplot(data = world) + 
  geom_sf(fill= 'antiquewhite') +  xlab("") + ylab("") +
  geom_point(data =  ll_chk4, mapping = aes(x = lon, y = lat), color = basin_cols[4], size = 2.5*log(ll_chk4$n+2), alpha = 0.7) +
  geom_point(data =  ll_chk3, mapping = aes(x = lon, y = lat), color =basin_cols[3], size = 2.5*log(ll_chk3$n+2), alpha = 0.7) +
  geom_point(data =  ll_chk2, mapping = aes(x = lon, y = lat), color = basin_cols[2], size = 2.5*log(ll_chk2$n+2), alpha = 0.7) +
  geom_point(data =  ll_chk1, mapping = aes(x = lon, y = lat), color =basin_cols[1], size = 2.5*log(ll_chk1$n+2), alpha = 0.7) +
  annotate(geom = 'point', x = -165, y = 50, size = 2.5*log(1+2)) +
  annotate(geom = 'point', x = -165, y = 49, size = 2.5*log(3+2)) + 
  annotate(geom = 'point', x = -165, y = 48, size = 2.5*log(10+2)) + 
  annotate(geom = 'point', x = -165, y = 47, size = 2.5*log(20+2)) + 
  annotate(geom = 'text', x = -165, y = 51,label='n', size = 6) +
  annotate(geom = 'text', x = -162, y = 50,label='1', size = 5) +
  annotate(geom = 'text', x = -162, y = 49,label='3', size = 5) + 
  annotate(geom = 'text', x = -162, y = 48,label='10', size = 5) + 
  annotate(geom = 'text', x = -162, y = 47,label='20', size = 5) + 
  annotate(geom = 'text', x = -134, y = 50.5, label = 'West Coast', color = basin_cols[1], size = 7) + 
  annotate(geom = 'text', x = -134, y = 49.5, label = paste('n =', length(scy.wc)), color = basin_cols[1], size = 5) + 
  annotate(geom = 'text', x = -138, y = 54.5, label = 'SE Alaska', color = basin_cols[2], size = 7) + 
  annotate(geom = 'text', x = -138, y = 53.5, label = paste('n =', length(scy.seak)), color = basin_cols[2], size = 5) + 
  annotate(geom = 'text', x = -145, y = 57.5, label = 'Gulf of Alaska', color = basin_cols[3], size = 7) + 
  annotate(geom = 'text', x = -145, y = 56.5, label = paste('n =', length(scy.goa)), color = basin_cols[3], size = 5) + 
  annotate(geom = 'text', x = -164, y = 58, label = 'Bering Sea', color = basin_cols[4], size = 7) + 
  annotate(geom = 'text', x = -164, y = 57, label = paste('n =', length(scy.bs)), color = basin_cols[4], size = 5) + 
  annotation_scale(location = 'bl', width_hint = 0.5) + 
  annotation_north_arrow(location = 'bl', which_north = 'true', pad_x = unit(0.35, 'in'), pad_y = unit(0.25, 'in'), style = north_arrow_fancy_orienteering) + 
  coord_sf(xlim = c(-170, -124), ylim = c(46, 72), expand = T) +
  theme(panel.background = element_rect(fill = 'white'),legend.title = element_blank())

cowplot::plot_grid(prod,map,labels=c('A.','B.'),rel_widths = c(0.5,0.5))
```

###Chum
```{r,lme tvprod chm,fig.height=7,fig.width=16}
loga.chm=tv.chm$draws(variables='log_a_t',format='draws_matrix')
loga.chm.wc=loga.chm[,chm.wc]
loga.chm.seak=loga.chm[,chm.seak]
loga.chm.goa=loga.chm[,chm.goa]
loga.chm.bs=loga.chm[,chm.bs]

L=max(chm.info$end)-min(chm.info$begin)+1

#mean log(a) - WEst coast
mu_loga.chm.wc=matrix(nrow=nrow(loga.chm),ncol=L)
subset.rows=paste(',',chm.wc,']',sep='') #column name construction
subset.rows2=paste(subset.rows, collapse = "|") #conditional for grepl
wc.loga.chm=loga.chm[,grepl(subset.rows2,colnames(loga.chm))] #all log-a estimates for WC stocks
logat=wc.loga.chm
for(t in 1:L){
  colnames(logat)=gsub("]", ".", colnames(logat))
  colnames(logat)=gsub("log_a_t[", "log_a_t.", colnames(logat),fixed=T)
  
  logas=logat[,grepl(paste('log_a_t.',t,',',sep=''),colnames(logat))]
  mu_loga.chm.wc[,t]=apply(logas,1,mean)
}    

#mean log(a) - SE Alaska/NBC
mu_loga.chm.seak=matrix(nrow=nrow(loga.chm),ncol=L)
subset.rows=paste(',',chm.seak,']',sep='') #column name construction
subset.rows2=paste(subset.rows, collapse = "|") #conditional for grepl
seak.loga.chm=loga.chm[,grepl(subset.rows2,colnames(loga.chm))] #all log-a estimates for WC stocks
logat=seak.loga.chm
for(t in 1:L){
  colnames(logat)=gsub("]", ".", colnames(logat))
  colnames(logat)=gsub("log_a_t[", "log_a_t.", colnames(logat),fixed=T)
  
  logas=logat[,grepl(paste('log_a_t.',t,',',sep=''),colnames(logat))]
  mu_loga.chm.seak[,t]=apply(logas,1,mean)
}    

#mean log(a) - Gulf of Alaska
mu_loga.chm.goa=matrix(nrow=nrow(loga.chm),ncol=L)
subset.rows=paste(',',chm.goa,']',sep='') #column name construction
subset.rows2=paste(subset.rows, collapse = "|") #conditional for grepl
goa.loga.chm=loga.chm[,grepl(subset.rows2,colnames(loga.chm))] #all log-a estimates for WC stocks
logat=goa.loga.chm
for(t in 1:L){
  colnames(logat)=gsub("]", ".", colnames(logat))
  colnames(logat)=gsub("log_a_t[", "log_a_t.", colnames(logat),fixed=T)
  
  logas=logat[,grepl(paste('log_a_t.',t,',',sep=''),colnames(logat))]
  mu_loga.chm.goa[,t]=apply(logas,1,mean)
}    

#mean log(a) - Bering sea
mu_loga.chm.bs=matrix(nrow=nrow(loga.chm),ncol=L)
subset.rows=paste(',',chm.bs,']',sep='') #column name construction
subset.rows2=paste(subset.rows, collapse = "|") #conditional for grepl
bs.loga.chm=loga.chm[,grepl(subset.rows2,colnames(loga.chm))] #all log-a estimates for WC stocks
logat=bs.loga.chm
for(t in 1:L){
  colnames(logat)=gsub("]", ".", colnames(logat))
  colnames(logat)=gsub("log_a_t[", "log_a_t.", colnames(logat),fixed=T)
  
  logas=logat[,grepl(paste('log_a_t.',t,',',sep=''),colnames(logat))]
  mu_loga.chm.bs[,t]=apply(logas,1,mean)
}    

df=data.frame(by=seq(min(chm.info$begin),max(chm.info$end)),
              y.bs=apply(exp(mu_loga.chm.bs),2,median),y.bsl90=apply(exp(mu_loga.chm.bs),2,quantile,0.05),y.bsu90=apply(exp(mu_loga.chm.bs),2,quantile,0.95),
              y.goa=apply(exp(mu_loga.chm.goa),2,median),y.goal90=apply(exp(mu_loga.chm.goa),2,quantile,0.05),y.goau90=apply(exp(mu_loga.chm.goa),2,quantile,0.95),
              y.seak=apply(exp(mu_loga.chm.seak),2,median),y.seakl90=apply(exp(mu_loga.chm.seak),2,quantile,0.05),y.seaku90=apply(exp(mu_loga.chm.seak),2,quantile,0.95),
              y.wc=apply(exp(mu_loga.chm.wc),2,median),y.wcl90=apply(exp(mu_loga.chm.wc),2,quantile,0.05),y.wcu90=apply(exp(mu_loga.chm.wc),2,quantile,0.95)
)
mytheme = list(
  theme_classic(14)+
    theme(panel.background = element_blank(),strip.background = element_rect(colour=NA, fill=NA),panel.border = element_blank(),
          legend.title = element_blank(),legend.position="bottom", strip.text = element_text(face="bold", size=13),
          axis.text=element_text(face="bold"),axis.title = element_text(face="bold",size=16),plot.title = element_text(face = "bold", hjust = 0.5,size=16))
)

prod=ggplot(df,aes(x=by,y=y.bs))+
  ylim(1,10)+
  geom_line(aes(y=y.bs),color=basin_cols[4],size=2)+
  geom_ribbon(aes(ymin = y.bsl90, ymax = y.bsu90), fill = basin_cols[4], alpha = 0.1) +
  geom_line(aes(y=y.goa),color=basin_cols[3],size=2)+
  geom_ribbon(aes(ymin = y.goal90, ymax = y.goau90), fill = basin_cols[3], alpha = 0.1) +
  geom_line(aes(y=y.seak),color=basin_cols[2],size=2)+
  geom_ribbon(aes(ymin = y.seakl90, ymax = y.seaku90), fill = basin_cols[2], alpha = 0.1) +
  geom_line(aes(y=y.wc),color=basin_cols[1],size=2)+
  geom_ribbon(aes(ymin = y.wcl90, ymax = y.wcu90), fill = basin_cols[1], alpha = 0.1) +
  xlab('Brood cohort year')+
  ylab(expression(paste('Mean productivity, max. R/S')))+
  ggtitle('Chum')+
  mytheme

world <- rnaturalearth::ne_countries(scale = "medium", returnclass = "sf")

all_lat_lon.chm = chm.info %>% group_by(lat,lon) %>% summarize(n=n(),.groups = 'keep')
all_lat_lon.chm$lon=ifelse(all_lat_lon.chm$lon>0,-all_lat_lon.chm$lon,all_lat_lon.chm$lon) #need to fix the lat lons
all_lat_lon.chm$ocean.basin=chm.info$ocean.basin[match(all_lat_lon.chm$lat,chm.info$lat)]

ll_chk1=subset(all_lat_lon.chm,ocean.basin=='WC')
ll_chk2=subset(all_lat_lon.chm,ocean.basin=='SEAK')
ll_chk3=subset(all_lat_lon.chm,ocean.basin=='GOA')
ll_chk4=subset(all_lat_lon.chm,ocean.basin=='BS')


map=ggplot(data = world) + 
  geom_sf(fill= 'antiquewhite') +  xlab("") + ylab("") +
  geom_point(data =  ll_chk4, mapping = aes(x = lon, y = lat), color = basin_cols[4], size = 2.5*log(ll_chk4$n+2), alpha = 0.7) +
  geom_point(data =  ll_chk3, mapping = aes(x = lon, y = lat), color =basin_cols[3], size = 2.5*log(ll_chk3$n+2), alpha = 0.7) +
  geom_point(data =  ll_chk2, mapping = aes(x = lon, y = lat), color = basin_cols[2], size = 2.5*log(ll_chk2$n+2), alpha = 0.7) +
  geom_point(data =  ll_chk1, mapping = aes(x = lon, y = lat), color =basin_cols[1], size = 2.5*log(ll_chk1$n+2), alpha = 0.7) +
  annotate(geom = 'point', x = -165, y = 50, size = 2.5*log(1+2)) +
  annotate(geom = 'point', x = -165, y = 49, size = 2.5*log(3+2)) + 
  annotate(geom = 'point', x = -165, y = 48, size = 2.5*log(10+2)) + 
  annotate(geom = 'point', x = -165, y = 47, size = 2.5*log(20+2)) + 
  annotate(geom = 'text', x = -165, y = 51,label='n', size = 6) +
  annotate(geom = 'text', x = -162, y = 50,label='1', size = 5) +
  annotate(geom = 'text', x = -162, y = 49,label='3', size = 5) + 
  annotate(geom = 'text', x = -162, y = 48,label='10', size = 5) + 
  annotate(geom = 'text', x = -162, y = 47,label='20', size = 5) + 
  annotate(geom = 'text', x = -134, y = 50.5, label = 'West Coast', color = basin_cols[1], size = 7) + 
  annotate(geom = 'text', x = -134, y = 49.5, label = paste('n =', length(chm.wc)), color = basin_cols[1], size = 5) + 
  annotate(geom = 'text', x = -138, y = 54.5, label = 'SE Alaska', color = basin_cols[2], size = 7) + 
  annotate(geom = 'text', x = -138, y = 53.5, label = paste('n =', length(chm.seak)), color = basin_cols[2], size = 5) + 
  annotate(geom = 'text', x = -145, y = 57.5, label = 'Gulf of Alaska', color = basin_cols[3], size = 7) + 
  annotate(geom = 'text', x = -145, y = 56.5, label = paste('n =', length(chm.goa)), color = basin_cols[3], size = 5) + 
  annotate(geom = 'text', x = -164, y = 58, label = 'Bering Sea', color = basin_cols[4], size = 7) + 
  annotate(geom = 'text', x = -164, y = 57, label = paste('n =', length(chm.bs)), color = basin_cols[4], size = 5) + 
  annotation_scale(location = 'bl', width_hint = 0.5) + 
  annotation_north_arrow(location = 'bl', which_north = 'true', pad_x = unit(0.35, 'in'), pad_y = unit(0.25, 'in'), style = north_arrow_fancy_orienteering) + 
  coord_sf(xlim = c(-170, -124), ylim = c(46, 72), expand = T) +
  theme(panel.background = element_rect(fill = 'white'),legend.title = element_blank())

cowplot::plot_grid(prod,map,labels=c('A.','B.'),rel_widths = c(0.5,0.5))

```


###Coho
```{r,lme tvprod cho,fig.height=7,fig.width=16}
loga.cho=tv.cho$draws(variables='log_a_t',format='draws_matrix')
loga.cho.wc=loga.cho[,cho.wc]
loga.cho.seak=loga.cho[,cho.seak]
loga.cho.goa=loga.cho[,cho.goa]
loga.cho.bs=loga.cho[,cho.bs]

L=max(cho.info$end)-min(cho.info$begin)+1

#mean log(a) - WEst coast
mu_loga.cho.wc=matrix(nrow=nrow(loga.cho),ncol=L)
subset.rows=paste(',',cho.wc,']',sep='') #column name construction
subset.rows2=paste(subset.rows, collapse = "|") #conditional for grepl
wc.loga.cho=loga.cho[,grepl(subset.rows2,colnames(loga.cho))] #all log-a estimates for WC stocks
logat=wc.loga.cho
for(t in 1:L){
  colnames(logat)=gsub("]", ".", colnames(logat))
  colnames(logat)=gsub("log_a_t[", "log_a_t.", colnames(logat),fixed=T)
  
  logas=logat[,grepl(paste('log_a_t.',t,',',sep=''),colnames(logat))]
  mu_loga.cho.wc[,t]=apply(logas,1,mean)
}    

#mean log(a) - SE Alaska/NBC
mu_loga.cho.seak=matrix(nrow=nrow(loga.cho),ncol=L)
subset.rows=paste(',',cho.seak,']',sep='') #column name construction
subset.rows2=paste(subset.rows, collapse = "|") #conditional for grepl
seak.loga.cho=loga.cho[,grepl(subset.rows2,colnames(loga.cho))] #all log-a estimates for WC stocks
logat=seak.loga.cho
for(t in 1:L){
  colnames(logat)=gsub("]", ".", colnames(logat))
  colnames(logat)=gsub("log_a_t[", "log_a_t.", colnames(logat),fixed=T)
  
  logas=logat[,grepl(paste('log_a_t.',t,',',sep=''),colnames(logat))]
  mu_loga.cho.seak[,t]=apply(logas,1,mean)
}    

#mean log(a) - Gulf of Alaska
mu_loga.cho.goa=matrix(nrow=nrow(loga.cho),ncol=L)
subset.rows=paste(',',cho.goa,']',sep='') #column name construction
subset.rows2=paste(subset.rows, collapse = "|") #conditional for grepl
goa.loga.cho=loga.cho[,grepl(subset.rows2,colnames(loga.cho))] #all log-a estimates for WC stocks
logat=goa.loga.cho
for(t in 1:L){
  colnames(logat)=gsub("]", ".", colnames(logat))
  colnames(logat)=gsub("log_a_t[", "log_a_t.", colnames(logat),fixed=T)
  
  logas=logat[,grepl(paste('log_a_t.',t,',',sep=''),colnames(logat))]
  mu_loga.cho.goa[,t]=apply(logas,1,mean)
}    

df=data.frame(by=seq(min(cho.info$begin),max(cho.info$end)),
              y.goa=apply(exp(mu_loga.cho.goa),2,median),y.goal90=apply(exp(mu_loga.cho.goa),2,quantile,0.05),y.goau90=apply(exp(mu_loga.cho.goa),2,quantile,0.95),
              y.seak=apply(exp(mu_loga.cho.seak),2,median),y.seakl90=apply(exp(mu_loga.cho.seak),2,quantile,0.05),y.seaku90=apply(exp(mu_loga.cho.seak),2,quantile,0.95),
              y.wc=apply(exp(mu_loga.cho.wc),2,median),y.wcl90=apply(exp(mu_loga.cho.wc),2,quantile,0.05),y.wcu90=apply(exp(mu_loga.cho.wc),2,quantile,0.95)
)
mytheme = list(
  theme_classic(14)+
    theme(panel.background = element_blank(),strip.background = element_rect(colour=NA, fill=NA),panel.border = element_blank(),
          legend.title = element_blank(),legend.position="bottom", strip.text = element_text(face="bold", size=13),
          axis.text=element_text(face="bold"),axis.title = element_text(face="bold",size=16),plot.title = element_text(face = "bold", hjust = 0.5,size=16))
)

prod=ggplot(df,aes(x=by,y=y.goa))+
  ylim(1,10)+
  geom_line(aes(y=y.goa),color=basin_cols[3],size=2)+
  geom_ribbon(aes(ymin = y.goal90, ymax = y.goau90), fill = basin_cols[3], alpha = 0.1) +
  geom_line(aes(y=y.seak),color=basin_cols[2],size=2)+
  geom_ribbon(aes(ymin = y.seakl90, ymax = y.seaku90), fill = basin_cols[2], alpha = 0.1) +
  geom_line(aes(y=y.wc),color=basin_cols[1],size=2)+
  geom_ribbon(aes(ymin = y.wcl90, ymax = y.wcu90), fill = basin_cols[1], alpha = 0.1) +
  xlab('Brood cohort year')+
  ylab(expression(paste('Mean productivity, max. R/S')))+
  ggtitle('Coho')+
  mytheme

world <- rnaturalearth::ne_countries(scale = "medium", returnclass = "sf")

all_lat_lon.cho = cho.info %>% group_by(lat,lon) %>% summarize(n=n(),.groups = 'keep')
all_lat_lon.cho$lon=ifelse(all_lat_lon.cho$lon>0,-all_lat_lon.cho$lon,all_lat_lon.cho$lon) #need to fix the lat lons
all_lat_lon.cho$ocean.basin=cho.info$ocean.basin[match(all_lat_lon.cho$lat,cho.info$lat)]

ll_chk1=subset(all_lat_lon.cho,ocean.basin=='WC')
ll_chk2=subset(all_lat_lon.cho,ocean.basin=='SEAK')
ll_chk3=subset(all_lat_lon.cho,ocean.basin=='GOA')


map=ggplot(data = world) + 
  geom_sf(fill= 'antiquewhite') +  xlab("") + ylab("") +
  geom_point(data =  ll_chk3, mapping = aes(x = lon, y = lat), color =basin_cols[3], size = 2.5*log(ll_chk3$n+2), alpha = 0.7) +
  geom_point(data =  ll_chk2, mapping = aes(x = lon, y = lat), color = basin_cols[2], size = 2.5*log(ll_chk2$n+2), alpha = 0.7) +
  geom_point(data =  ll_chk1, mapping = aes(x = lon, y = lat), color =basin_cols[1], size = 2.5*log(ll_chk1$n+2), alpha = 0.7) +
  annotate(geom = 'point', x = -165, y = 50, size = 2.5*log(1+2)) +
  annotate(geom = 'point', x = -165, y = 49, size = 2.5*log(3+2)) + 
  annotate(geom = 'point', x = -165, y = 48, size = 2.5*log(10+2)) + 
  annotate(geom = 'point', x = -165, y = 47, size = 2.5*log(20+2)) + 
  annotate(geom = 'text', x = -165, y = 51,label='n', size = 6) +
  annotate(geom = 'text', x = -162, y = 50,label='1', size = 5) +
  annotate(geom = 'text', x = -162, y = 49,label='3', size = 5) + 
  annotate(geom = 'text', x = -162, y = 48,label='10', size = 5) + 
  annotate(geom = 'text', x = -162, y = 47,label='20', size = 5) + 
  annotate(geom = 'text', x = -134, y = 50.5, label = 'West Coast', color = basin_cols[1], size = 7) + 
  annotate(geom = 'text', x = -134, y = 49.5, label = paste('n =', length(cho.wc)), color = basin_cols[1], size = 5) + 
  annotate(geom = 'text', x = -138, y = 54.5, label = 'SE Alaska', color = basin_cols[2], size = 7) + 
  annotate(geom = 'text', x = -138, y = 53.5, label = paste('n =', length(cho.seak)), color = basin_cols[2], size = 5) + 
  annotate(geom = 'text', x = -145, y = 57.5, label = 'Gulf of Alaska', color = basin_cols[3], size = 7) + 
  annotate(geom = 'text', x = -145, y = 56.5, label = paste('n =', length(cho.goa)), color = basin_cols[3], size = 5) + 
  annotate(geom = 'text', x = -164, y = 58, label = 'Bering Sea', color = basin_cols[4], size = 7) + 
  annotate(geom = 'text', x = -164, y = 57, label = paste('n =', length(cho.bs)), color = basin_cols[4], size = 5) + 
  annotation_scale(location = 'bl', width_hint = 0.5) + 
  annotation_north_arrow(location = 'bl', which_north = 'true', pad_x = unit(0.35, 'in'), pad_y = unit(0.25, 'in'), style = north_arrow_fancy_orienteering) + 
  coord_sf(xlim = c(-170, -124), ylim = c(46, 72), expand = T) +
  theme(panel.background = element_rect(fill = 'white'),legend.title = element_blank())

cowplot::plot_grid(prod,map,labels=c('A.','B.'),rel_widths = c(0.5,0.5))
```


###Pink (even)
```{r,lme tvprod pke,fig.height=7,fig.width=16}
loga.pke=tv.pke$draws(variables='log_a_t',format='draws_matrix')
loga.pke.wc=loga.pke[,pke.wc]
loga.pke.seak=loga.pke[,pke.seak]
loga.pke.goa=loga.pke[,pke.goa]
loga.pke.bs=loga.pke[,pke.bs]

L=max(pke.info$end)-min(pke.info$begin)+1

#mean log(a) - WEst coast
mu_loga.pke.wc=matrix(nrow=nrow(loga.pke),ncol=L)
subset.rows=paste(',',pke.wc,']',sep='') #column name construction
subset.rows2=paste(subset.rows, collapse = "|") #conditional for grepl
wc.loga.pke=loga.pke[,grepl(subset.rows2,colnames(loga.pke))] #all log-a estimates for WC stocks
logat=wc.loga.pke
for(t in 1:L){
  colnames(logat)=gsub("]", ".", colnames(logat))
  colnames(logat)=gsub("log_a_t[", "log_a_t.", colnames(logat),fixed=T)
  
  logas=logat[,grepl(paste('log_a_t.',t,',',sep=''),colnames(logat))]
  mu_loga.pke.wc[,t]=apply(logas,1,mean)
}    

#mean log(a) - SE Alaska/NBC
mu_loga.pke.seak=matrix(nrow=nrow(loga.pke),ncol=L)
subset.rows=paste(',',pke.seak,']',sep='') #column name construction
subset.rows2=paste(subset.rows, collapse = "|") #conditional for grepl
seak.loga.pke=loga.pke[,grepl(subset.rows2,colnames(loga.pke))] #all log-a estimates for WC stocks
logat=seak.loga.pke
for(t in 1:L){
  colnames(logat)=gsub("]", ".", colnames(logat))
  colnames(logat)=gsub("log_a_t[", "log_a_t.", colnames(logat),fixed=T)
  
  logas=logat[,grepl(paste('log_a_t.',t,',',sep=''),colnames(logat))]
  mu_loga.pke.seak[,t]=apply(logas,1,mean)
}    

#mean log(a) - Gulf of Alaska
mu_loga.pke.goa=matrix(nrow=nrow(loga.pke),ncol=L)
subset.rows=paste(',',pke.goa,']',sep='') #column name construction
subset.rows2=paste(subset.rows, collapse = "|") #conditional for grepl
goa.loga.pke=loga.pke[,grepl(subset.rows2,colnames(loga.pke))] #all log-a estimates for WC stocks
logat=goa.loga.pke
for(t in 1:L){
  colnames(logat)=gsub("]", ".", colnames(logat))
  colnames(logat)=gsub("log_a_t[", "log_a_t.", colnames(logat),fixed=T)
  
  logas=logat[,grepl(paste('log_a_t.',t,',',sep=''),colnames(logat))]
  mu_loga.pke.goa[,t]=apply(logas,1,mean)
}    

#mean log(a) - Bering sea
mu_loga.pke.bs=matrix(nrow=nrow(loga.pke),ncol=L)
subset.rows=paste(',',pke.bs,']',sep='') #column name construction
subset.rows2=paste(subset.rows, collapse = "|") #conditional for grepl
bs.loga.pke=loga.pke[,grepl(subset.rows2,colnames(loga.pke))] #all log-a estimates for WC stocks
logat=bs.loga.pke
for(t in 1:L){
  colnames(logat)=gsub("]", ".", colnames(logat))
  colnames(logat)=gsub("log_a_t[", "log_a_t.", colnames(logat),fixed=T)
  
  logas=logat[,grepl(paste('log_a_t.',t,',',sep=''),colnames(logat))]
  mu_loga.pke.bs[,t]=apply(logas,1,mean)
}    

df=data.frame(by=seq(min(pke.info$begin),max(pke.info$end)),
              y.bs=apply(exp(mu_loga.pke.bs),2,median),y.bsl90=apply(exp(mu_loga.pke.bs),2,quantile,0.05),y.bsu90=apply(exp(mu_loga.pke.bs),2,quantile,0.95),
              y.goa=apply(exp(mu_loga.pke.goa),2,median),y.goal90=apply(exp(mu_loga.pke.goa),2,quantile,0.05),y.goau90=apply(exp(mu_loga.pke.goa),2,quantile,0.95),
              y.seak=apply(exp(mu_loga.pke.seak),2,median),y.seakl90=apply(exp(mu_loga.pke.seak),2,quantile,0.05),y.seaku90=apply(exp(mu_loga.pke.seak),2,quantile,0.95),
              y.wc=apply(exp(mu_loga.pke.wc),2,median),y.wcl90=apply(exp(mu_loga.pke.wc),2,quantile,0.05),y.wcu90=apply(exp(mu_loga.pke.wc),2,quantile,0.95)
)
mytheme = list(
  theme_classic(14)+
    theme(panel.background = element_blank(),strip.background = element_rect(colour=NA, fill=NA),panel.border = element_blank(),
          legend.title = element_blank(),legend.position="bottom", strip.text = element_text(face="bold", size=13),
          axis.text=element_text(face="bold"),axis.title = element_text(face="bold",size=16),plot.title = element_text(face = "bold", hjust = 0.5,size=16))
)

prod=ggplot(df,aes(x=by,y=y.bs))+
  ylim(1,10)+
  geom_line(aes(y=y.bs),color=basin_cols[4],size=2)+
  geom_ribbon(aes(ymin = y.bsl90, ymax = y.bsu90), fill = basin_cols[4], alpha = 0.1) +
  geom_line(aes(y=y.goa),color=basin_cols[3],size=2)+
  geom_ribbon(aes(ymin = y.goal90, ymax = y.goau90), fill = basin_cols[3], alpha = 0.1) +
  geom_line(aes(y=y.seak),color=basin_cols[2],size=2)+
  geom_ribbon(aes(ymin = y.seakl90, ymax = y.seaku90), fill = basin_cols[2], alpha = 0.1) +
  geom_line(aes(y=y.wc),color=basin_cols[1],size=2)+
  geom_ribbon(aes(ymin = y.wcl90, ymax = y.wcu90), fill = basin_cols[1], alpha = 0.1) +
  xlab('Brood cohort year')+
  ylab(expression(paste('Mean productivity, max. R/S')))+
  ggtitle('Pink - even year lines')+
  mytheme

world <- rnaturalearth::ne_countries(scale = "medium", returnclass = "sf")

all_lat_lon.pke = pke.info %>% group_by(lat,lon) %>% summarize(n=n(),.groups = 'keep')
all_lat_lon.pke$lon=ifelse(all_lat_lon.pke$lon>0,-all_lat_lon.pke$lon,all_lat_lon.pke$lon) #need to fix the lat lons
all_lat_lon.pke$ocean.basin=pke.info$ocean.basin[match(all_lat_lon.pke$lat,pke.info$lat)]

ll_chk1=subset(all_lat_lon.pke,ocean.basin=='WC')
ll_chk2=subset(all_lat_lon.pke,ocean.basin=='SEAK')
ll_chk3=subset(all_lat_lon.pke,ocean.basin=='GOA')
ll_chk4=subset(all_lat_lon.pke,ocean.basin=='BS')


map=ggplot(data = world) + 
  geom_sf(fill= 'antiquewhite') +  xlab("") + ylab("") +
  geom_point(data =  ll_chk4, mapping = aes(x = lon, y = lat), color = basin_cols[4], size = 2.5*log(ll_chk4$n+2), alpha = 0.7) +
  geom_point(data =  ll_chk3, mapping = aes(x = lon, y = lat), color =basin_cols[3], size = 2.5*log(ll_chk3$n+2), alpha = 0.7) +
  geom_point(data =  ll_chk2, mapping = aes(x = lon, y = lat), color = basin_cols[2], size = 2.5*log(ll_chk2$n+2), alpha = 0.7) +
  geom_point(data =  ll_chk1, mapping = aes(x = lon, y = lat), color =basin_cols[1], size = 2.5*log(ll_chk1$n+2), alpha = 0.7) +
  annotate(geom = 'point', x = -165, y = 50, size = 2.5*log(1+2)) +
  annotate(geom = 'point', x = -165, y = 49, size = 2.5*log(3+2)) + 
  annotate(geom = 'point', x = -165, y = 48, size = 2.5*log(10+2)) + 
  annotate(geom = 'point', x = -165, y = 47, size = 2.5*log(20+2)) + 
  annotate(geom = 'text', x = -165, y = 51,label='n', size = 6) +
  annotate(geom = 'text', x = -162, y = 50,label='1', size = 5) +
  annotate(geom = 'text', x = -162, y = 49,label='3', size = 5) + 
  annotate(geom = 'text', x = -162, y = 48,label='10', size = 5) + 
  annotate(geom = 'text', x = -162, y = 47,label='20', size = 5) + 
  annotate(geom = 'text', x = -134, y = 50.5, label = 'West Coast', color = basin_cols[1], size = 7) + 
  annotate(geom = 'text', x = -134, y = 49.5, label = paste('n =', length(pke.wc)), color = basin_cols[1], size = 5) + 
  annotate(geom = 'text', x = -138, y = 54.5, label = 'SE Alaska', color = basin_cols[2], size = 7) + 
  annotate(geom = 'text', x = -138, y = 53.5, label = paste('n =', length(pke.seak)), color = basin_cols[2], size = 5) + 
  annotate(geom = 'text', x = -145, y = 57.5, label = 'Gulf of Alaska', color = basin_cols[3], size = 7) + 
  annotate(geom = 'text', x = -145, y = 56.5, label = paste('n =', length(pke.goa)), color = basin_cols[3], size = 5) + 
  annotate(geom = 'text', x = -164, y = 58, label = 'Bering Sea', color = basin_cols[4], size = 7) + 
  annotate(geom = 'text', x = -164, y = 57, label = paste('n =', length(pke.bs)), color = basin_cols[4], size = 5) + 
  annotation_scale(location = 'bl', width_hint = 0.5) + 
  annotation_north_arrow(location = 'bl', which_north = 'true', pad_x = unit(0.35, 'in'), pad_y = unit(0.25, 'in'), style = north_arrow_fancy_orienteering) + 
  coord_sf(xlim = c(-170, -124), ylim = c(46, 72), expand = T) +
  theme(panel.background = element_rect(fill = 'white'),legend.title = element_blank())

cowplot::plot_grid(prod,map,labels=c('A.','B.'),rel_widths = c(0.5,0.5))
```


###Pink (odd)
```{r,lme tvprod pko,fig.height=7,fig.width=16}
loga.pko=tv.pko$draws(variables='log_a_t',format='draws_matrix')
loga.pko.wc=loga.pko[,pko.wc]
loga.pko.seak=loga.pko[,pko.seak]
loga.pko.goa=loga.pko[,pko.goa]
loga.pko.bs=loga.pko[,pko.bs]

L=max(pko.info$end)-min(pko.info$begin)+1

#mean log(a) - WEst coast
mu_loga.pko.wc=matrix(nrow=nrow(loga.pko),ncol=L)
subset.rows=paste(',',pko.wc,']',sep='') #column name construction
subset.rows2=paste(subset.rows, collapse = "|") #conditional for grepl
wc.loga.pko=loga.pko[,grepl(subset.rows2,colnames(loga.pko))] #all log-a estimates for WC stocks
logat=wc.loga.pko
for(t in 1:L){
  colnames(logat)=gsub("]", ".", colnames(logat))
  colnames(logat)=gsub("log_a_t[", "log_a_t.", colnames(logat),fixed=T)
  
  logas=logat[,grepl(paste('log_a_t.',t,',',sep=''),colnames(logat))]
  mu_loga.pko.wc[,t]=apply(logas,1,mean)
}    

#mean log(a) - SE Alaska/NBC
mu_loga.pko.seak=matrix(nrow=nrow(loga.pko),ncol=L)
subset.rows=paste(',',pko.seak,']',sep='') #column name construction
subset.rows2=paste(subset.rows, collapse = "|") #conditional for grepl
seak.loga.pko=loga.pko[,grepl(subset.rows2,colnames(loga.pko))] #all log-a estimates for WC stocks
logat=seak.loga.pko
for(t in 1:L){
  colnames(logat)=gsub("]", ".", colnames(logat))
  colnames(logat)=gsub("log_a_t[", "log_a_t.", colnames(logat),fixed=T)
  
  logas=logat[,grepl(paste('log_a_t.',t,',',sep=''),colnames(logat))]
  mu_loga.pko.seak[,t]=apply(logas,1,mean)
}    

#mean log(a) - Gulf of Alaska
mu_loga.pko.goa=matrix(nrow=nrow(loga.pko),ncol=L)
subset.rows=paste(',',pko.goa,']',sep='') #column name construction
subset.rows2=paste(subset.rows, collapse = "|") #conditional for grepl
goa.loga.pko=loga.pko[,grepl(subset.rows2,colnames(loga.pko))] #all log-a estimates for WC stocks
logat=goa.loga.pko
for(t in 1:L){
  colnames(logat)=gsub("]", ".", colnames(logat))
  colnames(logat)=gsub("log_a_t[", "log_a_t.", colnames(logat),fixed=T)
  
  logas=logat[,grepl(paste('log_a_t.',t,',',sep=''),colnames(logat))]
  mu_loga.pko.goa[,t]=apply(logas,1,mean)
}    

#mean log(a) - Bering sea
mu_loga.pko.bs=matrix(nrow=nrow(loga.pko),ncol=L)
subset.rows=paste(',',pko.bs,']',sep='') #column name construction
subset.rows2=paste(subset.rows, collapse = "|") #conditional for grepl
bs.loga.pko=loga.pko[,grepl(subset.rows2,colnames(loga.pko))] #all log-a estimates for WC stocks
logat=bs.loga.pko
for(t in 1:L){
  colnames(logat)=gsub("]", ".", colnames(logat))
  colnames(logat)=gsub("log_a_t[", "log_a_t.", colnames(logat),fixed=T)
  
  logas=logat[,grepl(paste('log_a_t.',t,',',sep=''),colnames(logat))]
  mu_loga.pko.bs[,t]=apply(logas,1,mean)
}    

df=data.frame(by=seq(min(pko.info$begin),max(pko.info$end)),
              y.bs=apply(exp(mu_loga.pko.bs),2,median),y.bsl90=apply(exp(mu_loga.pko.bs),2,quantile,0.05),y.bsu90=apply(exp(mu_loga.pko.bs),2,quantile,0.95),
              y.goa=apply(exp(mu_loga.pko.goa),2,median),y.goal90=apply(exp(mu_loga.pko.goa),2,quantile,0.05),y.goau90=apply(exp(mu_loga.pko.goa),2,quantile,0.95),
              y.seak=apply(exp(mu_loga.pko.seak),2,median),y.seakl90=apply(exp(mu_loga.pko.seak),2,quantile,0.05),y.seaku90=apply(exp(mu_loga.pko.seak),2,quantile,0.95),
              y.wc=apply(exp(mu_loga.pko.wc),2,median),y.wcl90=apply(exp(mu_loga.pko.wc),2,quantile,0.05),y.wcu90=apply(exp(mu_loga.pko.wc),2,quantile,0.95)
)
mytheme = list(
  theme_classic(14)+
    theme(panel.background = element_blank(),strip.background = element_rect(colour=NA, fill=NA),panel.border = element_blank(),
          legend.title = element_blank(),legend.position="bottom", strip.text = element_text(face="bold", size=13),
          axis.text=element_text(face="bold"),axis.title = element_text(face="bold",size=16),plot.title = element_text(face = "bold", hjust = 0.5,size=16))
)

prod=ggplot(df,aes(x=by,y=y.bs))+
  ylim(1,10)+
  geom_ribbon(aes(ymin = y.bsl90, ymax = y.bsu90), fill = basin_cols[4], alpha = 0.1) +
  geom_ribbon(aes(ymin = y.goal90, ymax = y.goau90), fill = basin_cols[3], alpha = 0.1) +
  geom_ribbon(aes(ymin = y.seakl90, ymax = y.seaku90), fill = basin_cols[2], alpha = 0.1) +
  geom_ribbon(aes(ymin = y.wcl90, ymax = y.wcu90), fill = basin_cols[1], alpha = 0.1) +
  geom_line(aes(y=y.bs),color=basin_cols[4],size=2)+
  geom_line(aes(y=y.goa),color=basin_cols[3],size=2)+
  geom_line(aes(y=y.seak),color=basin_cols[2],size=2)+
  geom_line(aes(y=y.wc),color=basin_cols[1],size=2)+
  xlab('Brood cohort year')+
  ylab(expression(paste('Mean productivity, max. R/S')))+
  ggtitle('Pink - Odd')+
  mytheme

world <- rnaturalearth::ne_countries(scale = "medium", returnclass = "sf")

all_lat_lon.pko = pko.info %>% group_by(lat,lon) %>% summarize(n=n(),.groups = 'keep')
all_lat_lon.pko$lon=ifelse(all_lat_lon.pko$lon>0,-all_lat_lon.pko$lon,all_lat_lon.pko$lon) #need to fix the lat lons
all_lat_lon.pko$ocean.basin=pko.info$ocean.basin[match(all_lat_lon.pko$lat,pko.info$lat)]

ll_chk1=subset(all_lat_lon.pko,ocean.basin=='WC')
ll_chk2=subset(all_lat_lon.pko,ocean.basin=='SEAK')
ll_chk3=subset(all_lat_lon.pko,ocean.basin=='GOA')
ll_chk4=subset(all_lat_lon.pko,ocean.basin=='BS')


map=ggplot(data = world) + 
  geom_sf(fill= 'antiquewhite') +  xlab("") + ylab("") +
  geom_point(data =  ll_chk4, mapping = aes(x = lon, y = lat), color = basin_cols[4], size = 2.5*log(ll_chk4$n+2), alpha = 0.7) +
  geom_point(data =  ll_chk3, mapping = aes(x = lon, y = lat), color =basin_cols[3], size = 2.5*log(ll_chk3$n+2), alpha = 0.7) +
  geom_point(data =  ll_chk2, mapping = aes(x = lon, y = lat), color = basin_cols[2], size = 2.5*log(ll_chk2$n+2), alpha = 0.7) +
  geom_point(data =  ll_chk1, mapping = aes(x = lon, y = lat), color =basin_cols[1], size = 2.5*log(ll_chk1$n+2), alpha = 0.7) +
  annotate(geom = 'point', x = -165, y = 50, size = 2.5*log(1+2)) +
  annotate(geom = 'point', x = -165, y = 49, size = 2.5*log(3+2)) + 
  annotate(geom = 'point', x = -165, y = 48, size = 2.5*log(10+2)) + 
  annotate(geom = 'point', x = -165, y = 47, size = 2.5*log(20+2)) + 
  annotate(geom = 'text', x = -165, y = 51,label='n', size = 6) +
  annotate(geom = 'text', x = -162, y = 50,label='1', size = 5) +
  annotate(geom = 'text', x = -162, y = 49,label='3', size = 5) + 
  annotate(geom = 'text', x = -162, y = 48,label='10', size = 5) + 
  annotate(geom = 'text', x = -162, y = 47,label='20', size = 5) + 
  annotate(geom = 'text', x = -134, y = 50.5, label = 'West Coast', color = basin_cols[1], size = 7) + 
  annotate(geom = 'text', x = -134, y = 49.5, label = paste('n =', length(pko.wc)), color = basin_cols[1], size = 5) + 
  annotate(geom = 'text', x = -138, y = 54.5, label = 'SE Alaska', color = basin_cols[2], size = 7) + 
  annotate(geom = 'text', x = -138, y = 53.5, label = paste('n =', length(pko.seak)), color = basin_cols[2], size = 5) + 
  annotate(geom = 'text', x = -145, y = 57.5, label = 'Gulf of Alaska', color = basin_cols[3], size = 7) + 
  annotate(geom = 'text', x = -145, y = 56.5, label = paste('n =', length(pko.goa)), color = basin_cols[3], size = 5) + 
  annotate(geom = 'text', x = -164, y = 58, label = 'Bering Sea', color = basin_cols[4], size = 7) + 
  annotate(geom = 'text', x = -164, y = 57, label = paste('n =', length(pko.bs)), color = basin_cols[4], size = 5) + 
  annotation_scale(location = 'bl', width_hint = 0.5) + 
  annotation_north_arrow(location = 'bl', which_north = 'true', pad_x = unit(0.35, 'in'), pad_y = unit(0.25, 'in'), style = north_arrow_fancy_orienteering) + 
  coord_sf(xlim = c(-170, -124), ylim = c(46, 72), expand = T) +
  theme(panel.background = element_rect(fill = 'white'),legend.title = element_blank())

cowplot::plot_grid(prod,map,labels=c('A.','B.'),rel_widths = c(0.5,0.5))


```