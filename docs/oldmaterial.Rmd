---
title: "old material"
author: "D. Greenberg"
date: "9/19/2023"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Model selection

For each Pacific salmon spawner-recruit time-series we estimate each of these 8 models using either Stan or TMB. We compared the likelihoods of observing the data given each of these models, which are then used to estimate different model selection criteria. Likelihoods are calculated from the normal log predictive density function in all cases.

Broadly the model selection criteria fell into two categories: 'in-sample' likelihoods of the model fits (AIC/BIC) and 'out-of-sample' likelihoods (LOO-CV/LFO-CV), where in the latter a portion of the dataset is omitted from the model fitting stage and likelihoods estimate out-of-sample prediction accuracy.

Leave-one-out cross-validation (LOO-CV) iteratively drops each observation from the data and subsequently predicts the likelihood of observing that withheld observation under each model parameterized on the remaining dataset (ie. the training set). We use approximate LOO-CV with Pareto-smoothed importance sampling (PSIS LOO) using the rpackage 'loo'

Stock-recruitment data are time-series, and so forecasting should really only use past data to predict future out-of-sample predictions. In leave-future-out cross-validation (LFO-CV), we iteratively fit models to historical data (starting from a minimum sample window, $L$, and estimate the ability of each model to predict out-of-sample estimates 1-year ahead. Likelihoods for each observation are estimated from the Normal log predictive density function based on the expectation for each model. This is repeated for all observations from $L+1:N$. 

Choice of model selection criteria and data to include are important components. We will examine several to see how it changes our ultimate inferences.

## Model class
```{r, mod class 1 and 2,fig.dim = c(6, 8)}
aic=read.csv(here('outputs','ms_rmd','aic_table.csv'))
bic=read.csv(here('outputs','ms_rmd','bic_table.csv'))
tmb_lfo=read.csv(here('outputs','ms_rmd','tmb_lfo_table.csv'))
stan_aic=read.csv(here('outputs','ms_rmd','stan_aic_table_weights.csv'))
stan_bic=read.csv(here('outputs','ms_rmd','stan_bic_table_weights.csv'))
lfo=read.csv(here('outputs','ms_rmd','lfo_table.csv'))
  
aic$mod_class=NA
aic= aic %>%
  mutate(
    mod_class=ifelse(best_mod<=2,'static', mod_class),
    mod_class=ifelse(best_mod %in% c(3,4,5),'dynamic', mod_class),
    mod_class=ifelse(best_mod>=6,'regime', mod_class),
  )
aic$mod_class=factor(aic$mod_class,levels=c('static','dynamic','regime'))

tot_aic = aic %>% group_by(mod_class) %>% summarize(n=n())
tot_aic$ms=rep('mle_aic',nrow(tot_aic))
tot_aic$prop=tot_aic$n/sum(tot_aic$n)

bic$mod_class=NA
bic= bic %>%
  mutate(
    mod_class=ifelse(best_mod<=2,'static', mod_class),
    mod_class=ifelse(best_mod %in% c(3,4,5),'dynamic', mod_class),
    mod_class=ifelse(best_mod>=6,'regime', mod_class),
  )
bic$mod_class=factor(bic$mod_class,levels=c('static','dynamic','regime'))

tot_bic = bic %>% group_by(mod_class) %>% summarize(n=n())
tot_bic$ms=rep('mle_bic',nrow(tot_bic))
tot_bic$prop=tot_bic$n/sum(tot_bic$n)

tmb_lfo$mod_class=NA
tmb_lfo= tmb_lfo %>%
  mutate(
    mod_class=ifelse(best_mod<=2,'static', mod_class),
    mod_class=ifelse(best_mod %in% c(3,4,5),'dynamic', mod_class),
    mod_class=ifelse(best_mod>=6,'regime', mod_class),
  )
tmb_lfo$mod_class=factor(tmb_lfo$mod_class,levels=c('static','dynamic','regime'))

tot_tmb_lfo = tmb_lfo %>% group_by(mod_class) %>% summarize(n=n())
tot_tmb_lfo$ms=rep('mle_lfo',nrow(tot_tmb_lfo))
tot_tmb_lfo$prop=tot_tmb_lfo$n/sum(tot_tmb_lfo$n)

stan_aic$mod_class=NA
stan_aic= stan_aic %>%
  mutate(
    mod_class=ifelse(best_mod<=2,'static', mod_class),
    mod_class=ifelse(best_mod %in% c(3,4,5),'dynamic', mod_class),
    mod_class=ifelse(best_mod>=6,'regime', mod_class),
  )
stan_aic$mod_class=factor(stan_aic$mod_class,levels=c('static','dynamic','regime'))

tot_stan_aic = stan_aic %>% group_by(mod_class) %>% summarize(n=n())
tot_stan_aic$ms=rep('mcmc_aic',nrow(tot_stan_aic))
tot_stan_aic$prop=tot_stan_aic$n/sum(tot_stan_aic$n)

stan_bic$mod_class=NA
stan_bic= stan_bic %>%
  mutate(
    mod_class=ifelse(best_mod<=2,'static', mod_class),
    mod_class=ifelse(best_mod %in% c(3,4,5),'dynamic', mod_class),
    mod_class=ifelse(best_mod>=6,'regime', mod_class),
  )
stan_bic$mod_class=factor(stan_bic$mod_class,levels=c('static','dynamic','regime'))

tot_stan_bic = stan_bic %>% group_by(mod_class) %>% summarize(n=n())
tot_stan_bic$ms=rep('mcmc_bic',nrow(tot_stan_bic))
tot_stan_bic$prop=tot_stan_bic$n/sum(tot_stan_bic$n)

lfo$mod_class=NA
lfo= lfo %>%
  mutate(
    mod_class=ifelse(best_mod<=2,'static', mod_class),
    mod_class=ifelse(best_mod %in% c(3,4,5),'dynamic', mod_class),
    mod_class=ifelse(best_mod>=6,'regime', mod_class),
  )
lfo$mod_class=factor(lfo$mod_class,levels=c('static','dynamic','regime'))

tot_lfo = lfo %>% group_by(mod_class) %>% summarize(n=n())
tot_lfo$ms=rep('mcmc_lfo',nrow(tot_lfo))
tot_lfo$prop=tot_lfo$n/sum(tot_lfo$n)

tot_ms=rbind(tot_aic,tot_bic,tot_tmb_lfo,
             tot_stan_aic,tot_stan_bic,tot_lfo)

tot_ms$ms=factor(tot_ms$ms,levels=c('mle_aic','mle_bic','mle_lfo','mcmc_aic','mcmc_bic','mcmc_lfo'))

ggplot(tot_ms, aes(fill=factor(mod_class), y=prop, x=ms))+
  scale_fill_manual(values=mc_col[match(levels(factor(tot_ms$mod_class)),mc_col[,2])],name='Model')+ 
  ggtitle("Top-ranked models")+
  geom_bar(position="stack", stat="identity",color='white') +
  geom_text(label=round(tot_ms$prop,2), position = position_stack(vjust = 0.5),colour='white',size=3)+
  ylim(0,1)+
  theme_minimal() +
  xlab('')+
  ylab('Prop. populations')+ 
  theme(text=element_text(size=14),axis.text=element_text(size=14),axis.line = element_line(colour = "black", 
                                                                                            size = 1, linetype = "solid"),plot.title = element_text(size=14))

tot_aic = aic %>% group_by(best_mod) %>% summarize(n=n())
tot_aic$ms=rep('mle_aic',nrow(tot_aic))
tot_aic$prop=tot_aic$n/sum(tot_aic$n)
tot_bic = bic %>% group_by(best_mod) %>% summarize(n=n())
tot_bic$ms=rep('mle_bic',nrow(tot_bic))
tot_bic$prop=tot_bic$n/sum(tot_bic$n)
tot_tmb_lfo = tmb_lfo %>% group_by(best_mod) %>% summarize(n=n())
tot_tmb_lfo$ms=rep('mle_lfo',nrow(tot_tmb_lfo))
tot_tmb_lfo$prop=tot_tmb_lfo$n/sum(tot_tmb_lfo$n)
tot_stan_aic = stan_aic %>% group_by(best_mod) %>% summarize(n=n())
tot_stan_aic$ms=rep('mcmc_aic',nrow(tot_stan_aic))
tot_stan_aic$prop=tot_stan_aic$n/sum(tot_stan_aic$n)
tot_stan_bic = stan_bic %>% group_by(best_mod) %>% summarize(n=n())
tot_stan_bic$ms=rep('mcmc_bic',nrow(tot_stan_bic))
tot_stan_bic$prop=tot_stan_bic$n/sum(tot_stan_bic$n)
tot_lfo = lfo %>% group_by(best_mod) %>% summarize(n=n())
tot_lfo$ms=rep('mcmc_lfo',nrow(tot_lfo))
tot_lfo$prop=tot_lfo$n/sum(tot_lfo$n)

tot_ms=rbind(tot_aic,tot_bic,tot_tmb_lfo,tot_stan_aic,tot_stan_bic,tot_lfo)

tot_ms$ms=factor(tot_ms$ms,levels=c('mle_aic','mle_bic','mle_lfo','mcmc_aic','mcmc_bic','mcmc_lfo'))


ggplot(tot_ms, aes(fill=factor(best_mod), y=prop, x=ms))+
  scale_fill_manual(values=mod_col[match(levels(factor(tot_ms$best_mod)),mod_col[,2])],name='Model')+ 
  ggtitle("Top-ranked models")+
  geom_bar(position="stack", stat="identity",color='white') +
  geom_text(label=round(tot_ms$prop,2), position = position_stack(vjust = 0.5),colour='white',size=3)+
  ylim(0,1)+
  theme_minimal() +
  xlab('')+
  ylab('Prop. populations')+ 
  theme(text=element_text(size=14),axis.text=element_text(size=14),axis.line = element_line(colour = "black", 
  size = 1, linetype = "solid"),plot.title = element_text(size=14))
```



## Model class by species
```{r, mod clas,fig.dim = c(14, 30)}
aic=read.csv(here('outputs','ms_rmd','aic_table.csv'))

aic$mod_class=NA
aic= aic %>%
  mutate(
    mod_class=ifelse(best_mod<=2,'static', mod_class),
    mod_class=ifelse(best_mod %in% c(3,4,5),'dynamic', mod_class),
    mod_class=ifelse(best_mod>=6,'regime', mod_class),
  )
aic$mod_class=factor(aic$mod_class,levels=c('static','dynamic','regime'))
sp = aic %>% group_by(species,mod_class) %>% summarize(n=n(),.groups='keep')
sp1 = aic %>% group_by(species) %>% summarize(n=n())
sp$prop = sp$n/sp1$n[match(sp$species,sp1$species)]

aic_pl=ggplot(sp, aes(fill=factor(mod_class), y=prop, x=species))+
  scale_fill_manual(values=mc_col[match(levels(factor(sp$mod_class)),mc_col[,2])],name='Model')+ 
  ggtitle("MLE AIC")+
  geom_bar(position="stack", stat="identity",color='white') +
  geom_text(label=sp$n, position = position_stack(vjust = 0.5),colour='white',size=2.2)+
  ylim(0,1)+
  theme_minimal() +
  xlab('')+
  ylab('Prop. populations')+ 
  theme(text=element_text(size=11),axis.text=element_text(size=11),axis.line = element_line(colour = "black", 
                                                                                            size = 1, linetype = "solid"),plot.title = element_text(size=11))+
  annotation_custom(grid::textGrob(sp1$n[1]), xmin = 1, xmax = 1, ymin = 1.03, ymax = 1.03)+
  annotation_custom(grid::textGrob(sp1$n[2]), xmin = 2, xmax = 2, ymin = 1.03, ymax = 1.03)+
  annotation_custom(grid::textGrob(sp1$n[3]), xmin = 3, xmax = 3, ymin = 1.03, ymax = 1.03)+
  annotation_custom(grid::textGrob(sp1$n[4]), xmin = 4, xmax = 4, ymin = 1.03, ymax = 1.03)+
  annotation_custom(grid::textGrob(sp1$n[5]), xmin = 5, xmax = 5, ymin = 1.03, ymax = 1.03)

bic=read.csv(here('outputs','ms_rmd','bic_table.csv'))
bic$mod_class=NA
bic= bic %>%
  mutate(
    mod_class=ifelse(best_mod<=2,'static', mod_class),
    mod_class=ifelse(best_mod %in% c(3,4,5),'dynamic', mod_class),
    mod_class=ifelse(best_mod>=6,'regime', mod_class),
  )
bic$mod_class=factor(bic$mod_class,levels=c('static','dynamic','regime'))
sp = bic %>% group_by(species,mod_class) %>% summarize(n=n(),.groups='keep')
sp1 = bic %>% group_by(species) %>% summarize(n=n())
sp$prop = sp$n/sp1$n[match(sp$species,sp1$species)]

bic_pl=ggplot(sp, aes(fill=factor(mod_class), y=prop, x=species))+
  scale_fill_manual(values=mc_col[match(levels(factor(sp$mod_class)),mc_col[,2])],name='Model')+ 
  ggtitle("MLE BIC")+
  geom_bar(position="stack", stat="identity",color='white') +
  geom_text(label=sp$n, position = position_stack(vjust = 0.5),colour='white',size=2.2)+
  ylim(0,1)+
  theme_minimal() +
  xlab('')+
  ylab('Prop. populations')+ 
  theme(text=element_text(size=11),axis.text=element_text(size=11),axis.line = element_line(colour = "black", 
                                                                                            size = 1, linetype = "solid"),plot.title = element_text(size=11))+
  annotation_custom(grid::textGrob(sp1$n[1]), xmin = 1, xmax = 1, ymin = 1.03, ymax = 1.03)+
  annotation_custom(grid::textGrob(sp1$n[2]), xmin = 2, xmax = 2, ymin = 1.03, ymax = 1.03)+
  annotation_custom(grid::textGrob(sp1$n[3]), xmin = 3, xmax = 3, ymin = 1.03, ymax = 1.03)+
  annotation_custom(grid::textGrob(sp1$n[4]), xmin = 4, xmax = 4, ymin = 1.03, ymax = 1.03)+
  annotation_custom(grid::textGrob(sp1$n[5]), xmin = 5, xmax = 5, ymin = 1.03, ymax = 1.03)


loo=read.csv(here('outputs','ms_rmd','stan_looic_table_stackweight.csv'))

loo$mod_class=NA
loo= loo %>%
  mutate(
    mod_class=ifelse(best_mod<=2,'static', mod_class),
    mod_class=ifelse(best_mod %in% c(3,4,5),'dynamic', mod_class),
    mod_class=ifelse(best_mod>=6,'regime', mod_class),
  )
loo$mod_class=factor(loo$mod_class,levels=c('static','dynamic','regime'))
sp = loo %>% group_by(species,mod_class) %>% summarize(n=n(),.groups='keep')
sp1 = loo %>% group_by(species) %>% summarize(n=n())
sp$prop = sp$n/sp1$n[match(sp$species,sp1$species)]

loo_pl=ggplot(sp, aes(fill=factor(mod_class), y=prop, x=species))+
  scale_fill_manual(values=mc_col[match(levels(factor(sp$mod_class)),mc_col[,2])],name='Model')+ 
  ggtitle("MCMC LOO-CV")+
  geom_bar(position="stack", stat="identity",color='white') +
  geom_text(label=sp$n, position = position_stack(vjust = 0.5),colour='white',size=2.2)+
  ylim(0,1)+
  theme_minimal() +
  xlab('')+
  ylab('Prop. populations')+ 
  theme(text=element_text(size=11),axis.text=element_text(size=11),axis.line = element_line(colour = "black", 
                                                                                            size = 1, linetype = "solid"),plot.title = element_text(size=11))+
  annotation_custom(grid::textGrob(sp1$n[1]), xmin = 1, xmax = 1, ymin = 1.03, ymax = 1.03)+
  annotation_custom(grid::textGrob(sp1$n[2]), xmin = 2, xmax = 2, ymin = 1.03, ymax = 1.03)+
  annotation_custom(grid::textGrob(sp1$n[3]), xmin = 3, xmax = 3, ymin = 1.03, ymax = 1.03)+
  annotation_custom(grid::textGrob(sp1$n[4]), xmin = 4, xmax = 4, ymin = 1.03, ymax = 1.03)+
  annotation_custom(grid::textGrob(sp1$n[5]), xmin = 5, xmax = 5, ymin = 1.03, ymax = 1.03)

lfo=read.csv(here('outputs','ms_rmd','lfo_table.csv'))
lfo$mod_class=NA
lfo= lfo %>%
  mutate(
    mod_class=ifelse(best_mod<=2,'static', mod_class),
    mod_class=ifelse(best_mod %in% c(3,4,5),'dynamic', mod_class),
    mod_class=ifelse(best_mod>=6,'regime', mod_class),
  )
lfo$mod_class=factor(lfo$mod_class,levels=c('static','dynamic','regime'))
sp = lfo %>% group_by(species,mod_class) %>% summarize(n=n(),.groups='keep')
sp1 = lfo %>% group_by(species) %>% summarize(n=n())
sp$prop = sp$n/sp1$n[match(sp$species,sp1$species)]

lfo_pl=ggplot(sp, aes(fill=factor(mod_class), y=prop, x=species))+
  scale_fill_manual(values=mc_col[match(levels(factor(sp$mod_class)),mc_col[,2])],name='Model')+ 
  ggtitle("MCMC LFO-CV, L=2/3n")+
  geom_bar(position="stack", stat="identity",color='white') +
  geom_text(label=sp$n, position = position_stack(vjust = 0.5),colour='white',size=2.2)+
  ylim(0,1)+
  theme_minimal() +
  xlab('')+
  ylab('Prop. populations')+ 
  theme(text=element_text(size=11),axis.text=element_text(size=11),axis.line = element_line(colour = "black", 
                                                                                            size = 1, linetype = "solid"),plot.title = element_text(size=11))+
  annotation_custom(grid::textGrob(sp1$n[1]), xmin = 1, xmax = 1, ymin = 1.03, ymax = 1.03)+
  annotation_custom(grid::textGrob(sp1$n[2]), xmin = 2, xmax = 2, ymin = 1.03, ymax = 1.03)+
  annotation_custom(grid::textGrob(sp1$n[3]), xmin = 3, xmax = 3, ymin = 1.03, ymax = 1.03)+
  annotation_custom(grid::textGrob(sp1$n[4]), xmin = 4, xmax = 4, ymin = 1.03, ymax = 1.03)+
  annotation_custom(grid::textGrob(sp1$n[5]), xmin = 5, xmax = 5, ymin = 1.03, ymax = 1.03)

tmb_lfo=read.csv(here('outputs','ms_rmd','tmb_lfo_table.csv'))
tmb_lfo$mod_class=NA
tmb_lfo= tmb_lfo %>%
  mutate(
    mod_class=ifelse(best_mod<=2,'static', mod_class),
    mod_class=ifelse(best_mod %in% c(3,4,5),'dynamic', mod_class),
    mod_class=ifelse(best_mod>=6,'regime', mod_class),
  )
tmb_lfo$mod_class=factor(tmb_lfo$mod_class,levels=c('static','dynamic','regime'))
sp = tmb_lfo %>% group_by(species,mod_class) %>% summarize(n=n(),.groups='keep')
sp1 = tmb_lfo %>% group_by(species) %>% summarize(n=n())
sp$prop = sp$n/sp1$n[match(sp$species,sp1$species)]

tmb_lfo_pl=ggplot(sp, aes(fill=factor(mod_class), y=prop, x=species))+
  scale_fill_manual(values=mc_col[match(levels(factor(sp$mod_class)),mc_col[,2])],name='Model')+ 
  ggtitle("MLE LFO-CV, L=10")+
  geom_bar(position="stack", stat="identity",color='white') +
  geom_text(label=sp$n, position = position_stack(vjust = 0.5),colour='white',size=2.2)+
  ylim(0,1)+
  theme_minimal() +
  xlab('')+
  ylab('Prop. populations')+ 
  theme(text=element_text(size=11),axis.text=element_text(size=11),axis.line = element_line(colour = "black", 
                                                                                            size = 1, linetype = "solid"),plot.title = element_text(size=11))+
  annotation_custom(grid::textGrob(sp1$n[1]), xmin = 1, xmax = 1, ymin = 1.03, ymax = 1.03)+
  annotation_custom(grid::textGrob(sp1$n[2]), xmin = 2, xmax = 2, ymin = 1.03, ymax = 1.03)+
  annotation_custom(grid::textGrob(sp1$n[3]), xmin = 3, xmax = 3, ymin = 1.03, ymax = 1.03)+
  annotation_custom(grid::textGrob(sp1$n[4]), xmin = 4, xmax = 4, ymin = 1.03, ymax = 1.03)+
  annotation_custom(grid::textGrob(sp1$n[5]), xmin = 5, xmax = 5, ymin = 1.03, ymax = 1.03)

plot_grid(aic_pl+ theme(legend.position="none"),
              bic_pl+ theme(legend.position="none"),
              tmb_lfo_pl+ theme(legend.position="none"),
              lfo_pl + theme(legend.position="none"),
              loo_pl+ theme(legend.position="none"),
              legend= get_legend(lfo_pl),
              ncol=3,nrow=2,labels=c("A","B","C","D","E",''))
```





# TMB AICc

### Top models
```{r, model weights AIC}
aic=read.csv(here('outputs','ms_rmd','aic_table.csv'))
aic$lat=round(aic$lat,2)
aic$lon=round(aic$lon,2)
table(aic$best_mod)
round(table(aic$best_mod)/nrow(aic),2)
aic$state2=aic$state
aic=aic %>% mutate(state2=ifelse(state=='OR','OR-WA',state2),
                                                   state2=ifelse(state=='WA','OR-WA',state2))
```

```{r, AIC model weights by pop, warning = FALSE}
sp = aic %>% group_by(species,best_mod) %>% summarize(n=n(),.groups='keep')
sp1 = aic %>% group_by(species) %>% summarize(n=n())
sp$prop = sp$n/sp1$n[match(sp$species,sp1$species)]

ggplot(sp, aes(fill=factor(best_mod), y=prop, x=species))+
  scale_fill_manual(values=mod_col[match(levels(factor(sp$best_mod)),mod_col[,2])],name='Model')+ 
  ggtitle("Top-ranked model (TMB AIC)")+
  geom_bar(position="stack", stat="identity",color='white') +
  geom_text(label=sp$n, position = position_stack(vjust = 0.5),colour='white',size=2.2)+
  ylim(0,1)+
  theme_minimal() +
  xlab('')+
  ylab('Prop. populations')+ 
  theme(text=element_text(size=14),axis.text=element_text(size=14),axis.line = element_line(colour = "black", 
                      size = 1, linetype = "solid"),plot.title = element_text(size=14))+
annotation_custom(grid::textGrob(sp1$n[1]), xmin = 1, xmax = 1, ymin = 1.03, ymax = 1.03)+
  annotation_custom(grid::textGrob(sp1$n[2]), xmin = 2, xmax = 2, ymin = 1.03, ymax = 1.03)+
    annotation_custom(grid::textGrob(sp1$n[3]), xmin = 3, xmax = 3, ymin = 1.03, ymax = 1.03)+
      annotation_custom(grid::textGrob(sp1$n[4]), xmin = 4, xmax = 4, ymin = 1.03, ymax = 1.03)+
       annotation_custom(grid::textGrob(sp1$n[5]), xmin = 5, xmax = 5, ymin = 1.03, ymax = 1.03)
```

```{r, aic model class by pop, warning = FALSE}
aic$mod_class=NA
aic= aic %>%
    mutate(
      mod_class=ifelse(best_mod<=2,'static', mod_class),
       mod_class=ifelse(best_mod %in% c(3,4,5),'dynamic', mod_class),
      mod_class=ifelse(best_mod>=6,'regime', mod_class),
    )
aic$mod_class=factor(aic$mod_class,levels=c('static','dynamic','regime'))
sp = aic %>% group_by(species,mod_class) %>% summarize(n=n(),.groups='keep')
sp1 = aic %>% group_by(species) %>% summarize(n=n())
sp$prop = sp$n/sp1$n[match(sp$species,sp1$species)]

ggplot(sp, aes(fill=factor(mod_class), y=prop, x=species))+
  scale_fill_manual(values=mc_col[match(levels(factor(sp$mod_class)),mc_col[,2])],name='Model')+ 
  ggtitle("Top-ranked model (TMB AIC)")+
  geom_bar(position="stack", stat="identity",color='white') +
  geom_text(label=sp$n, position = position_stack(vjust = 0.5),colour='white',size=2.2)+
  ylim(0,1)+
  theme_minimal() +
  xlab('')+
  ylab('Prop. populations')+ 
  theme(text=element_text(size=14),axis.text=element_text(size=14),axis.line = element_line(colour = "black", 
                      size = 1, linetype = "solid"),plot.title = element_text(size=14))+
annotation_custom(grid::textGrob(sp1$n[1]), xmin = 1, xmax = 1, ymin = 1.03, ymax = 1.03)+
  annotation_custom(grid::textGrob(sp1$n[2]), xmin = 2, xmax = 2, ymin = 1.03, ymax = 1.03)+
    annotation_custom(grid::textGrob(sp1$n[3]), xmin = 3, xmax = 3, ymin = 1.03, ymax = 1.03)+
      annotation_custom(grid::textGrob(sp1$n[4]), xmin = 4, xmax = 4, ymin = 1.03, ymax = 1.03)+
       annotation_custom(grid::textGrob(sp1$n[5]), xmin = 5, xmax = 5, ymin = 1.03, ymax = 1.03)

round(table(aic$mod_class)/nrow(aic),2)

```

### By jursidiction

Top models broken down by state:

```{r, AIC w broken down by state }
sp_state = aic %>% group_by(state2,species,best_mod) %>% summarize(n=n(),.groups='keep')
sp_state1 = aic %>% group_by(state2,species) %>% summarize(n=n(),.groups='keep')
sp_state$prop = sp_state$n/sp_state1$n[match(paste(sp_state$state2,sp_state$species,sep='_'),paste(sp_state1$state2,sp_state1$species,sep='_'))]
sp_state2 = aic %>% group_by(state2,best_mod) %>% summarize(n=n(),.groups='keep')
sp_state3 = aic %>% group_by(state2) %>% summarize(n=n())
sp_state2$prop = sp_state2$n/sp_state3$n[match(paste(sp_state2$state2,sp_state2$species,sep='_'),paste(sp_state3$state2,sp_state3$species,sep='_'))]

sp_ak=subset(sp_state,state2=='AK')
sp1_ak=subset(sp_state1,state2=='AK')
sp_bc=subset(sp_state,state2=='BC')
sp1_bc=subset(sp_state1,state2=='BC')
sp_wa=subset(sp_state,state2=='OR-WA')
sp1_wa=subset(sp_state1,state2=='OR-WA')


wa_pl=ggplot(sp_wa, aes(fill=factor(best_mod), y=prop, x=species))+
  scale_fill_manual(values=mod_col[match(levels(factor(sp_wa$best_mod)),mod_col[,2])],name='Model')+ 
  ggtitle("Oregon/Washington")+
  geom_bar(position="stack", stat="identity") +
  geom_text(label=sp_wa$n, position = position_stack(vjust = 0.5),colour='white',size=2.2)+
  ylim(0,1.05)+
  theme_minimal() +
  xlab('')+
  ylab('')+ 
  theme(text=element_text(size=10),axis.text=element_text(size=10),axis.line = element_line(colour = "black", 
                      size = 1, linetype = "solid"),plot.title = element_text(size=12))+
annotation_custom(grid::textGrob(sp1_wa$n[1],gp=grid::gpar(fontsize=8)), xmin = 1, xmax = 1, ymin = 1.05, ymax = 1.05)+
  annotation_custom(grid::textGrob(sp1_wa$n[2],gp=grid::gpar(fontsize=8)), xmin = 2, xmax = 2, ymin = 1.05, ymax = 1.05)+
    annotation_custom(grid::textGrob(sp1_wa$n[3],gp=grid::gpar(fontsize=8)), xmin = 3, xmax = 3, ymin = 1.05, ymax = 1.05)+
      annotation_custom(grid::textGrob(sp1_wa$n[4],gp=grid::gpar(fontsize=8)), xmin = 4, xmax = 4, ymin = 1.05, ymax = 1.05)


bc_pl=ggplot(sp_bc, aes(fill=factor(best_mod), y=prop, x=species))+
  scale_fill_manual(values=mod_col[match(levels(factor(sp_bc$best_mod)),mod_col[,2])],name='Model')+ 
  ggtitle("British Columbia")+
  geom_bar(position="stack", stat="identity") +
  geom_text(label=sp_bc$n, position = position_stack(vjust = 0.5),colour='white',size=2.2)+
  ylim(0,1.05)+
  theme_minimal() +
  xlab('')+
  ylab('Prop. populations')+ 
  theme(text=element_text(size=10),axis.text=element_text(size=10),axis.line = element_line(colour = "black", 
                      size = 1, linetype = "solid"),plot.title = element_text(size=12))+
annotation_custom(grid::textGrob(sp1_bc$n[1],gp=grid::gpar(fontsize=8)), xmin = 1, xmax = 1, ymin = 1.05, ymax = 1.05)+
  annotation_custom(grid::textGrob(sp1_bc$n[2],gp=grid::gpar(fontsize=8)), xmin = 2, xmax = 2, ymin = 1.05, ymax = 1.05)+
    annotation_custom(grid::textGrob(sp1_bc$n[3],gp=grid::gpar(fontsize=8)), xmin = 3, xmax = 3, ymin = 1.05, ymax = 1.05)+
      annotation_custom(grid::textGrob(sp1_bc$n[4],gp=grid::gpar(fontsize=8)), xmin = 4, xmax = 4, ymin = 1.05, ymax = 1.05)+
         annotation_custom(grid::textGrob(sp1_bc$n[5],gp=grid::gpar(fontsize=8)), xmin = 5, xmax = 5, ymin = 1.05, ymax = 1.05)

ak_pl=ggplot(sp_ak, aes(fill=factor(best_mod), y=prop, x=species))+
  scale_fill_manual(values=mod_col[match(levels(factor(sp_ak$best_mod)),mod_col[,2])],name='Model')+ 
  ggtitle("Alaska")+
  geom_bar(position="stack", stat="identity") +
  geom_text(label=sp_ak$n, position = position_stack(vjust = 0.5),colour='white',size=2.2)+
  ylim(0,1.05)+
  theme_minimal() +
  xlab('')+
  ylab('')+ 
  theme(text=element_text(size=10),axis.text=element_text(size=10),axis.line = element_line(colour = "black", 
                      size = 1, linetype = "solid"),plot.title = element_text(size=12))+
annotation_custom(grid::textGrob(sp1_ak$n[1],gp=grid::gpar(fontsize=8)), xmin = 1, xmax = 1, ymin = 1.05, ymax = 1.05)+
  annotation_custom(grid::textGrob(sp1_ak$n[2],gp=grid::gpar(fontsize=8)), xmin = 2, xmax = 2, ymin = 1.05, ymax = 1.05)+
    annotation_custom(grid::textGrob(sp1_ak$n[3],gp=grid::gpar(fontsize=8)), xmin = 3, xmax = 3, ymin = 1.05, ymax = 1.05)+
      annotation_custom(grid::textGrob(sp1_ak$n[4],gp=grid::gpar(fontsize=8)), xmin = 4, xmax = 4, ymin = 1.05, ymax = 1.05)+
         annotation_custom(grid::textGrob(sp1_ak$n[5],gp=grid::gpar(fontsize=8)), xmin = 5, xmax = 5, ymin = 1.05, ymax = 1.05)

total_pl=ggplot(sp_state2, aes(fill=factor(best_mod), y=prop, x=state2))+
  scale_fill_manual(values=mod_col[match(levels(factor(sp_state2$best_mod)),mod_col[,2])],name='Model')+
   ggtitle("Total")+
  geom_bar(position="stack", stat="identity") +
  geom_text(label=sp_state2$n, position = position_stack(vjust = 0.5),colour='white',size=2.2)+
  ylim(0,1.05)+
  theme_minimal() +
  xlab('')+
  ylab('Prop. populations')+ 
  theme(text=element_text(size=10),axis.text=element_text(size=10),axis.line = element_line(colour = "black", 
                      size = 1, linetype = "solid"),plot.title = element_text(size=12))+
annotation_custom(grid::textGrob(sum(sp1_wa$n),gp=grid::gpar(fontsize=8)), xmin = 1, xmax = 1, ymin = 1.05, ymax = 1.05)+
  annotation_custom(grid::textGrob(sum(sp1_bc$n),gp=grid::gpar(fontsize=8)), xmin = 2, xmax = 2, ymin = 1.05, ymax = 1.05)+
    annotation_custom(grid::textGrob(sum(sp1_ak$n),gp=grid::gpar(fontsize=8)), xmin = 3, xmax = 3, ymin = 1.05, ymax = 1.05)

pg1=plot_grid(
          wa_pl+ theme(legend.position="none"),
          bc_pl+ theme(legend.position="none"),
          ak_pl+ theme(legend.position="none"),
           total_pl+ theme(legend.position="none"),
          ncol=2,nrow=2,labels=c("A","B","C","D"))

legend= get_legend(total_pl)

plot_grid(pg1,legend,rel_widths = c(3,.5))

```

### Ocean basins - TMB AIC

Top models broken down by ocean basin:

```{r, top AIC model broken down by state and ocean basin}
sp_ocean = aic %>% group_by(ocean.basin,best_mod,species) %>% summarize(n=n(),.groups='keep')
sp_ocean1 = aic %>% group_by(ocean.basin,species) %>% summarize(n=n(),.groups='keep')
sp_ocean2 = aic %>% group_by(ocean.basin,best_mod) %>% summarize(n=n(),.groups='keep')
sp_ocean3 = aic %>% group_by(ocean.basin) %>% summarize(n=n())
sp_ocean$prop = sp_ocean$n/sp_ocean1$n[match(paste(sp_ocean$ocean.basin,sp_ocean$species,sep='_'),paste(sp_ocean1$ocean.basin,sp_ocean1$species,sep='_'))]
sp_ocean2$prop = sp_ocean2$n/sp_ocean3$n[match(paste(sp_ocean2$ocean.basin,sp_ocean2$species,sep='_'),paste(sp_ocean3$ocean.basin,sp_ocean3$species,sep='_'))]


sp_BS=subset(sp_ocean,ocean.basin=='BS')
sp1_BS=subset(sp_ocean1,ocean.basin=='BS')
sp_GOA=subset(sp_ocean,ocean.basin=='GOA')
sp1_GOA=subset(sp_ocean1,ocean.basin=='GOA')
sp_WC=subset(sp_ocean,ocean.basin=='WC')
sp1_WC=subset(sp_ocean1,ocean.basin=='WC')


WC_pl=ggplot(sp_WC, aes(fill=factor(best_mod), y=prop, x=species))+
  scale_fill_manual(values=mod_col[match(levels(factor(sp_WC$best_mod)),mod_col[,2])],name='Model')+ 
  ggtitle("West Coast")+
  geom_bar(position="stack", stat="identity") +
  geom_text(label=sp_WC$n, position = position_stack(vjust = 0.5),colour='white',size=2.2)+
  ylim(0,1.05)+
  theme_minimal() +
  xlab('')+
  ylab('Prop. populations')+ 
  theme(text=element_text(size=10),axis.text=element_text(size=10),axis.line = element_line(colour = "black", 
                      size = 1, linetype = "solid"),plot.title = element_text(size=12))+
annotation_custom(grid::textGrob(sp1_WC$n[1],gp=grid::gpar(fontsize=8)), xmin = 1, xmax = 1, ymin = 1.05, ymax = 1.05)+
  annotation_custom(grid::textGrob(sp1_WC$n[2],gp=grid::gpar(fontsize=8)), xmin = 2, xmax = 2, ymin = 1.05, ymax = 1.05)+
    annotation_custom(grid::textGrob(sp1_WC$n[3],gp=grid::gpar(fontsize=8)), xmin = 3, xmax = 3, ymin = 1.05, ymax = 1.05)+
      annotation_custom(grid::textGrob(sp1_WC$n[4],gp=grid::gpar(fontsize=8)), xmin = 4, xmax = 4, ymin = 1.05, ymax = 1.05)+
         annotation_custom(grid::textGrob(sp1_WC$n[5],gp=grid::gpar(fontsize=8)), xmin = 5, xmax = 5, ymin = 1.05, ymax = 1.05)


GOA_pl=ggplot(sp_GOA, aes(fill=factor(best_mod), y=prop, x=species))+
  scale_fill_manual(values=mod_col[match(levels(factor(sp_GOA$best_mod)),mod_col[,2])],name='Model')+ 
  ggtitle("Gulf of Alaska")+
  geom_bar(position="stack", stat="identity") +
  geom_text(label=sp_GOA$n, position = position_stack(vjust = 0.5),colour='white',size=2.2)+
  ylim(0,1.05)+
  theme_minimal() +
  xlab('')+
  ylab('')+ 
  theme(text=element_text(size=10),axis.text=element_text(size=10),axis.line = element_line(colour = "black", 
                      size = 1, linetype = "solid"),plot.title = element_text(size=12))+
annotation_custom(grid::textGrob(sp1_GOA$n[1],gp=grid::gpar(fontsize=8)), xmin = 1, xmax = 1, ymin = 1.05, ymax = 1.05)+
  annotation_custom(grid::textGrob(sp1_GOA$n[2],gp=grid::gpar(fontsize=8)), xmin = 2, xmax = 2, ymin = 1.05, ymax = 1.05)+
    annotation_custom(grid::textGrob(sp1_GOA$n[3],gp=grid::gpar(fontsize=8)), xmin = 3, xmax = 3, ymin = 1.05, ymax = 1.05)+
      annotation_custom(grid::textGrob(sp1_GOA$n[4],gp=grid::gpar(fontsize=8)), xmin = 4, xmax = 4, ymin = 1.05, ymax = 1.05)+
         annotation_custom(grid::textGrob(sp1_GOA$n[5],gp=grid::gpar(fontsize=8)), xmin = 5, xmax = 5, ymin = 1.05, ymax = 1.05)


BS_pl=ggplot(sp_BS, aes(fill=factor(best_mod), y=prop, x=species))+
  scale_fill_manual(values=mod_col[match(levels(factor(sp_BS$best_mod)),mod_col[,2])],name='Model')+ 
  ggtitle("Bering Sea")+
  geom_bar(position="stack", stat="identity") +
  geom_text(label=sp_BS$n, position = position_stack(vjust = 0.5),colour='white',size=2.2)+
  ylim(0,1.05)+
  theme_minimal() +
  xlab('')+
  ylab('Prop. populations')+ 
  theme(text=element_text(size=10),axis.text=element_text(size=10),axis.line = element_line(colour = "black", 
                      size = 1, linetype = "solid"),plot.title = element_text(size=12))+
annotation_custom(grid::textGrob(sp1_BS$n[1],gp=grid::gpar(fontsize=8)), xmin = 1, xmax = 1, ymin = 1.05, ymax = 1.05)+
  annotation_custom(grid::textGrob(sp1_BS$n[2],gp=grid::gpar(fontsize=8)), xmin = 2, xmax = 2, ymin = 1.05, ymax = 1.05)+
    annotation_custom(grid::textGrob(sp1_BS$n[3],gp=grid::gpar(fontsize=8)), xmin = 3, xmax = 3, ymin = 1.05, ymax = 1.05)+
      annotation_custom(grid::textGrob(sp1_BS$n[4],gp=grid::gpar(fontsize=8)), xmin = 4, xmax = 4, ymin = 1.05, ymax = 1.05)+
         annotation_custom(grid::textGrob(sp1_BS$n[5],gp=grid::gpar(fontsize=8)), xmin = 5, xmax = 5, ymin = 1.05, ymax = 1.05)

total_pl=ggplot(sp_ocean2, aes(fill=factor(best_mod), y=prop, x=ocean.basin))+
  scale_fill_manual(values=mod_col[match(levels(factor(sp_ocean2$best_mod)),mod_col[,2])],name='Model')+
   ggtitle("Total")+
  geom_bar(position="stack", stat="identity") +
  geom_text(label=sp_ocean2$n, position = position_stack(vjust = 0.5),colour='white',size=2.2)+
  ylim(0,1.05)+
  theme_minimal() +
  xlab('')+
  ylab('Prop. populations')+ 
  theme(text=element_text(size=10),axis.text=element_text(size=10),axis.line = element_line(colour = "black", 
                      size = 1, linetype = "solid"),plot.title = element_text(size=12))+
  annotation_custom(grid::textGrob(sum(sp1_BS$n),gp=grid::gpar(fontsize=8)), xmin = 1, xmax = 1, ymin = 1.05, ymax = 1.05)+
  annotation_custom(grid::textGrob(sum(sp1_GOA$n),gp=grid::gpar(fontsize=8)), xmin = 2, xmax = 2, ymin = 1.05, ymax = 1.05)+
    annotation_custom(grid::textGrob(sum(sp1_WC$n),gp=grid::gpar(fontsize=8)), xmin = 3, xmax = 3, ymin = 1.05, ymax = 1.05)


legend= get_legend(total_pl)

pg1=plot_grid(WC_pl+ theme(legend.position="none"),
          GOA_pl+ theme(legend.position="none"),
          BS_pl+ theme(legend.position="none"),
          total_pl+ theme(legend.position="none"),
          ncol=2,nrow=2,labels=c("A","B","C","D"))

plot_grid(pg1,legend,rel_widths = c(3,.5))
```

### By time-series length

```{r, aic by ts length}
aic$ts_length_bin=cut(
 stock_info_filtered$n.years,
  breaks = quantile(stock_info_filtered$n.years, seq(0,1,by=0.2)),
  labels = c('18-26','27-35','35-45','46-50','50+'))

aic_ts = aic %>% group_by(ts_length_bin,best_mod,species) %>% summarize(n=n(),.groups='keep')
sp = aic %>% group_by(species,best_mod) %>% summarize(n=n(),.groups='keep')
sp1 = aic %>% group_by(species) %>% summarize(n=n())
sp$prop = sp$n/sp1$n[match(sp$species,sp1$species)]

sp_18=subset(aic_ts,ts_length_bin=='18-26')
sp_27=subset(aic_ts,ts_length_bin=='27-35')
sp_35=subset(aic_ts,ts_length_bin=='35-45')
sp_45=subset(aic_ts,ts_length_bin=='46-50')
sp_50=subset(aic_ts,ts_length_bin=='50+')

pl_18=ggplot(sp_18, aes(fill=species, y=n, x=factor(best_mod)))+
  scale_fill_manual(values=sp_cols[match(levels(factor(sp_18$species)),sp_cols[,2])])+ 
  ggtitle("18 - 26 years")+
  geom_bar(position="stack", stat="identity") + 
  theme_minimal() +
  xlab('')+
  ylab('No. populations')+ 
  theme(text=element_text(size=12),axis.title=element_text(size=12,face="bold"),axis.line = element_line(colour = "black", 
                      size = 1, linetype = "solid"),plot.title = element_text(size=14))

pl_27=ggplot(sp_27, aes(fill=species, y=n, x=factor(best_mod)))+
  scale_fill_manual(values=sp_cols[match(levels(factor(sp_27$species)),sp_cols[,2])])+
  ggtitle("27 - 35 years")+
  geom_bar(position="stack", stat="identity") + 
  theme_minimal() +
  xlim(factor(seq(1:8)))+
  xlab('')+
  ylab('No. populations')+ 
  theme(text=element_text(size=12),axis.title=element_text(size=12,face="bold"),axis.line = element_line(colour = "black", 
                      size = 1, linetype = "solid"),plot.title = element_text(size=14))

pl_35=ggplot(sp_35, aes(fill=species, y=n, x=factor(best_mod)))+
  scale_fill_manual(values=sp_cols[match(levels(factor(sp_35$species)),sp_cols[,2])])+
  ggtitle("35 - 45 years")+
  geom_bar(position="stack", stat="identity") + 
  theme_minimal() +
   xlim(factor(seq(1:8)))+
  xlab('')+
  ylab('')+ 
  theme(text=element_text(size=12), axis.title=element_text(size=12,face="bold"),axis.line = element_line(colour = "black", 
                      size = 1, linetype = "solid"),plot.title = element_text(size=14))

pl_45=ggplot(sp_45, aes(fill=species, y=n, x=factor(best_mod)))+
  scale_fill_manual(values=sp_cols[match(levels(factor(sp_45$species)),sp_cols[,2])])+
  ggtitle("46 - 50 years")+
  geom_bar(position="stack", stat="identity") + 
  theme_minimal() +
   xlim(factor(seq(1:8)))+
  xlab('')+
  ylab('No. populations')+ 
  theme(text=element_text(size=12), axis.title=element_text(size=12,face="bold"),axis.line = element_line(colour = "black", 
                      size = 1, linetype = "solid"),plot.title = element_text(size=14))

pl_50=ggplot(sp_50, aes(fill=species, y=n, x=factor(best_mod)))+
  scale_fill_manual(values=sp_cols[match(levels(factor(sp_50$species)),sp_cols[,2])])+
  ggtitle("50+ years")+
  geom_bar(position="stack", stat="identity") + 
  theme_minimal() +
   xlim(factor(seq(1:8)))+
  xlab('')+
  ylab('')+ 
  theme(text=element_text(size=12), axis.title=element_text(size=12,face="bold"),axis.line = element_line(colour = "black", 
                      size = 1, linetype = "solid"),plot.title = element_text(size=14))

legend= get_legend(pl_18)

plot_grid(pl_18+ theme(legend.position="none"),
          pl_27+ theme(legend.position="none"),
          pl_35+ theme(legend.position="none"),
          pl_45+ theme(legend.position="none"),
          pl_50+ theme(legend.position="none"),
          legend,
          ncol=3,nrow=2,labels=c("A","B","C","D","E"))
```




# TMB BIC

### Top models
```{r, BIC model weights}
bic=read.csv(here('outputs','ms_rmd','aic_table.csv'))
bic$lat=round(bic$lat,2)
bic$lon=round(bic$lon,2)
table(bic$best_mod)
round(table(bic$best_mod)/nrow(bic),2)
bic$state2=NA
bic=bic %>% mutate(state2=ifelse(state=='OR','OR-WA',state2),
                                                   state2=ifelse(state=='WA','OR-WA',state2))
```

```{r, BIC model weights by pop, warning = FALSE}
sp = bic %>% group_by(species,best_mod) %>% summarize(n=n(),.groups='keep')
sp1 = bic %>% group_by(species) %>% summarize(n=n())
sp$prop = sp$n/sp1$n[match(sp$species,sp1$species)]

ggplot(sp, aes(fill=factor(best_mod), y=prop, x=species))+
  scale_fill_manual(values=mod_col[match(levels(factor(sp$best_mod)),mod_col[,2])],name='Model')+ 
  ggtitle("Top-ranked model (TMB BIC)")+
  geom_bar(position="stack", stat="identity",color='white') +
  geom_text(label=sp$n, position = position_stack(vjust = 0.5),colour='white',size=2.2)+
  ylim(0,1)+
  theme_minimal() +
  xlab('')+
  ylab('Prop. populations')+ 
  theme(text=element_text(size=14),axis.text=element_text(size=14),axis.line = element_line(colour = "black", 
                      size = 1, linetype = "solid"),plot.title = element_text(size=14))+
annotation_custom(grid::textGrob(sp1$n[1]), xmin = 1, xmax = 1, ymin = 1.03, ymax = 1.03)+
  annotation_custom(grid::textGrob(sp1$n[2]), xmin = 2, xmax = 2, ymin = 1.03, ymax = 1.03)+
    annotation_custom(grid::textGrob(sp1$n[3]), xmin = 3, xmax = 3, ymin = 1.03, ymax = 1.03)+
      annotation_custom(grid::textGrob(sp1$n[4]), xmin = 4, xmax = 4, ymin = 1.03, ymax = 1.03)+
       annotation_custom(grid::textGrob(sp1$n[5]), xmin = 5, xmax = 5, ymin = 1.03, ymax = 1.03)

```

```{r, model class by pop, warning = FALSE}
bic$mod_class=NA
bic= bic %>%
    mutate(
      mod_class=ifelse(best_mod<=2,'static', mod_class),
       mod_class=ifelse(best_mod %in% c(3,4,5),'dynamic', mod_class),
      mod_class=ifelse(best_mod>=6,'regime', mod_class),
    )
bic$mod_class=factor(bic$mod_class,levels=c('static','dynamic','regime'))
sp = bic %>% group_by(species,mod_class) %>% summarize(n=n(),.groups='keep')
sp1 = bic %>% group_by(species) %>% summarize(n=n())
sp$prop = sp$n/sp1$n[match(sp$species,sp1$species)]

ggplot(sp, aes(fill=factor(mod_class), y=prop, x=species))+
  scale_fill_manual(values=mc_col[match(levels(factor(sp$mod_class)),mc_col[,2])],name='Model')+ 
  ggtitle("Top-ranked model (TMB BIC)")+
  geom_bar(position="stack", stat="identity",color='white') +
  geom_text(label=sp$n, position = position_stack(vjust = 0.5),colour='white',size=2.2)+
  ylim(0,1)+
  theme_minimal() +
  xlab('')+
  ylab('Prop. populations')+ 
  theme(text=element_text(size=14),axis.text=element_text(size=14),axis.line = element_line(colour = "black", 
                      size = 1, linetype = "solid"),plot.title = element_text(size=14))+
annotation_custom(grid::textGrob(sp1$n[1]), xmin = 1, xmax = 1, ymin = 1.03, ymax = 1.03)+
  annotation_custom(grid::textGrob(sp1$n[2]), xmin = 2, xmax = 2, ymin = 1.03, ymax = 1.03)+
    annotation_custom(grid::textGrob(sp1$n[3]), xmin = 3, xmax = 3, ymin = 1.03, ymax = 1.03)+
      annotation_custom(grid::textGrob(sp1$n[4]), xmin = 4, xmax = 4, ymin = 1.03, ymax = 1.03)+
       annotation_custom(grid::textGrob(sp1$n[5]), xmin = 5, xmax = 5, ymin = 1.03, ymax = 1.03)

round(table(bic$mod_class)/nrow(bic),2)

```

### By jurisdiction

Top models broken down by state:

```{r, top model BIC broken down by state }
sp_state = bic %>% group_by(state,best_mod,species) %>% summarize(n=n())
sp_ak=subset(sp_state,state=='AK')
sp_bc=subset(sp_state,state=='BC')
sp_wa=subset(sp_state,state=='WA')
sp_or=subset(sp_state,state=='OR')

or_pl=ggplot(sp_or, aes(fill=species, y=n, x=factor(best_mod)))+
  scale_fill_manual(values=c("darkgray", "darkgreen", "darkblue","darksalmon","darkred"))+ 
  ggtitle("Oregon")+
  geom_bar(position="stack", stat="identity") + 
  theme_minimal() +
  xlim(factor(seq(1:8)))+
  xlab('')+
  ylab('No. populations')+ 
  theme(text=element_text(size=12),axis.title=element_text(size=12,face="bold"),axis.line = element_line(colour = "black", 
                      size = 1, linetype = "solid"),plot.title = element_text(size=14))

wa_pl=ggplot(sp_wa, aes(fill=species, y=n, x=factor(best_mod)))+
  scale_fill_manual(values=c("darkgray", "darkgreen", "darkblue","darksalmon","darkred"))+
  ggtitle("Washington")+
  geom_bar(position="stack", stat="identity") + 
  theme_minimal() +
  xlim(factor(seq(1:8)))+
  xlab('')+
  ylab('No. populations')+ 
  theme(text=element_text(size=12),axis.title=element_text(size=12,face="bold"),axis.line = element_line(colour = "black", 
                      size = 1, linetype = "solid"),plot.title = element_text(size=14))

bc_pl=ggplot(sp_bc, aes(fill=species, y=n, x=factor(best_mod)))+
  scale_fill_manual(values=c("darkgray", "darkgreen", "darkblue","darksalmon","darkred"))+
  ggtitle("British Columbia")+
  geom_bar(position="stack", stat="identity") + 
  theme_minimal() +
  xlim(factor(seq(1:8)))+
  xlab('')+
  ylab('No. populations')+ 
  theme(text=element_text(size=12), axis.title=element_text(size=12,face="bold"),axis.line = element_line(colour = "black", 
                      size = 1, linetype = "solid"),plot.title = element_text(size=14))

ak_pl=ggplot(sp_ak, aes(fill=species, y=n, x=factor(best_mod)))+
  scale_fill_manual(values=c("darkgray", "darkgreen", "darkblue","darksalmon","darkred"))+
  ggtitle("Alaska")+
  geom_bar(position="stack", stat="identity") + 
  theme_minimal() +
  xlim(factor(seq(1:8)))+
  xlab('')+
  ylab('No. populations')+ 
  theme(text=element_text(size=12), axis.title=element_text(size=12,face="bold"),axis.line = element_line(colour = "black", 
                      size = 1, linetype = "solid"),plot.title = element_text(size=14))


pg1=plot_grid(or_pl+ theme(legend.position="none"),
          wa_pl+ theme(legend.position="none"),
          bc_pl+ theme(legend.position="none"),
          ak_pl+ theme(legend.position="none"),
          ncol=2,nrow=2,labels=c("A","B","C","D"))

legend= get_legend(bc_pl)

plot_grid(pg1,legend,rel_widths = c(3,.5))

```


### By ocean basin

Top models broken down by ocean basin:

```{r, top model BIC broken down by ocean basin}
sp_ocean = bic %>% group_by(ocean.basin,best_mod,species) %>% summarize(n=n(),.groups='keep')
sp_ocean1 = bic %>% group_by(ocean.basin,species) %>% summarize(n=n(),.groups='keep')
sp_ocean2 = bic %>% group_by(ocean.basin,best_mod) %>% summarize(n=n(),.groups='keep')
sp_ocean3 = bic %>% group_by(ocean.basin) %>% summarize(n=n())
sp_ocean$prop = sp_ocean$n/sp_ocean1$n[match(paste(sp_ocean$ocean.basin,sp_ocean$species,sep='_'),paste(sp_ocean1$ocean.basin,sp_ocean1$species,sep='_'))]
sp_ocean2$prop = sp_ocean2$n/sp_ocean3$n[match(paste(sp_ocean2$ocean.basin,sp_ocean2$species,sep='_'),paste(sp_ocean3$ocean.basin,sp_ocean3$species,sep='_'))]


sp_BS=subset(sp_ocean,ocean.basin=='BS')
sp1_BS=subset(sp_ocean1,ocean.basin=='BS')
sp_GOA=subset(sp_ocean,ocean.basin=='GOA')
sp1_GOA=subset(sp_ocean1,ocean.basin=='GOA')
sp_WC=subset(sp_ocean,ocean.basin=='WC')
sp1_WC=subset(sp_ocean1,ocean.basin=='WC')


WC_pl=ggplot(sp_WC, aes(fill=factor(best_mod), y=prop, x=species))+
  scale_fill_manual(values=mod_col[match(levels(factor(sp_WC$best_mod)),mod_col[,2])],name='Model')+ 
  ggtitle("West Coast")+
  geom_bar(position="stack", stat="identity") +
  geom_text(label=sp_WC$n, position = position_stack(vjust = 0.5),colour='white',size=2.2)+
  ylim(0,1.05)+
  theme_minimal() +
  xlab('')+
  ylab('Prop. populations')+ 
  theme(text=element_text(size=10),axis.text=element_text(size=10),axis.line = element_line(colour = "black", 
                      size = 1, linetype = "solid"),plot.title = element_text(size=12))+
annotation_custom(grid::textGrob(sp1_WC$n[1],gp=grid::gpar(fontsize=8)), xmin = 1, xmax = 1, ymin = 1.05, ymax = 1.05)+
  annotation_custom(grid::textGrob(sp1_WC$n[2],gp=grid::gpar(fontsize=8)), xmin = 2, xmax = 2, ymin = 1.05, ymax = 1.05)+
    annotation_custom(grid::textGrob(sp1_WC$n[3],gp=grid::gpar(fontsize=8)), xmin = 3, xmax = 3, ymin = 1.05, ymax = 1.05)+
      annotation_custom(grid::textGrob(sp1_WC$n[4],gp=grid::gpar(fontsize=8)), xmin = 4, xmax = 4, ymin = 1.05, ymax = 1.05)+
         annotation_custom(grid::textGrob(sp1_WC$n[5],gp=grid::gpar(fontsize=8)), xmin = 5, xmax = 5, ymin = 1.05, ymax = 1.05)


GOA_pl=ggplot(sp_GOA, aes(fill=factor(best_mod), y=prop, x=species))+
  scale_fill_manual(values=mod_col[match(levels(factor(sp_GOA$best_mod)),mod_col[,2])],name='Model')+ 
  ggtitle("Gulf of Alaska")+
  geom_bar(position="stack", stat="identity") +
  geom_text(label=sp_GOA$n, position = position_stack(vjust = 0.5),colour='white',size=2.2)+
  ylim(0,1.05)+
  theme_minimal() +
  xlab('')+
  ylab('')+ 
  theme(text=element_text(size=10),axis.text=element_text(size=10),axis.line = element_line(colour = "black", 
                      size = 1, linetype = "solid"),plot.title = element_text(size=12))+
annotation_custom(grid::textGrob(sp1_GOA$n[1],gp=grid::gpar(fontsize=8)), xmin = 1, xmax = 1, ymin = 1.05, ymax = 1.05)+
  annotation_custom(grid::textGrob(sp1_GOA$n[2],gp=grid::gpar(fontsize=8)), xmin = 2, xmax = 2, ymin = 1.05, ymax = 1.05)+
    annotation_custom(grid::textGrob(sp1_GOA$n[3],gp=grid::gpar(fontsize=8)), xmin = 3, xmax = 3, ymin = 1.05, ymax = 1.05)+
      annotation_custom(grid::textGrob(sp1_GOA$n[4],gp=grid::gpar(fontsize=8)), xmin = 4, xmax = 4, ymin = 1.05, ymax = 1.05)+
         annotation_custom(grid::textGrob(sp1_GOA$n[5],gp=grid::gpar(fontsize=8)), xmin = 5, xmax = 5, ymin = 1.05, ymax = 1.05)


BS_pl=ggplot(sp_BS, aes(fill=factor(best_mod), y=prop, x=species))+
  scale_fill_manual(values=mod_col[match(levels(factor(sp_BS$best_mod)),mod_col[,2])],name='Model')+ 
  ggtitle("Bering Sea")+
  geom_bar(position="stack", stat="identity") +
  geom_text(label=sp_BS$n, position = position_stack(vjust = 0.5),colour='white',size=2.2)+
  ylim(0,1.05)+
  theme_minimal() +
  xlab('')+
  ylab('Prop. populations')+ 
  theme(text=element_text(size=10),axis.text=element_text(size=10),axis.line = element_line(colour = "black", 
                      size = 1, linetype = "solid"),plot.title = element_text(size=12))+
annotation_custom(grid::textGrob(sp1_BS$n[1],gp=grid::gpar(fontsize=8)), xmin = 1, xmax = 1, ymin = 1.05, ymax = 1.05)+
  annotation_custom(grid::textGrob(sp1_BS$n[2],gp=grid::gpar(fontsize=8)), xmin = 2, xmax = 2, ymin = 1.05, ymax = 1.05)+
    annotation_custom(grid::textGrob(sp1_BS$n[3],gp=grid::gpar(fontsize=8)), xmin = 3, xmax = 3, ymin = 1.05, ymax = 1.05)+
      annotation_custom(grid::textGrob(sp1_BS$n[4],gp=grid::gpar(fontsize=8)), xmin = 4, xmax = 4, ymin = 1.05, ymax = 1.05)+
         annotation_custom(grid::textGrob(sp1_BS$n[5],gp=grid::gpar(fontsize=8)), xmin = 5, xmax = 5, ymin = 1.05, ymax = 1.05)

total_pl=ggplot(sp_ocean2, aes(fill=factor(best_mod), y=prop, x=ocean.basin))+
  scale_fill_manual(values=mod_col[match(levels(factor(sp_ocean2$best_mod)),mod_col[,2])],name='Model')+
   ggtitle("Total")+
  geom_bar(position="stack", stat="identity") +
  geom_text(label=sp_ocean2$n, position = position_stack(vjust = 0.5),colour='white',size=2.2)+
  ylim(0,1.05)+
  theme_minimal() +
  xlab('')+
  ylab('Prop. populations')+ 
  theme(text=element_text(size=10),axis.text=element_text(size=10),axis.line = element_line(colour = "black", 
                      size = 1, linetype = "solid"),plot.title = element_text(size=12))+
  annotation_custom(grid::textGrob(sum(sp1_BS$n),gp=grid::gpar(fontsize=8)), xmin = 1, xmax = 1, ymin = 1.05, ymax = 1.05)+
  annotation_custom(grid::textGrob(sum(sp1_GOA$n),gp=grid::gpar(fontsize=8)), xmin = 2, xmax = 2, ymin = 1.05, ymax = 1.05)+
    annotation_custom(grid::textGrob(sum(sp1_WC$n),gp=grid::gpar(fontsize=8)), xmin = 3, xmax = 3, ymin = 1.05, ymax = 1.05)


legend= get_legend(total_pl)

pg1=plot_grid(WC_pl+ theme(legend.position="none"),
          GOA_pl+ theme(legend.position="none"),
          BS_pl+ theme(legend.position="none"),
          total_pl+ theme(legend.position="none"),
          ncol=2,nrow=2,labels=c("A","B","C","D"))

plot_grid(pg1,legend,rel_widths = c(3,.5))
```

### By time-series length

```{r, bic by ts length}
bic$ts_length_bin=cut(
 stock_info_filtered$n.years,
  breaks = quantile(stock_info_filtered$n.years, seq(0,1,by=0.2)),
  labels = c('18-26','27-35','35-45','46-50','50+'))

bic_ts = bic %>% group_by(ts_length_bin,best_mod,species) %>% summarize(n=n(),.groups='keep')
sp = bic %>% group_by(species,best_mod) %>% summarize(n=n(),.groups='keep')
sp1 = bic %>% group_by(species) %>% summarize(n=n())
sp$prop = sp$n/sp1$n[match(sp$species,sp1$species)]

sp_18=subset(bic_ts,ts_length_bin=='18-26')
sp_27=subset(bic_ts,ts_length_bin=='27-35')
sp_35=subset(bic_ts,ts_length_bin=='35-45')
sp_45=subset(bic_ts,ts_length_bin=='46-50')
sp_50=subset(bic_ts,ts_length_bin=='50+')

pl_18=ggplot(sp_18, aes(fill=species, y=n, x=factor(best_mod)))+
  scale_fill_manual(values=sp_cols[match(levels(factor(sp_18$species)),sp_cols[,2])])+ 
  ggtitle("18 - 26 years")+
  geom_bar(position="stack", stat="identity") + 
  theme_minimal() +
  xlab('')+
  ylab('No. populations')+ 
  theme(text=element_text(size=12),axis.title=element_text(size=12,face="bold"),axis.line = element_line(colour = "black", 
                      size = 1, linetype = "solid"),plot.title = element_text(size=14))

pl_27=ggplot(sp_27, aes(fill=species, y=n, x=factor(best_mod)))+
  scale_fill_manual(values=sp_cols[match(levels(factor(sp_27$species)),sp_cols[,2])])+
  ggtitle("27 - 35 years")+
  geom_bar(position="stack", stat="identity") + 
  theme_minimal() +
  xlim(factor(seq(1:8)))+
  xlab('')+
  ylab('No. populations')+ 
  theme(text=element_text(size=12),axis.title=element_text(size=12,face="bold"),axis.line = element_line(colour = "black", 
                      size = 1, linetype = "solid"),plot.title = element_text(size=14))

pl_35=ggplot(sp_35, aes(fill=species, y=n, x=factor(best_mod)))+
  scale_fill_manual(values=sp_cols[match(levels(factor(sp_35$species)),sp_cols[,2])])+
  ggtitle("35 - 45 years")+
  geom_bar(position="stack", stat="identity") + 
  theme_minimal() +
   xlim(factor(seq(1:8)))+
  xlab('')+
  ylab('')+ 
  theme(text=element_text(size=12), axis.title=element_text(size=12,face="bold"),axis.line = element_line(colour = "black", 
                      size = 1, linetype = "solid"),plot.title = element_text(size=14))

pl_45=ggplot(sp_45, aes(fill=species, y=n, x=factor(best_mod)))+
  scale_fill_manual(values=sp_cols[match(levels(factor(sp_45$species)),sp_cols[,2])])+
  ggtitle("46 - 50 years")+
  geom_bar(position="stack", stat="identity") + 
  theme_minimal() +
   xlim(factor(seq(1:8)))+
  xlab('')+
  ylab('No. populations')+ 
  theme(text=element_text(size=12), axis.title=element_text(size=12,face="bold"),axis.line = element_line(colour = "black", 
                      size = 1, linetype = "solid"),plot.title = element_text(size=14))

pl_50=ggplot(sp_50, aes(fill=species, y=n, x=factor(best_mod)))+
  scale_fill_manual(values=sp_cols[match(levels(factor(sp_50$species)),sp_cols[,2])])+
  ggtitle("50+ years")+
  geom_bar(position="stack", stat="identity") + 
  theme_minimal() +
   xlim(factor(seq(1:8)))+
  xlab('')+
  ylab('')+ 
  theme(text=element_text(size=12), axis.title=element_text(size=12,face="bold"),axis.line = element_line(colour = "black", 
                      size = 1, linetype = "solid"),plot.title = element_text(size=14))

legend= get_legend(pl_18)

plot_grid(pl_18+ theme(legend.position="none"),
          pl_27+ theme(legend.position="none"),
          pl_35+ theme(legend.position="none"),
          pl_45+ theme(legend.position="none"),
          pl_50+ theme(legend.position="none"),
          legend,
          ncol=3,nrow=2,labels=c("A","B","C","D","E"))
```


# 'Out-of-sample' Model selection

Here we look at two 'out-of-sample' information criteria.

Leave-one-out cross-validation (LOO-CV) iteratively drops each observation from the data and subsequently predicts the likelihood of observing that withheld observation under each model parameterized on the remaining dataset (ie. the training set). We use approximate LOO-CV with Pareto-smoothed importance sampling (PSIS LOO) using the rpackage 'loo'

Stock-recruitment data are time-series, and so forecasting should really only use past data to predict future out-of-sample predictions. In leave-future-out cross-validation (LFO-CV), we iteratively fit models to historical data (starting from a minimum sample window, $L$, and estimate the ability of each model to predict out-of-sample estimates 1-year ahead. Likelihoods for each observation are estimated from the Normal log predictive density function based on the expectation for each model. This is repeated for all observations from $L+1:N$. 


## Stan LFO-CV (L = 2/3n)

Note the minimum training set here is set to 2/3rds of the total observations, this will ultimately be changed to $L = 10$ (it is very slow to estimate). 

### Top models

```{r, model weights lfo}
lfo=read.csv(here('outputs','ms_rmd','lfo_table.csv'))
lfo$lat=round(lfo$lat,2)
lfo$lon=round(lfo$lon,2)
table(lfo$best_mod)
round(table(lfo$best_mod)/nrow(lfo),2)

lfo$state2=NA
lfo=lfo %>% mutate(state2=ifelse(state=='OR','OR-WA',state2),
                                                   state2=ifelse(state=='WA','OR-WA',state2))
```

```{r, model weights by pop, warning = FALSE}

sp = lfo %>% group_by(species,best_mod) %>% summarize(n=n(),.groups='keep')
sp1 = lfo %>% group_by(species) %>% summarize(n=n())
sp$prop = sp$n/sp1$n[match(sp$species,sp1$species)]

mod_col=cbind(c("azure4", "azure3", "cyan4","cadetblue3","deepskyblue4",'seagreen','olivedrab','darkgreen'),seq=1:8)

ggplot(sp, aes(fill=factor(best_mod), y=prop, x=species))+
  scale_fill_manual(values=mod_col[match(levels(factor(sp$best_mod)),mod_col[,2])],name='Model')+ 
  ggtitle("Top-ranked model (Stan LFO-CV, L=2/3n)")+
  geom_bar(position="stack", stat="identity",color='white') +
  geom_text(label=sp$n, position = position_stack(vjust = 0.5),colour='white',size=2.2)+
  ylim(0,1)+
  theme_minimal() +
  xlab('')+
  ylab('Prop. populations')+ 
  theme(text=element_text(size=14),axis.text=element_text(size=14),axis.line = element_line(colour = "black", 
                      size = 1, linetype = "solid"),plot.title = element_text(size=14))+
annotation_custom(grid::textGrob(sp1$n[1]), xmin = 1, xmax = 1, ymin = 1.03, ymax = 1.03)+
  annotation_custom(grid::textGrob(sp1$n[2]), xmin = 2, xmax = 2, ymin = 1.03, ymax = 1.03)+
    annotation_custom(grid::textGrob(sp1$n[3]), xmin = 3, xmax = 3, ymin = 1.03, ymax = 1.03)+
      annotation_custom(grid::textGrob(sp1$n[4]), xmin = 4, xmax = 4, ymin = 1.03, ymax = 1.03)+
       annotation_custom(grid::textGrob(sp1$n[5]), xmin = 5, xmax = 5, ymin = 1.03, ymax = 1.03)
```

```{r, lfo model class by pop, warning = FALSE}
lfo$mod_class=NA
lfo= lfo %>%
    mutate(
      mod_class=ifelse(best_mod<=2,'static', mod_class),
       mod_class=ifelse(best_mod %in% c(3,4,5),'dynamic', mod_class),
      mod_class=ifelse(best_mod>=6,'regime', mod_class),
    )
lfo$mod_class=factor(lfo$mod_class,levels=c('static','dynamic','regime'))
sp = lfo %>% group_by(species,mod_class) %>% summarize(n=n(),.groups='keep')
sp1 = lfo %>% group_by(species) %>% summarize(n=n())
sp$prop = sp$n/sp1$n[match(sp$species,sp1$species)]

ggplot(sp, aes(fill=factor(mod_class), y=prop, x=species))+
  scale_fill_manual(values=mc_col[match(levels(factor(sp$mod_class)),mc_col[,2])],name='Model')+ 
  ggtitle("Top-ranked model (Stan LFO-CV, L=2/3n)")+
  geom_bar(position="stack", stat="identity",color='white') +
  geom_text(label=sp$n, position = position_stack(vjust = 0.5),colour='white',size=2.2)+
  ylim(0,1)+
  theme_minimal() +
  xlab('')+
  ylab('Prop. populations')+ 
  theme(text=element_text(size=14),axis.text=element_text(size=14),axis.line = element_line(colour = "black", 
                      size = 1, linetype = "solid"),plot.title = element_text(size=14))+
annotation_custom(grid::textGrob(sp1$n[1]), xmin = 1, xmax = 1, ymin = 1.03, ymax = 1.03)+
  annotation_custom(grid::textGrob(sp1$n[2]), xmin = 2, xmax = 2, ymin = 1.03, ymax = 1.03)+
    annotation_custom(grid::textGrob(sp1$n[3]), xmin = 3, xmax = 3, ymin = 1.03, ymax = 1.03)+
      annotation_custom(grid::textGrob(sp1$n[4]), xmin = 4, xmax = 4, ymin = 1.03, ymax = 1.03)+
       annotation_custom(grid::textGrob(sp1$n[5]), xmin = 5, xmax = 5, ymin = 1.03, ymax = 1.03)

round(table(lfo$mod_class)/nrow(lfo),2)

```
### By jurisdiction

Top models broken down by state:

```{r, broken down by state }
sp_state = lfo %>% group_by(state,species,best_mod) %>% summarize(n=n(),.groups='keep')
sp_state1 = lfo %>% group_by(state,species) %>% summarize(n=n(),.groups='keep')
sp_state$prop = sp_state$n/sp_state1$n[match(paste(sp_state$state,sp_state$species,sep='_'),paste(sp_state1$state,sp_state1$species,sep='_'))]

sp_ak=subset(sp_state,state=='AK')
sp1_ak=subset(sp_state1,state=='AK')
sp_bc=subset(sp_state,state=='BC')
sp1_bc=subset(sp_state1,state=='BC')
sp_wa=subset(sp_state,state=='WA')
sp1_wa=subset(sp_state1,state=='WA')
sp_or=subset(sp_state,state=='OR')
sp1_or=subset(sp_state1,state=='OR')

or_pl=ggplot(sp_or, aes(fill=factor(best_mod), y=prop, x=species))+
  scale_fill_manual(values=mod_col[match(levels(factor(sp_or$best_mod)),mod_col[,2])],name='Model')+ 
  ggtitle("Oregon")+
  geom_bar(position="stack", stat="identity") +
  geom_text(label=sp_or$n, position = position_stack(vjust = 0.5),colour='white',size=2.2)+
  ylim(0,1.05)+
  theme_minimal() +
  xlab('')+
  ylab('Prop. populations')+ 
  theme(text=element_text(size=10),axis.text=element_text(size=10),axis.line = element_line(colour = "black", 
                      size = 1, linetype = "solid"),plot.title = element_text(size=12))+
annotation_custom(grid::textGrob(sp1_or$n[1],gp=grid::gpar(fontsize=8)), xmin = 1, xmax = 1, ymin = 1.05, ymax = 1.05)+
  annotation_custom(grid::textGrob(sp1_or$n[2],gp=grid::gpar(fontsize=8)), xmin = 2, xmax = 2, ymin = 1.05, ymax = 1.05)


wa_pl=ggplot(sp_wa, aes(fill=factor(best_mod), y=prop, x=species))+
  scale_fill_manual(values=mod_col[match(levels(factor(sp_wa$best_mod)),mod_col[,2])],name='Model')+ 
  ggtitle("Washington")+
  geom_bar(position="stack", stat="identity") +
  geom_text(label=sp_wa$n, position = position_stack(vjust = 0.5),colour='white',size=2.2)+
  ylim(0,1.05)+
  theme_minimal() +
  xlab('')+
  ylab('')+ 
  theme(text=element_text(size=10),axis.text=element_text(size=10),axis.line = element_line(colour = "black", 
                      size = 1, linetype = "solid"),plot.title = element_text(size=12))+
annotation_custom(grid::textGrob(sp1_wa$n[1],gp=grid::gpar(fontsize=8)), xmin = 1, xmax = 1, ymin = 1.05, ymax = 1.05)+
  annotation_custom(grid::textGrob(sp1_wa$n[2],gp=grid::gpar(fontsize=8)), xmin = 2, xmax = 2, ymin = 1.05, ymax = 1.05)+
    annotation_custom(grid::textGrob(sp1_wa$n[3],gp=grid::gpar(fontsize=8)), xmin = 3, xmax = 3, ymin = 1.05, ymax = 1.05)+
      annotation_custom(grid::textGrob(sp1_wa$n[4],gp=grid::gpar(fontsize=8)), xmin = 4, xmax = 4, ymin = 1.05, ymax = 1.05)



bc_pl=ggplot(sp_bc, aes(fill=factor(best_mod), y=prop, x=species))+
  scale_fill_manual(values=mod_col[match(levels(factor(sp_bc$best_mod)),mod_col[,2])],name='Model')+ 
  ggtitle("British Columbia")+
  geom_bar(position="stack", stat="identity") +
  geom_text(label=sp_bc$n, position = position_stack(vjust = 0.5),colour='white',size=2.2)+
  ylim(0,1.05)+
  theme_minimal() +
  xlab('')+
  ylab('Prop. populations')+ 
  theme(text=element_text(size=10),axis.text=element_text(size=10),axis.line = element_line(colour = "black", 
                      size = 1, linetype = "solid"),plot.title = element_text(size=12))+
annotation_custom(grid::textGrob(sp1_bc$n[1],gp=grid::gpar(fontsize=8)), xmin = 1, xmax = 1, ymin = 1.05, ymax = 1.05)+
  annotation_custom(grid::textGrob(sp1_bc$n[2],gp=grid::gpar(fontsize=8)), xmin = 2, xmax = 2, ymin = 1.05, ymax = 1.05)+
    annotation_custom(grid::textGrob(sp1_bc$n[3],gp=grid::gpar(fontsize=8)), xmin = 3, xmax = 3, ymin = 1.05, ymax = 1.05)+
      annotation_custom(grid::textGrob(sp1_bc$n[4],gp=grid::gpar(fontsize=8)), xmin = 4, xmax = 4, ymin = 1.05, ymax = 1.05)+
         annotation_custom(grid::textGrob(sp1_bc$n[5],gp=grid::gpar(fontsize=8)), xmin = 5, xmax = 5, ymin = 1.05, ymax = 1.05)

ak_pl=ggplot(sp_ak, aes(fill=factor(best_mod), y=prop, x=species))+
  scale_fill_manual(values=mod_col[match(levels(factor(sp_ak$best_mod)),mod_col[,2])],name='Model')+ 
  ggtitle("Alaska")+
  geom_bar(position="stack", stat="identity") +
  geom_text(label=sp_ak$n, position = position_stack(vjust = 0.5),colour='white',size=2.2)+
  ylim(0,1.05)+
  theme_minimal() +
  xlab('')+
  ylab('')+ 
  theme(text=element_text(size=10),axis.text=element_text(size=10),axis.line = element_line(colour = "black", 
                      size = 1, linetype = "solid"),plot.title = element_text(size=12))+
annotation_custom(grid::textGrob(sp1_ak$n[1],gp=grid::gpar(fontsize=8)), xmin = 1, xmax = 1, ymin = 1.05, ymax = 1.05)+
  annotation_custom(grid::textGrob(sp1_ak$n[2],gp=grid::gpar(fontsize=8)), xmin = 2, xmax = 2, ymin = 1.05, ymax = 1.05)+
    annotation_custom(grid::textGrob(sp1_ak$n[3],gp=grid::gpar(fontsize=8)), xmin = 3, xmax = 3, ymin = 1.05, ymax = 1.05)+
      annotation_custom(grid::textGrob(sp1_ak$n[4],gp=grid::gpar(fontsize=8)), xmin = 4, xmax = 4, ymin = 1.05, ymax = 1.05)+
         annotation_custom(grid::textGrob(sp1_ak$n[5],gp=grid::gpar(fontsize=8)), xmin = 5, xmax = 5, ymin = 1.05, ymax = 1.05)

pg1=plot_grid(or_pl+ theme(legend.position="none"),
          wa_pl+ theme(legend.position="none"),
          bc_pl+ theme(legend.position="none"),
          ak_pl+ theme(legend.position="none"),
          ncol=2,nrow=2,labels=c("A","B","C","D"))

legend= get_legend(bc_pl)

plot_grid(pg1,legend,rel_widths = c(3,.5))

```


### By ocean basin

Top models broken down by ocean basin:

```{r, broken down by state and ocean basin}
sp_ocean = lfo %>% group_by(ocean.basin,best_mod,species) %>% summarize(n=n(),.groups='keep')
sp_ocean1 = lfo %>% group_by(ocean.basin,species) %>% summarize(n=n(),.groups='keep')
sp_ocean2 = lfo %>% group_by(ocean.basin,best_mod) %>% summarize(n=n(),.groups='keep')
sp_ocean3 = lfo %>% group_by(ocean.basin) %>% summarize(n=n())
sp_ocean$prop = sp_ocean$n/sp_ocean1$n[match(paste(sp_ocean$ocean.basin,sp_ocean$species,sep='_'),paste(sp_ocean1$ocean.basin,sp_ocean1$species,sep='_'))]
sp_ocean2$prop = sp_ocean2$n/sp_ocean3$n[match(paste(sp_ocean2$ocean.basin,sp_ocean2$species,sep='_'),paste(sp_ocean3$ocean.basin,sp_ocean3$species,sep='_'))]


sp_BS=subset(sp_ocean,ocean.basin=='BS')
sp1_BS=subset(sp_ocean1,ocean.basin=='BS')
sp_GOA=subset(sp_ocean,ocean.basin=='GOA')
sp1_GOA=subset(sp_ocean1,ocean.basin=='GOA')
sp_WC=subset(sp_ocean,ocean.basin=='WC')
sp1_WC=subset(sp_ocean1,ocean.basin=='WC')


WC_pl=ggplot(sp_WC, aes(fill=factor(best_mod), y=prop, x=species))+
  scale_fill_manual(values=mod_col[match(levels(factor(sp_WC$best_mod)),mod_col[,2])],name='Model')+ 
  ggtitle("West Coast")+
  geom_bar(position="stack", stat="identity") +
  geom_text(label=sp_WC$n, position = position_stack(vjust = 0.5),colour='white',size=2.2)+
  ylim(0,1.05)+
  theme_minimal() +
  xlab('')+
  ylab('Prop. populations')+ 
  theme(text=element_text(size=10),axis.text=element_text(size=10),axis.line = element_line(colour = "black", 
                      size = 1, linetype = "solid"),plot.title = element_text(size=12))+
annotation_custom(grid::textGrob(sp1_WC$n[1],gp=grid::gpar(fontsize=8)), xmin = 1, xmax = 1, ymin = 1.05, ymax = 1.05)+
  annotation_custom(grid::textGrob(sp1_WC$n[2],gp=grid::gpar(fontsize=8)), xmin = 2, xmax = 2, ymin = 1.05, ymax = 1.05)+
    annotation_custom(grid::textGrob(sp1_WC$n[3],gp=grid::gpar(fontsize=8)), xmin = 3, xmax = 3, ymin = 1.05, ymax = 1.05)+
      annotation_custom(grid::textGrob(sp1_WC$n[4],gp=grid::gpar(fontsize=8)), xmin = 4, xmax = 4, ymin = 1.05, ymax = 1.05)+
         annotation_custom(grid::textGrob(sp1_WC$n[5],gp=grid::gpar(fontsize=8)), xmin = 5, xmax = 5, ymin = 1.05, ymax = 1.05)


GOA_pl=ggplot(sp_GOA, aes(fill=factor(best_mod), y=prop, x=species))+
  scale_fill_manual(values=mod_col[match(levels(factor(sp_GOA$best_mod)),mod_col[,2])],name='Model')+ 
  ggtitle("Gulf of Alaska")+
  geom_bar(position="stack", stat="identity") +
  geom_text(label=sp_GOA$n, position = position_stack(vjust = 0.5),colour='white',size=2.2)+
  ylim(0,1.05)+
  theme_minimal() +
  xlab('')+
  ylab('')+ 
  theme(text=element_text(size=10),axis.text=element_text(size=10),axis.line = element_line(colour = "black", 
                      size = 1, linetype = "solid"),plot.title = element_text(size=12))+
annotation_custom(grid::textGrob(sp1_GOA$n[1],gp=grid::gpar(fontsize=8)), xmin = 1, xmax = 1, ymin = 1.05, ymax = 1.05)+
  annotation_custom(grid::textGrob(sp1_GOA$n[2],gp=grid::gpar(fontsize=8)), xmin = 2, xmax = 2, ymin = 1.05, ymax = 1.05)+
    annotation_custom(grid::textGrob(sp1_GOA$n[3],gp=grid::gpar(fontsize=8)), xmin = 3, xmax = 3, ymin = 1.05, ymax = 1.05)+
      annotation_custom(grid::textGrob(sp1_GOA$n[4],gp=grid::gpar(fontsize=8)), xmin = 4, xmax = 4, ymin = 1.05, ymax = 1.05)+
         annotation_custom(grid::textGrob(sp1_GOA$n[5],gp=grid::gpar(fontsize=8)), xmin = 5, xmax = 5, ymin = 1.05, ymax = 1.05)


BS_pl=ggplot(sp_BS, aes(fill=factor(best_mod), y=prop, x=species))+
  scale_fill_manual(values=mod_col[match(levels(factor(sp_BS$best_mod)),mod_col[,2])],name='Model')+ 
  ggtitle("Bering Sea")+
  geom_bar(position="stack", stat="identity") +
  geom_text(label=sp_BS$n, position = position_stack(vjust = 0.5),colour='white',size=2.2)+
  ylim(0,1.05)+
  theme_minimal() +
  xlab('')+
  ylab('Prop. populations')+ 
  theme(text=element_text(size=10),axis.text=element_text(size=10),axis.line = element_line(colour = "black", 
                      size = 1, linetype = "solid"),plot.title = element_text(size=12))+
annotation_custom(grid::textGrob(sp1_BS$n[1],gp=grid::gpar(fontsize=8)), xmin = 1, xmax = 1, ymin = 1.05, ymax = 1.05)+
  annotation_custom(grid::textGrob(sp1_BS$n[2],gp=grid::gpar(fontsize=8)), xmin = 2, xmax = 2, ymin = 1.05, ymax = 1.05)+
    annotation_custom(grid::textGrob(sp1_BS$n[3],gp=grid::gpar(fontsize=8)), xmin = 3, xmax = 3, ymin = 1.05, ymax = 1.05)+
      annotation_custom(grid::textGrob(sp1_BS$n[4],gp=grid::gpar(fontsize=8)), xmin = 4, xmax = 4, ymin = 1.05, ymax = 1.05)+
         annotation_custom(grid::textGrob(sp1_BS$n[5],gp=grid::gpar(fontsize=8)), xmin = 5, xmax = 5, ymin = 1.05, ymax = 1.05)

total_pl=ggplot(sp_ocean2, aes(fill=factor(best_mod), y=prop, x=ocean.basin))+
  scale_fill_manual(values=mod_col[match(levels(factor(sp_ocean2$best_mod)),mod_col[,2])],name='Model')+
   ggtitle("Total")+
  geom_bar(position="stack", stat="identity") +
  geom_text(label=sp_ocean2$n, position = position_stack(vjust = 0.5),colour='white',size=2.2)+
  ylim(0,1.05)+
  theme_minimal() +
  xlab('')+
  ylab('Prop. populations')+ 
  theme(text=element_text(size=10),axis.text=element_text(size=10),axis.line = element_line(colour = "black", 
                      size = 1, linetype = "solid"),plot.title = element_text(size=12))+
  annotation_custom(grid::textGrob(sum(sp1_BS$n),gp=grid::gpar(fontsize=8)), xmin = 1, xmax = 1, ymin = 1.05, ymax = 1.05)+
  annotation_custom(grid::textGrob(sum(sp1_GOA$n),gp=grid::gpar(fontsize=8)), xmin = 2, xmax = 2, ymin = 1.05, ymax = 1.05)+
    annotation_custom(grid::textGrob(sum(sp1_WC$n),gp=grid::gpar(fontsize=8)), xmin = 3, xmax = 3, ymin = 1.05, ymax = 1.05)


legend= get_legend(GOA_pl)

pg1=plot_grid(WC_pl+ theme(legend.position="none"),
          GOA_pl+ theme(legend.position="none"),
          BS_pl+ theme(legend.position="none"),
          total_pl+ theme(legend.position="none"),
          ncol=2,nrow=2,labels=c("A","B","C","D"))

plot_grid(pg1,legend,rel_widths = c(3,.5))



```

### By time-series length

```{r, lfo by ts length}
lfo$ts_length_bin=cut(
 stock_info_filtered$n.years,
  breaks = quantile(stock_info_filtered$n.years, seq(0,1,by=0.2)),
  labels = c('18-26','27-35','35-45','46-50','50+'))

lfo_ts = lfo %>% group_by(ts_length_bin,best_mod,species) %>% summarize(n=n(),.groups='keep')
sp = lfo %>% group_by(species,best_mod) %>% summarize(n=n(),.groups='keep')
sp1 = lfo %>% group_by(species) %>% summarize(n=n())
sp$prop = sp$n/sp1$n[match(sp$species,sp1$species)]

sp_18=subset(lfo_ts,ts_length_bin=='18-26')
sp_27=subset(lfo_ts,ts_length_bin=='27-35')
sp_35=subset(lfo_ts,ts_length_bin=='35-45')
sp_45=subset(lfo_ts,ts_length_bin=='46-50')
sp_50=subset(lfo_ts,ts_length_bin=='50+')

pl_18=ggplot(sp_18, aes(fill=species, y=n, x=factor(best_mod)))+
  scale_fill_manual(values=sp_cols[match(levels(factor(sp_18$species)),sp_cols[,2])])+ 
  ggtitle("18 - 26 years")+
  geom_bar(position="stack", stat="identity") + 
  theme_minimal() +
  xlab('')+
  ylab('No. populations')+ 
  theme(text=element_text(size=12),axis.title=element_text(size=12,face="bold"),axis.line = element_line(colour = "black", 
                      size = 1, linetype = "solid"),plot.title = element_text(size=14))

pl_27=ggplot(sp_27, aes(fill=species, y=n, x=factor(best_mod)))+
  scale_fill_manual(values=sp_cols[match(levels(factor(sp_27$species)),sp_cols[,2])])+
  ggtitle("27 - 35 years")+
  geom_bar(position="stack", stat="identity") + 
  theme_minimal() +
  xlim(factor(seq(1:8)))+
  xlab('')+
  ylab('No. populations')+ 
  theme(text=element_text(size=12),axis.title=element_text(size=12,face="bold"),axis.line = element_line(colour = "black", 
                      size = 1, linetype = "solid"),plot.title = element_text(size=14))

pl_35=ggplot(sp_35, aes(fill=species, y=n, x=factor(best_mod)))+
  scale_fill_manual(values=sp_cols[match(levels(factor(sp_35$species)),sp_cols[,2])])+
  ggtitle("35 - 45 years")+
  geom_bar(position="stack", stat="identity") + 
  theme_minimal() +
   xlim(factor(seq(1:8)))+
  xlab('')+
  ylab('')+ 
  theme(text=element_text(size=12), axis.title=element_text(size=12,face="bold"),axis.line = element_line(colour = "black", 
                      size = 1, linetype = "solid"),plot.title = element_text(size=14))

pl_45=ggplot(sp_45, aes(fill=species, y=n, x=factor(best_mod)))+
  scale_fill_manual(values=sp_cols[match(levels(factor(sp_45$species)),sp_cols[,2])])+
  ggtitle("46 - 50 years")+
  geom_bar(position="stack", stat="identity") + 
  theme_minimal() +
   xlim(factor(seq(1:8)))+
  xlab('')+
  ylab('No. populations')+ 
  theme(text=element_text(size=12), axis.title=element_text(size=12,face="bold"),axis.line = element_line(colour = "black", 
                      size = 1, linetype = "solid"),plot.title = element_text(size=14))

pl_50=ggplot(sp_50, aes(fill=species, y=n, x=factor(best_mod)))+
  scale_fill_manual(values=sp_cols[match(levels(factor(sp_50$species)),sp_cols[,2])])+
  ggtitle("50+ years")+
  geom_bar(position="stack", stat="identity") + 
  theme_minimal() +
   xlim(factor(seq(1:8)))+
  xlab('')+
  ylab('')+ 
  theme(text=element_text(size=12), axis.title=element_text(size=12,face="bold"),axis.line = element_line(colour = "black", 
                      size = 1, linetype = "solid"),plot.title = element_text(size=14))

legend= get_legend(pl_18)

plot_grid(pl_18+ theme(legend.position="none"),
          pl_27+ theme(legend.position="none"),
          pl_35+ theme(legend.position="none"),
          pl_45+ theme(legend.position="none"),
          pl_50+ theme(legend.position="none"),
          legend,
          ncol=3,nrow=2,labels=c("A","B","C","D","E"))
```



## TMB LFO-CV (L=10)

Note the minimum training set here is $L = 10$. 

### Top models

```{r, TMB lfo model weights}
tmb_lfo=read.csv(here('outputs','ms_rmd','tmb_lfo_table.csv'))
tmb_lfo$lat=round(tmb_lfo$lat,2)
tmb_lfo$lon=round(tmb_lfo$lon,2)
table(tmb_lfo$best_mod)
round(table(tmb_lfo$best_mod)/nrow(tmb_lfo),2)
tmb_lfo$state2=NA
tmb_lfo=tmb_lfo %>% mutate(state2=ifelse(state=='OR','OR-WA',state2),
                                                   state2=ifelse(state=='WA','OR-WA',state2))
```

```{r, TMB lfo model weights by pop, warning = FALSE}
sp = tmb_lfo %>% group_by(species,best_mod) %>% summarize(n=n(),.groups='keep')
sp1 = tmb_lfo %>% group_by(species) %>% summarize(n=n())
sp$prop = sp$n/sp1$n[match(sp$species,sp1$species)]

mod_col=cbind(c("azure4", "azure3", "cyan4","cadetblue3","deepskyblue4",'seagreen','olivedrab','darkgreen'),seq=1:8)

ggplot(sp, aes(fill=factor(best_mod), y=prop, x=species))+
  scale_fill_manual(values=mod_col[match(levels(factor(sp$best_mod)),mod_col[,2])],name='Model')+ 
  ggtitle("Top-ranked model (TMB LFO-CV, L = 10)")+
  geom_bar(position="stack", stat="identity",color='white') +
  geom_text(label=sp$n, position = position_stack(vjust = 0.5),colour='white',size=2.2)+
  ylim(0,1)+
  theme_minimal() +
  xlab('')+
  ylab('Prop. populations')+ 
  theme(text=element_text(size=14),axis.text=element_text(size=14),axis.line = element_line(colour = "black", 
                      size = 1, linetype = "solid"),plot.title = element_text(size=14))+
annotation_custom(grid::textGrob(sp1$n[1]), xmin = 1, xmax = 1, ymin = 1.03, ymax = 1.03)+
  annotation_custom(grid::textGrob(sp1$n[2]), xmin = 2, xmax = 2, ymin = 1.03, ymax = 1.03)+
    annotation_custom(grid::textGrob(sp1$n[3]), xmin = 3, xmax = 3, ymin = 1.03, ymax = 1.03)+
      annotation_custom(grid::textGrob(sp1$n[4]), xmin = 4, xmax = 4, ymin = 1.03, ymax = 1.03)+
       annotation_custom(grid::textGrob(sp1$n[5]), xmin = 5, xmax = 5, ymin = 1.03, ymax = 1.03)
```


```{r, lfo_tmb model class by pop, warning = FALSE}
tmb_lfo$mod_class=NA
tmb_lfo= tmb_lfo %>%
    mutate(
      mod_class=ifelse(best_mod<=2,'static', mod_class),
       mod_class=ifelse(best_mod %in% c(3,4,5),'dynamic', mod_class),
      mod_class=ifelse(best_mod>=6,'regime', mod_class),
    )
tmb_lfo$mod_class=factor(tmb_lfo$mod_class,levels=c('static','dynamic','regime'))
sp = tmb_lfo %>% group_by(species,mod_class) %>% summarize(n=n(),.groups='keep')
sp1 = tmb_lfo %>% group_by(species) %>% summarize(n=n())
sp$prop = sp$n/sp1$n[match(sp$species,sp1$species)]

ggplot(sp, aes(fill=factor(mod_class), y=prop, x=species))+
  scale_fill_manual(values=mc_col[match(levels(factor(sp$mod_class)),mc_col[,2])],name='Model')+ 
  ggtitle("Top-ranked model (TMB LFO-CV, L=10)")+
  geom_bar(position="stack", stat="identity",color='white') +
  geom_text(label=sp$n, position = position_stack(vjust = 0.5),colour='white',size=2.2)+
  ylim(0,1)+
  theme_minimal() +
  xlab('')+
  ylab('Prop. populations')+ 
  theme(text=element_text(size=14),axis.text=element_text(size=14),axis.line = element_line(colour = "black", 
                      size = 1, linetype = "solid"),plot.title = element_text(size=14))+
annotation_custom(grid::textGrob(sp1$n[1]), xmin = 1, xmax = 1, ymin = 1.03, ymax = 1.03)+
  annotation_custom(grid::textGrob(sp1$n[2]), xmin = 2, xmax = 2, ymin = 1.03, ymax = 1.03)+
    annotation_custom(grid::textGrob(sp1$n[3]), xmin = 3, xmax = 3, ymin = 1.03, ymax = 1.03)+
      annotation_custom(grid::textGrob(sp1$n[4]), xmin = 4, xmax = 4, ymin = 1.03, ymax = 1.03)+
       annotation_custom(grid::textGrob(sp1$n[5]), xmin = 5, xmax = 5, ymin = 1.03, ymax = 1.03)

round(table(tmb_lfo$mod_class)/nrow(tmb_lfo),2)

```
### By jurisdiction

Top models broken down by state:

```{r, TMB lfo top mod broken down by state }
sp_state = tmb_lfo %>% group_by(state,species,best_mod) %>% summarize(n=n(),.groups='keep')
sp_state1 = tmb_lfo %>% group_by(state,species) %>% summarize(n=n(),.groups='keep')
sp_state$prop = sp_state$n/sp_state1$n[match(paste(sp_state$state,sp_state$species,sep='_'),paste(sp_state1$state,sp_state1$species,sep='_'))]

sp_ak=subset(sp_state,state=='AK')
sp1_ak=subset(sp_state1,state=='AK')
sp_bc=subset(sp_state,state=='BC')
sp1_bc=subset(sp_state1,state=='BC')
sp_wa=subset(sp_state,state=='WA')
sp1_wa=subset(sp_state1,state=='WA')
sp_or=subset(sp_state,state=='OR')
sp1_or=subset(sp_state1,state=='OR')

or_pl=ggplot(sp_or, aes(fill=factor(best_mod), y=prop, x=species))+
  scale_fill_manual(values=mod_col[match(levels(factor(sp_or$best_mod)),mod_col[,2])],name='Model')+ 
  ggtitle("Oregon")+
  geom_bar(position="stack", stat="identity") +
  geom_text(label=sp_or$n, position = position_stack(vjust = 0.5),colour='white',size=2.2)+
  ylim(0,1.05)+
  theme_minimal() +
  xlab('')+
  ylab('Prop. populations')+ 
  theme(text=element_text(size=10),axis.text=element_text(size=10),axis.line = element_line(colour = "black", 
                      size = 1, linetype = "solid"),plot.title = element_text(size=12))+
annotation_custom(grid::textGrob(sp1_or$n[1],gp=grid::gpar(fontsize=8)), xmin = 1, xmax = 1, ymin = 1.05, ymax = 1.05)+
  annotation_custom(grid::textGrob(sp1_or$n[2],gp=grid::gpar(fontsize=8)), xmin = 2, xmax = 2, ymin = 1.05, ymax = 1.05)


wa_pl=ggplot(sp_wa, aes(fill=factor(best_mod), y=prop, x=species))+
  scale_fill_manual(values=mod_col[match(levels(factor(sp_wa$best_mod)),mod_col[,2])],name='Model')+ 
  ggtitle("Washington")+
  geom_bar(position="stack", stat="identity") +
  geom_text(label=sp_wa$n, position = position_stack(vjust = 0.5),colour='white',size=2.2)+
  ylim(0,1.05)+
  theme_minimal() +
  xlab('')+
  ylab('')+ 
  theme(text=element_text(size=10),axis.text=element_text(size=10),axis.line = element_line(colour = "black", 
                      size = 1, linetype = "solid"),plot.title = element_text(size=12))+
annotation_custom(grid::textGrob(sp1_wa$n[1],gp=grid::gpar(fontsize=8)), xmin = 1, xmax = 1, ymin = 1.05, ymax = 1.05)+
  annotation_custom(grid::textGrob(sp1_wa$n[2],gp=grid::gpar(fontsize=8)), xmin = 2, xmax = 2, ymin = 1.05, ymax = 1.05)+
    annotation_custom(grid::textGrob(sp1_wa$n[3],gp=grid::gpar(fontsize=8)), xmin = 3, xmax = 3, ymin = 1.05, ymax = 1.05)+
      annotation_custom(grid::textGrob(sp1_wa$n[4],gp=grid::gpar(fontsize=8)), xmin = 4, xmax = 4, ymin = 1.05, ymax = 1.05)


bc_pl=ggplot(sp_bc, aes(fill=factor(best_mod), y=prop, x=species))+
  scale_fill_manual(values=mod_col[match(levels(factor(sp_bc$best_mod)),mod_col[,2])],name='Model')+ 
  ggtitle("British Columbia")+
  geom_bar(position="stack", stat="identity") +
  geom_text(label=sp_bc$n, position = position_stack(vjust = 0.5),colour='white',size=2.2)+
  ylim(0,1.05)+
  theme_minimal() +
  xlab('')+
  ylab('Prop. populations')+ 
  theme(text=element_text(size=10),axis.text=element_text(size=10),axis.line = element_line(colour = "black", 
                      size = 1, linetype = "solid"),plot.title = element_text(size=12))+
annotation_custom(grid::textGrob(sp1_bc$n[1],gp=grid::gpar(fontsize=8)), xmin = 1, xmax = 1, ymin = 1.05, ymax = 1.05)+
  annotation_custom(grid::textGrob(sp1_bc$n[2],gp=grid::gpar(fontsize=8)), xmin = 2, xmax = 2, ymin = 1.05, ymax = 1.05)+
    annotation_custom(grid::textGrob(sp1_bc$n[3],gp=grid::gpar(fontsize=8)), xmin = 3, xmax = 3, ymin = 1.05, ymax = 1.05)+
      annotation_custom(grid::textGrob(sp1_bc$n[4],gp=grid::gpar(fontsize=8)), xmin = 4, xmax = 4, ymin = 1.05, ymax = 1.05)+
         annotation_custom(grid::textGrob(sp1_bc$n[5],gp=grid::gpar(fontsize=8)), xmin = 5, xmax = 5, ymin = 1.05, ymax = 1.05)

ak_pl=ggplot(sp_ak, aes(fill=factor(best_mod), y=prop, x=species))+
  scale_fill_manual(values=mod_col[match(levels(factor(sp_ak$best_mod)),mod_col[,2])],name='Model')+ 
  ggtitle("Alaska")+
  geom_bar(position="stack", stat="identity") +
  geom_text(label=sp_ak$n, position = position_stack(vjust = 0.5),colour='white',size=2.2)+
  ylim(0,1.05)+
  theme_minimal() +
  xlab('')+
  ylab('')+ 
  theme(text=element_text(size=10),axis.text=element_text(size=10),axis.line = element_line(colour = "black", 
                      size = 1, linetype = "solid"),plot.title = element_text(size=12))+
annotation_custom(grid::textGrob(sp1_ak$n[1],gp=grid::gpar(fontsize=8)), xmin = 1, xmax = 1, ymin = 1.05, ymax = 1.05)+
  annotation_custom(grid::textGrob(sp1_ak$n[2],gp=grid::gpar(fontsize=8)), xmin = 2, xmax = 2, ymin = 1.05, ymax = 1.05)+
    annotation_custom(grid::textGrob(sp1_ak$n[3],gp=grid::gpar(fontsize=8)), xmin = 3, xmax = 3, ymin = 1.05, ymax = 1.05)+
      annotation_custom(grid::textGrob(sp1_ak$n[4],gp=grid::gpar(fontsize=8)), xmin = 4, xmax = 4, ymin = 1.05, ymax = 1.05)+
         annotation_custom(grid::textGrob(sp1_ak$n[5],gp=grid::gpar(fontsize=8)), xmin = 5, xmax = 5, ymin = 1.05, ymax = 1.05)

pg1=plot_grid(or_pl+ theme(legend.position="none"),
          wa_pl+ theme(legend.position="none"),
          bc_pl+ theme(legend.position="none"),
          ak_pl+ theme(legend.position="none"),
          ncol=2,nrow=2,labels=c("A","B","C","D"))

legend= get_legend(bc_pl)

plot_grid(pg1,legend,rel_widths = c(3,.5))


```


### By ocean basin

Top models broken down by ocean basin:

```{r, TMB lfo top mod broken down by state and ocean basin}
sp_ocean = tmb_lfo %>% group_by(ocean.basin,best_mod,species) %>% summarize(n=n(),.groups='keep')
sp_ocean1 = tmb_lfo %>% group_by(ocean.basin,species) %>% summarize(n=n(),.groups='keep')
sp_ocean2 = tmb_lfo %>% group_by(ocean.basin,best_mod) %>% summarize(n=n(),.groups='keep')
sp_ocean3 = tmb_lfo %>% group_by(ocean.basin) %>% summarize(n=n())
sp_ocean$prop = sp_ocean$n/sp_ocean1$n[match(paste(sp_ocean$ocean.basin,sp_ocean$species,sep='_'),paste(sp_ocean1$ocean.basin,sp_ocean1$species,sep='_'))]
sp_ocean2$prop = sp_ocean2$n/sp_ocean3$n[match(paste(sp_ocean2$ocean.basin,sp_ocean2$species,sep='_'),paste(sp_ocean3$ocean.basin,sp_ocean3$species,sep='_'))]


sp_BS=subset(sp_ocean,ocean.basin=='BS')
sp1_BS=subset(sp_ocean1,ocean.basin=='BS')
sp_GOA=subset(sp_ocean,ocean.basin=='GOA')
sp1_GOA=subset(sp_ocean1,ocean.basin=='GOA')
sp_WC=subset(sp_ocean,ocean.basin=='WC')
sp1_WC=subset(sp_ocean1,ocean.basin=='WC')


WC_pl=ggplot(sp_WC, aes(fill=factor(best_mod), y=prop, x=species))+
  scale_fill_manual(values=mod_col[match(levels(factor(sp_WC$best_mod)),mod_col[,2])],name='Model')+ 
  ggtitle("West Coast")+
  geom_bar(position="stack", stat="identity") +
  geom_text(label=sp_WC$n, position = position_stack(vjust = 0.5),colour='white',size=2.2)+
  ylim(0,1.05)+
  theme_minimal() +
  xlab('')+
  ylab('Prop. populations')+ 
  theme(text=element_text(size=10),axis.text=element_text(size=10),axis.line = element_line(colour = "black", 
                      size = 1, linetype = "solid"),plot.title = element_text(size=12))+
annotation_custom(grid::textGrob(sp1_WC$n[1],gp=grid::gpar(fontsize=8)), xmin = 1, xmax = 1, ymin = 1.05, ymax = 1.05)+
  annotation_custom(grid::textGrob(sp1_WC$n[2],gp=grid::gpar(fontsize=8)), xmin = 2, xmax = 2, ymin = 1.05, ymax = 1.05)+
    annotation_custom(grid::textGrob(sp1_WC$n[3],gp=grid::gpar(fontsize=8)), xmin = 3, xmax = 3, ymin = 1.05, ymax = 1.05)+
      annotation_custom(grid::textGrob(sp1_WC$n[4],gp=grid::gpar(fontsize=8)), xmin = 4, xmax = 4, ymin = 1.05, ymax = 1.05)+
         annotation_custom(grid::textGrob(sp1_WC$n[5],gp=grid::gpar(fontsize=8)), xmin = 5, xmax = 5, ymin = 1.05, ymax = 1.05)


GOA_pl=ggplot(sp_GOA, aes(fill=factor(best_mod), y=prop, x=species))+
  scale_fill_manual(values=mod_col[match(levels(factor(sp_GOA$best_mod)),mod_col[,2])],name='Model')+ 
  ggtitle("Gulf of Alaska")+
  geom_bar(position="stack", stat="identity") +
  geom_text(label=sp_GOA$n, position = position_stack(vjust = 0.5),colour='white',size=2.2)+
  ylim(0,1.05)+
  theme_minimal() +
  xlab('')+
  ylab('')+ 
  theme(text=element_text(size=10),axis.text=element_text(size=10),axis.line = element_line(colour = "black", 
                      size = 1, linetype = "solid"),plot.title = element_text(size=12))+
annotation_custom(grid::textGrob(sp1_GOA$n[1],gp=grid::gpar(fontsize=8)), xmin = 1, xmax = 1, ymin = 1.05, ymax = 1.05)+
  annotation_custom(grid::textGrob(sp1_GOA$n[2],gp=grid::gpar(fontsize=8)), xmin = 2, xmax = 2, ymin = 1.05, ymax = 1.05)+
    annotation_custom(grid::textGrob(sp1_GOA$n[3],gp=grid::gpar(fontsize=8)), xmin = 3, xmax = 3, ymin = 1.05, ymax = 1.05)+
      annotation_custom(grid::textGrob(sp1_GOA$n[4],gp=grid::gpar(fontsize=8)), xmin = 4, xmax = 4, ymin = 1.05, ymax = 1.05)+
         annotation_custom(grid::textGrob(sp1_GOA$n[5],gp=grid::gpar(fontsize=8)), xmin = 5, xmax = 5, ymin = 1.05, ymax = 1.05)


BS_pl=ggplot(sp_BS, aes(fill=factor(best_mod), y=prop, x=species))+
  scale_fill_manual(values=mod_col[match(levels(factor(sp_BS$best_mod)),mod_col[,2])],name='Model')+ 
  ggtitle("Bering Sea")+
  geom_bar(position="stack", stat="identity") +
  geom_text(label=sp_BS$n, position = position_stack(vjust = 0.5),colour='white',size=2.2)+
  ylim(0,1.05)+
  theme_minimal() +
  xlab('')+
  ylab('Prop. populations')+ 
  theme(text=element_text(size=10),axis.text=element_text(size=10),axis.line = element_line(colour = "black", 
                      size = 1, linetype = "solid"),plot.title = element_text(size=12))+
annotation_custom(grid::textGrob(sp1_BS$n[1],gp=grid::gpar(fontsize=8)), xmin = 1, xmax = 1, ymin = 1.05, ymax = 1.05)+
  annotation_custom(grid::textGrob(sp1_BS$n[2],gp=grid::gpar(fontsize=8)), xmin = 2, xmax = 2, ymin = 1.05, ymax = 1.05)+
    annotation_custom(grid::textGrob(sp1_BS$n[3],gp=grid::gpar(fontsize=8)), xmin = 3, xmax = 3, ymin = 1.05, ymax = 1.05)+
      annotation_custom(grid::textGrob(sp1_BS$n[4],gp=grid::gpar(fontsize=8)), xmin = 4, xmax = 4, ymin = 1.05, ymax = 1.05)+
         annotation_custom(grid::textGrob(sp1_BS$n[5],gp=grid::gpar(fontsize=8)), xmin = 5, xmax = 5, ymin = 1.05, ymax = 1.05)

total_pl=ggplot(sp_ocean2, aes(fill=factor(best_mod), y=prop, x=ocean.basin))+
  scale_fill_manual(values=mod_col[match(levels(factor(sp_ocean2$best_mod)),mod_col[,2])],name='Model')+
   ggtitle("Total")+
  geom_bar(position="stack", stat="identity") +
  geom_text(label=sp_ocean2$n, position = position_stack(vjust = 0.5),colour='white',size=2.2)+
  ylim(0,1.05)+
  theme_minimal() +
  xlab('')+
  ylab('Prop. populations')+ 
  theme(text=element_text(size=10),axis.text=element_text(size=10),axis.line = element_line(colour = "black", 
                      size = 1, linetype = "solid"),plot.title = element_text(size=12))+
  annotation_custom(grid::textGrob(sum(sp1_BS$n),gp=grid::gpar(fontsize=8)), xmin = 1, xmax = 1, ymin = 1.05, ymax = 1.05)+
  annotation_custom(grid::textGrob(sum(sp1_GOA$n),gp=grid::gpar(fontsize=8)), xmin = 2, xmax = 2, ymin = 1.05, ymax = 1.05)+
    annotation_custom(grid::textGrob(sum(sp1_WC$n),gp=grid::gpar(fontsize=8)), xmin = 3, xmax = 3, ymin = 1.05, ymax = 1.05)


legend= get_legend(total_pl)

pg1=plot_grid(WC_pl+ theme(legend.position="none"),
          GOA_pl+ theme(legend.position="none"),
          BS_pl+ theme(legend.position="none"),
          total_pl+ theme(legend.position="none"),
          ncol=2,nrow=2,labels=c("A","B","C","D"))

plot_grid(pg1,legend,rel_widths = c(3,.5))


```

### By time-series length

```{r, tmb lfo by ts length}
tmb_lfo$ts_length_bin=cut(
 stock_info_filtered$n.years,
  breaks = quantile(stock_info_filtered$n.years, seq(0,1,by=0.2)),
  labels = c('18-26','27-35','35-45','46-50','50+'))

tmb_lfo_ts = tmb_lfo %>% group_by(ts_length_bin,best_mod,species) %>% summarize(n=n(),.groups='keep')
sp = tmb_lfo %>% group_by(species,best_mod) %>% summarize(n=n(),.groups='keep')
sp1 = tmb_lfo %>% group_by(species) %>% summarize(n=n())
sp$prop = sp$n/sp1$n[match(sp$species,sp1$species)]

sp_18=subset(tmb_lfo_ts,ts_length_bin=='18-26')
sp_27=subset(tmb_lfo_ts,ts_length_bin=='27-35')
sp_35=subset(tmb_lfo_ts,ts_length_bin=='35-45')
sp_45=subset(tmb_lfo_ts,ts_length_bin=='46-50')
sp_50=subset(tmb_lfo_ts,ts_length_bin=='50+')

pl_18=ggplot(sp_18, aes(fill=species, y=n, x=factor(best_mod)))+
  scale_fill_manual(values=sp_cols[match(levels(factor(sp_18$species)),sp_cols[,2])])+ 
  ggtitle("18 - 26 years")+
  geom_bar(position="stack", stat="identity") + 
  theme_minimal() +
  xlab('')+
  ylab('No. populations')+ 
  theme(text=element_text(size=12),axis.title=element_text(size=12,face="bold"),axis.line = element_line(colour = "black", 
                      size = 1, linetype = "solid"),plot.title = element_text(size=14))

pl_27=ggplot(sp_27, aes(fill=species, y=n, x=factor(best_mod)))+
  scale_fill_manual(values=sp_cols[match(levels(factor(sp_27$species)),sp_cols[,2])])+
  ggtitle("27 - 35 years")+
  geom_bar(position="stack", stat="identity") + 
  theme_minimal() +
  xlim(factor(seq(1:8)))+
  xlab('')+
  ylab('No. populations')+ 
  theme(text=element_text(size=12),axis.title=element_text(size=12,face="bold"),axis.line = element_line(colour = "black", 
                      size = 1, linetype = "solid"),plot.title = element_text(size=14))

pl_35=ggplot(sp_35, aes(fill=species, y=n, x=factor(best_mod)))+
  scale_fill_manual(values=sp_cols[match(levels(factor(sp_35$species)),sp_cols[,2])])+
  ggtitle("35 - 45 years")+
  geom_bar(position="stack", stat="identity") + 
  theme_minimal() +
   xlim(factor(seq(1:8)))+
  xlab('')+
  ylab('')+ 
  theme(text=element_text(size=12), axis.title=element_text(size=12,face="bold"),axis.line = element_line(colour = "black", 
                      size = 1, linetype = "solid"),plot.title = element_text(size=14))

pl_45=ggplot(sp_45, aes(fill=species, y=n, x=factor(best_mod)))+
  scale_fill_manual(values=sp_cols[match(levels(factor(sp_45$species)),sp_cols[,2])])+
  ggtitle("46 - 50 years")+
  geom_bar(position="stack", stat="identity") + 
  theme_minimal() +
   xlim(factor(seq(1:8)))+
  xlab('')+
  ylab('No. populations')+ 
  theme(text=element_text(size=12), axis.title=element_text(size=12,face="bold"),axis.line = element_line(colour = "black", 
                      size = 1, linetype = "solid"),plot.title = element_text(size=14))

pl_50=ggplot(sp_50, aes(fill=species, y=n, x=factor(best_mod)))+
  scale_fill_manual(values=sp_cols[match(levels(factor(sp_50$species)),sp_cols[,2])])+
  ggtitle("50+ years")+
  geom_bar(position="stack", stat="identity") + 
  theme_minimal() +
   xlim(factor(seq(1:8)))+
  xlab('')+
  ylab('')+ 
  theme(text=element_text(size=12), axis.title=element_text(size=12,face="bold"),axis.line = element_line(colour = "black", 
                      size = 1, linetype = "solid"),plot.title = element_text(size=14))

legend= get_legend(pl_18)

plot_grid(pl_18+ theme(legend.position="none"),
          pl_27+ theme(legend.position="none"),
          pl_35+ theme(legend.position="none"),
          pl_45+ theme(legend.position="none"),
          pl_50+ theme(legend.position="none"),
          legend,
          ncol=3,nrow=2,labels=c("A","B","C","D","E"))
```

# Population Overview

Here you will find the weights for each forms of the spawner-recruit model for every population. These are ordered by species and latitude of the point of ocean entry. The red shading indicates higher levels of weight towards a particular model.

## TMB AICc

```{r, AIC table}
formattable(aic[,2:ncol(aic)],
            list(area(col = 7:14) ~ color_tile("transparent", "red")))

```

## TMB BIC

```{r, BIC table}
formattable(bic[,2:ncol(bic)],
            list(area(col = 7:14) ~ color_tile("transparent", "red")))

```


## Stan LFO (L = 2/3n)

By population, ordered by species and latitude of ocean entry, with weights for the predictive accuracy of each model. Red indicates higher weight.

```{r, lfo table}
formattable(lfo[,2:ncol(lfo)],
            list(area(col = 7:14) ~ color_tile("transparent", "red")))

```

## TMB LFO-CV (L = 10)

```{r, tmb lfo table}
formattable(tmb_lfo[,2:ncol(tmb_lfo)],
            list(area(col = 7:14) ~ color_tile("transparent", "red")))

```

# S-R Plots
```{r, sr plots, results= 'asis'}
#ordered by species, then stock
for(q in 1:nrow(stock_info_filtered)){
  sp=subset(stock_dat2,species==levels(factor(stock_dat2$species))[q])
  rearg=as.numeric(rownames(stock_info_filtered[stock_info_filtered$species==levels(factor(stock_info_filtered$species))[q],]))
  
   cat('\n')  
   cat("## ", levels(factor(stock_dat2$species))[q], "\n") #nested region header
   
  for(i in 1:length(unique(sp$stock))){
 s<- subset(sp,stock==unique(sp$stock)[i])
 s<- s[complete.cases(s$logR_S),] 
  
  df=data.frame(S=s$spawners,R=s$recruits,by=s$broodyear,logRS=s$logR_S)

   cat('\n')  
   cat("### ", gsub('-.*','',unique(sp$stock)[i]), "\n") #nested region header
   
   
par(mfrow=c(1,1))   
by_q=round(quantile(df$by,seq(0,1,by=0.1)))
cols=rev(RColorBrewer::brewer.pal(11, 'RdYlBu'))
col.p=cols[cut(df$by, 11, labels = FALSE)]
plot(R~S,data=df,bty='l',pch=21,cex=1.5,bg='black',xlim=c(0,max(df$S)),ylim=c(0,max(df$R)),type='n')
lines(R~S,data=df)
text(y=par('usr')[4]*0.9,x=par('usr')[2]*0.05,paste('alpha:',round(median(pl2[[i]][,grepl('log_a',colnames(pl2[[i]]))]),3),sep=' '))
text(y=par('usr')[4]*0.85,x=par('usr')[2]*0.05,paste('smax:',round(median(pl2[[i]][,grepl('Smax',colnames(pl2[[i]]))]),0),sep=' '))
text(y=par('usr')[4]*0.8,x=par('usr')[2]*0.05,paste('sigma:',round(median(pl2[[i]][,grepl('sigma_AR',colnames(pl2[[i]]))]),2),sep=' '))
text(y=par('usr')[4]*0.75,x=par('usr')[2]*0.05,paste('rho:',round(median(pl2[[i]][,grepl('rho',colnames(pl2[[i]]))]),2),sep=' '))
mtext(side=3,at=(0.65)*max(df$S),'begins',padj=-1.4,cex=0.8)
mtext(side=3,at=(0.65)*max(df$S),by_q[1],col=cols[1],padj=.2,cex=0.8)
mtext(side=3,at=(0.70)*max(df$S),by_q[3],col=cols[3],padj=.2,cex=0.8)
mtext(side=3,at=(0.75)*max(df$S),by_q[5],col=cols[5],padj=.2,cex=0.8)
mtext(side=3,at=(0.80)*max(df$S),by_q[7],col=cols[7],padj=.2,cex=0.8)
mtext(side=3,at=(0.85)*max(df$S),by_q[9],col=cols[9],padj=.2,cex=0.8)
mtext(side=3,at=(0.9)*max(df$S),by_q[11],col=cols[11],padj=.2,cex=0.8)
mtext(side=3,at=(0.9)*max(df$S),'ends',padj=-1.4,cex=0.8)

x_new=seq(0,max(na.omit(df$S)),length.out=1000)
p1=exp(median(pl1[[rearg[i]]][,grepl('log_a',colnames(pl1[[rearg[i]]]))])-median(pl1[[rearg[i]]][,grepl('b',colnames(pl1[[rearg[i]]]))])*x_new)*x_new
p2=exp(median(pl2[[rearg[i]]][,grepl('log_a',colnames(pl2[[rearg[i]]]))])-median(pl2[[rearg[i]]][,grepl('b',colnames(pl2[[rearg[i]]]))])*x_new)*x_new

lines(p1~x_new,lwd=3)
lines(p2~x_new,lwd=3,col='darkgray',lty=5)
points(R~S,data=df,pch=21,cex=1.5,bg=col.p)

pr1=median(pl1[[rearg[i]]][,grepl('log_a',colnames(pl1[[rearg[i]]]))])-median(pl1[[rearg[i]]][,grepl('b',colnames(pl1[[rearg[i]]]))])*df$S
plot(df$logRS-pr1~df$by,bty='l',type='l',ylab='residuals',xlab='year')
abline(h=0,lty=2)
points(df$logRS-pr1~df$by,pch=21,bg=col.p,cex=1.5)

#dynamic prod
#par(mfrow=c(1,2))
by_q=round(quantile(df$by,seq(0,1,by=0.1)))
cols=rev(RColorBrewer::brewer.pal(11, 'RdYlBu'))
col.p=cols[cut(df$by, 11, labels = FALSE)]
plot(R~S,data=df,bty='l',pch=21,cex=1.5,bg='black',main='dynamic prod.',xlim=c(0,max(df$S)),ylim=c(0,max(df$R)),type='n')
lines(R~S,data=df)
for(t in 1:nrow(df)){
  p=exp(median(pl3[[rearg[i]]][,grepl('log_a',colnames(pl3[[rearg[i]]]))][,t])-median(pl3[[rearg[i]]][,grepl('b',colnames(pl3[[rearg[i]]]))])*x_new)*x_new
  lines(p~x_new,lwd=2,col=col.p[t])
}
points(R~S,data=df,pch=21,cex=1.5,bg=col.p)

plot(apply(pl3[[rearg[i]]][,grepl('log_a',colnames(pl3[[rearg[i]]]))],2,median)~seq(min(df$by),max(df$by)),data=df,bty='l',ylab='alpha',xlab='year',ylim=c(quantile(unlist(pl3[[rearg[i]]][,grepl('log_a',colnames(pl3[[rearg[i]]]))]),0.01),quantile(unlist(pl3[[rearg[i]]][,grepl('log_a',colnames(pl3[[rearg[i]]]))]),0.99)),type='n')
lines(apply(pl3[[rearg[i]]][,grepl('log_a',colnames(pl3[[rearg[i]]]))],2,median)~seq(min(df$by),max(df$by)),lwd=1)
points(apply(pl3[[rearg[i]]][,grepl('log_a',colnames(pl3[[rearg[i]]]))],2,median)~seq(min(df$by),max(df$by)),pch=21,cex=1.5,bg=col.p)
lci=apply(pl3[[rearg[i]]][,grepl('log_a',colnames(pl3[[rearg[i]]]))],2,quantile,0.05)
uci=apply(pl3[[rearg[i]]][,grepl('log_a',colnames(pl3[[rearg[i]]]))],2,quantile,0.95)
x<- c(seq(min(df$by),max(df$by)), rev(seq(min(df$by),max(df$by))))
y<- c(lci, rev(uci))
polygon(x, y, col = adjustcolor('gray', alpha = 0.2), border=NA) # Add uncertainty polygon


#dynamic smax
#  par(mfrow=c(1,2))
by_q=round(quantile(df$by,seq(0,1,by=0.1)))
cols=rev(RColorBrewer::brewer.pal(11, 'RdYlBu'))
col.p=cols[cut(seq(min(df$by),max(df$by)), 11, labels = FALSE)]
plot(R~S,data=df,bty='l',pch=21,cex=1.5,bg='black',main='dynamic cap.',xlim=c(0,max(df$S)),ylim=c(0,max(df$R)),type='n')
lines(R~S,data=df)
for(t in 1:nrow(df)){
  p=exp(median(pl4[[rearg[i]]][,grepl('log_a',colnames(pl4[[rearg[i]]]))])-median(1/pl4[[rearg[i]]][,grepl('Smax',colnames(pl4[[rearg[i]]]))][,t])*x_new)*x_new
  lines(p~x_new,lwd=2,col=col.p[t])
}
points(R~S,data=df,pch=21,cex=1.5,bg=col.p)


plot(apply(pl4[[rearg[i]]][,grepl('Smax',colnames(pl4[[rearg[i]]]))],2,median)~seq(min(df$by),max(df$by)),data=df,bty='l',pch=21,cex=1.5,bg=col.p,ylab='Smax',xlab='year',ylim=c(0,quantile(unlist(pl4[[rearg[i]]][,grepl('Smax',colnames(pl4[[rearg[i]]]))]),0.95)))
lci=apply(pl4[[rearg[i]]][,grepl('Smax',colnames(pl4[[rearg[i]]]))],2,quantile,0.05)
uci=apply(pl4[[rearg[i]]][,grepl('Smax',colnames(pl4[[rearg[i]]]))],2,quantile,0.95)
x<- c(seq(min(df$by),max(df$by)), rev(seq(min(df$by),max(df$by))))
y<- c(lci, rev(uci))
polygon(x, y, col = adjustcolor('gray', alpha = 0.2), border=NA) # Add uncertainty polygon
lines(apply(pl4[[rearg[i]]][,grepl('Smax',colnames(pl4[[rearg[i]]]))],2,median)~seq(min(df$by),max(df$by)),lwd=1)


#prod regimes
#  par(mfrow=c(1,2))
plot(R~S,data=df,bty='l',pch=21,cex=1.5,type='n',main='regime prod.',xlim=c(0,max(df$S)),ylim=c(0,max(df$R)))
cols=RColorBrewer::brewer.pal(10, 'BrBG')
col.p=cols[cut(1-apply(pl5[[rearg[i]]][,grepl('gamma',colnames(pl5[[rearg[i]]]))][,1:nrow(df)],2,median), breaks = seq(0,1,by=0.1), labels = FALSE)]
lines(R~S,data=df)
p=exp(median(pl5[[rearg[i]]][,grepl('log_a',colnames(pl5[[rearg[i]]]))][,1])-median(pl5[[rearg[i]]][,grepl('b',colnames(pl5[[rearg[i]]]))])*x_new)*x_new
lines(p~x_new,lwd=2,col=cols[1])
p=exp(median(pl5[[rearg[i]]][,grepl('log_a',colnames(pl5[[rearg[i]]]))][,2])-median(pl5[[rearg[i]]][,grepl('b',colnames(pl5[[rearg[i]]]))])*x_new)*x_new
lines(p~x_new,lwd=2,col=cols[length(cols)])
points(R~S,data=df,pch=21,cex=1.5,bg=col.p)


plot(1-apply(pl5[[rearg[i]]][,grepl('gamma',colnames(pl5[[rearg[i]]]))][,1:nrow(df)],2,median)~df$by,data=df,bty='l',pch=21,cex=1.5,bg='black',ylab='p(high prod. regime)',xlab='year',ylim=c(0,1),type='n')
lci=1-apply(pl5[[rearg[i]]][,grepl('gamma',colnames(pl5[[rearg[i]]]))][,1:nrow(df)],2,quantile,0.05)
uci=1-apply(pl5[[rearg[i]]][,grepl('gamma',colnames(pl5[[rearg[i]]]))][,1:nrow(df)],2,quantile,0.95)
x<- c(df$by, rev(df$by))
y<- c(lci, rev(uci))
polygon(x, y, col = adjustcolor('gray', alpha = 0.2), border=NA) # Add uncertainty polygon
lines(1-apply(pl5[[rearg[i]]][,grepl('gamma',colnames(pl5[[rearg[i]]]))][,1:nrow(df)],2,median)~df$by,lwd=1)
points(1-apply(pl5[[rearg[i]]][,grepl('gamma',colnames(pl5[[rearg[i]]]))][,1:nrow(df)],2,median)~df$by,pch=21,cex=1.5,bg=col.p)

#smax regimes
# par(mfrow=c(1,2))
plot(R~S,data=df,bty='l',pch=21,cex=1.5,type='n',main='regime cap.',xlim=c(0,max(df$S)),ylim=c(0,max(df$R)))
cols=RColorBrewer::brewer.pal(10,'BrBG')
col.p=rev(cols)[cut(1-apply(pl6[[rearg[i]]][,grepl('gamma',colnames(pl6[[rearg[i]]]))][,1:nrow(df)],2,median), breaks = seq(0,1,by=0.1), labels = FALSE)]
lines(R~S,data=df)
p=exp(median(pl6[[rearg[i]]][,grepl('log_a',colnames(pl6[[rearg[i]]]))])-median(pl6[[rearg[i]]][,grepl('b',colnames(pl6[[rearg[i]]]))][,1])*x_new)*x_new
lines(p~x_new,lwd=2,col=cols[length(cols)])
p=exp(median(pl6[[rearg[i]]][,grepl('log_a',colnames(pl6[[rearg[i]]]))])-median(pl6[[rearg[i]]][,grepl('b',colnames(pl6[[rearg[i]]]))][,2])*x_new)*x_new
lines(p~x_new,lwd=2,col=cols[1])
points(R~S,data=df,pch=21,cex=1.5,bg=col.p)

plot(apply(pl6[[rearg[i]]][,grepl('gamma',colnames(pl6[[rearg[i]]]))][,1:nrow(df)],2,median)~df$by,data=df,bty='l',pch=21,cex=1.5,bg='black',ylab='p(high cap. regime)',xlab='year',ylim=c(0,1),type='n')
lci=apply(pl6[[rearg[i]]][,grepl('gamma',colnames(pl6[[rearg[i]]]))][,1:nrow(df)],2,quantile,0.05)
uci=apply(pl6[[rearg[i]]][,grepl('gamma',colnames(pl6[[rearg[i]]]))][,1:nrow(df)],2,quantile,0.95)
x<- c(df$by, rev(df$by))
y<- c(lci, rev(uci))
polygon(x, y, col = adjustcolor('gray', alpha = 0.2), border=NA) # Add uncertainty polygon
lines(apply(pl6[[rearg[i]]][,grepl('gamma',colnames(pl6[[rearg[i]]]))][,1:nrow(df)],2,median)~df$by,lwd=1)
points(apply(pl6[[rearg[i]]][,grepl('gamma',colnames(pl6[[rearg[i]]]))][,1:nrow(df)],2,median)~df$by,pch=21,cex=1.5,bg=col.p)

#prod & smax regimes
# par(mfrow=c(1,2))
plot(R~S,data=df,bty='l',pch=21,cex=1.5,type='n',main='regime prod. cap.',xlim=c(0,max(df$S)),ylim=c(0,max(df$R)))
cols=RColorBrewer::brewer.pal(11,'BrBG')
col.p=cols[cut(1-apply(pl7[[rearg[i]]][,grepl('gamma',colnames(pl7[[rearg[i]]]))][,1:nrow(df)],2,median), breaks = seq(0,1,by=0.1), labels = FALSE)]
lines(R~S,data=df)
p=exp(median(pl7[[rearg[i]]][,grepl('log_a',colnames(pl7[[rearg[i]]]))][,1])-median(pl7[[rearg[i]]][,grepl('b',colnames(pl7[[rearg[i]]]))][,1])*x_new)*x_new
lines(p~x_new,lwd=2,col=cols[1])
p=exp(median(pl7[[rearg[i]]][,grepl('log_a',colnames(pl7[[rearg[i]]]))][,2])-median(pl7[[rearg[i]]][,grepl('b',colnames(pl7[[rearg[i]]]))][,2])*x_new)*x_new
lines(p~x_new,lwd=2,col=cols[length(cols)])
points(R~S,data=df,pch=21,cex=1.5,bg=col.p)

plot(1-apply(pl7[[rearg[i]]][,grepl('gamma',colnames(pl7[[rearg[i]]]))][,1:nrow(df)],2,median)~df$by,data=df,bty='l',pch=21,cex=1.5,bg='black',ylab='p(high prod. regime)',xlab='year',ylim=c(0,1),type='n')
lci=1-apply(pl7[[rearg[i]]][,grepl('gamma',colnames(pl7[[rearg[i]]]))][,1:nrow(df)],2,quantile,0.05)
uci=1-apply(pl7[[rearg[i]]][,grepl('gamma',colnames(pl7[[rearg[i]]]))][,1:nrow(df)],2,quantile,0.95)
x<- c(df$by, rev(df$by))
y<- c(lci, rev(uci))
polygon(x, y, col = adjustcolor('gray', alpha = 0.2), border=NA) # Add uncertainty polygon
lines(1-apply(pl7[[rearg[i]]][,grepl('gamma',colnames(pl7[[rearg[i]]]))][,1:nrow(df)],2,median)~df$by,lwd=1)
points(1-apply(pl7[[rearg[i]]][,grepl('gamma',colnames(pl7[[rearg[i]]]))][,1:nrow(df)],2,median)~df$by,pch=21,cex=1.5,bg=col.p)

  }
   
}
```
